
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.11">
    
    
      
        <title>Solution - AquaCrop-OSPy</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50e68009.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#solution" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AquaCrop-OSPy" class="md-header__button md-logo" aria-label="AquaCrop-OSPy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AquaCrop-OSPy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Solution
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AquaCrop-OSPy" class="md-nav__button md-logo" aria-label="AquaCrop-OSPy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    AquaCrop-OSPy
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Notebooks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Notebooks" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Notebooks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/AquaCrop_OSPy_Notebook_1/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/AquaCrop_OSPy_Notebook_2/" class="md-nav__link">
        Estimating Irrigation Demand
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/AquaCrop_OSPy_Notebook_3/" class="md-nav__link">
        Optimizing Irrigation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/AquaCrop_OSPy_Notebook_4/" class="md-nav__link">
        Climate Change Impacts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../classes/" class="md-nav__link">
        Classes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../initialize/" class="md-nav__link">
        Initialize
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Solution
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Solution
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution" class="md-nav__link">
    aquacrop.solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIadj_pollination" class="md-nav__link">
    HIadj_pollination()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIadj_post_anthesis" class="md-nav__link">
    HIadj_post_anthesis()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIadj_pre_anthesis" class="md-nav__link">
    HIadj_pre_anthesis()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIref_current_day" class="md-nav__link">
    HIref_current_day()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.adjust_CCx" class="md-nav__link">
    adjust_CCx()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.aeration_stress" class="md-nav__link">
    aeration_stress()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.biomass_accumulation" class="md-nav__link">
    biomass_accumulation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.canopy_cover" class="md-nav__link">
    canopy_cover()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.capillary_rise" class="md-nav__link">
    capillary_rise()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.cc_development" class="md-nav__link">
    cc_development()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.cc_required_time" class="md-nav__link">
    cc_required_time()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.check_groundwater_table" class="md-nav__link">
    check_groundwater_table()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.drainage" class="md-nav__link">
    drainage()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.germination" class="md-nav__link">
    germination()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.groundwater_inflow" class="md-nav__link">
    groundwater_inflow()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.growing_degree_day" class="md-nav__link">
    growing_degree_day()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.growth_stage" class="md-nav__link">
    growth_stage()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.harvest_index" class="md-nav__link">
    harvest_index()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.infiltration" class="md-nav__link">
    infiltration()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.irrigation" class="md-nav__link">
    irrigation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.pre_irrigation" class="md-nav__link">
    pre_irrigation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.rainfall_partition" class="md-nav__link">
    rainfall_partition()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.root_development" class="md-nav__link">
    root_development()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.root_zone_water" class="md-nav__link">
    root_zone_water()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.soil_evaporation" class="md-nav__link">
    soil_evaporation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.temperature_stress" class="md-nav__link">
    temperature_stress()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.transpiration" class="md-nav__link">
    transpiration()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.update_CCx_CDC" class="md-nav__link">
    update_CCx_CDC()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.water_stress" class="md-nav__link">
    water_stress()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../timestep/" class="md-nav__link">
        Timestep
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../comparison/" class="md-nav__link">
        Comparison
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../lars/" class="md-nav__link">
        Lars
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution" class="md-nav__link">
    aquacrop.solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIadj_pollination" class="md-nav__link">
    HIadj_pollination()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIadj_post_anthesis" class="md-nav__link">
    HIadj_post_anthesis()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIadj_pre_anthesis" class="md-nav__link">
    HIadj_pre_anthesis()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.HIref_current_day" class="md-nav__link">
    HIref_current_day()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.adjust_CCx" class="md-nav__link">
    adjust_CCx()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.aeration_stress" class="md-nav__link">
    aeration_stress()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.biomass_accumulation" class="md-nav__link">
    biomass_accumulation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.canopy_cover" class="md-nav__link">
    canopy_cover()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.capillary_rise" class="md-nav__link">
    capillary_rise()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.cc_development" class="md-nav__link">
    cc_development()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.cc_required_time" class="md-nav__link">
    cc_required_time()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.check_groundwater_table" class="md-nav__link">
    check_groundwater_table()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.drainage" class="md-nav__link">
    drainage()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.germination" class="md-nav__link">
    germination()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.groundwater_inflow" class="md-nav__link">
    groundwater_inflow()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.growing_degree_day" class="md-nav__link">
    growing_degree_day()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.growth_stage" class="md-nav__link">
    growth_stage()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.harvest_index" class="md-nav__link">
    harvest_index()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.infiltration" class="md-nav__link">
    infiltration()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.irrigation" class="md-nav__link">
    irrigation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.pre_irrigation" class="md-nav__link">
    pre_irrigation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.rainfall_partition" class="md-nav__link">
    rainfall_partition()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.root_development" class="md-nav__link">
    root_development()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.root_zone_water" class="md-nav__link">
    root_zone_water()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.soil_evaporation" class="md-nav__link">
    soil_evaporation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.temperature_stress" class="md-nav__link">
    temperature_stress()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.transpiration" class="md-nav__link">
    transpiration()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.update_CCx_CDC" class="md-nav__link">
    update_CCx_CDC()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aquacrop.solution.water_stress" class="md-nav__link">
    water_stress()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="solution">solution</h1>


  <div class="doc doc-object doc-module">

<a id="aquacrop.solution"></a>
    <div class="doc doc-contents first">




  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.HIadj_pollination" class="doc doc-heading">
<code class="highlight language-python"><span class="n">HIadj_pollination</span><span class="p">(</span><span class="n">NewCond_CC</span><span class="p">,</span> <span class="n">NewCond_Fpol</span><span class="p">,</span> <span class="n">Crop_FloweringCD</span><span class="p">,</span> <span class="n">Crop_CCmin</span><span class="p">,</span> <span class="n">Crop_exc</span><span class="p">,</span> <span class="n">Ksw</span><span class="p">,</span> <span class="n">Kst</span><span class="p">,</span> <span class="n">HIt</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate adjustment to harvest index for failure of
pollination due to water or temperature stress</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=119" target="_blank">Reference Manual: harvest index calculations</a> (pg. 110-126)</p>
<p><em>Arguments:</em></p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><code>Ksw</code>: <code>KswClass</code> : Ksw object containing water stress paramaters</p>
<p><code>Kst</code>: <code>KstClass</code> : Kst object containing tempature stress paramaters</p>
<p><code>HIt</code>: <code>float</code> : time for harvest index build-up (calander days)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_HIadj_pollination&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">KswNT_type_sig</span><span class="p">,</span><span class="n">KstNT_type_sig</span><span class="p">,</span><span class="n">f8</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">HIadj_pollination</span><span class="p">(</span>
    <span class="n">NewCond_CC</span><span class="p">,</span>
    <span class="n">NewCond_Fpol</span><span class="p">,</span>
    <span class="n">Crop_FloweringCD</span><span class="p">,</span> 
    <span class="n">Crop_CCmin</span><span class="p">,</span> 
    <span class="n">Crop_exc</span><span class="p">,</span> 
    <span class="n">Ksw</span><span class="p">,</span> 
    <span class="n">Kst</span><span class="p">,</span> 
    <span class="n">HIt</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate adjustment to harvest index for failure of</span>
<span class="sd">    pollination due to water or temperature stress</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=119&quot; target=&quot;_blank&quot;&gt;Reference Manual: harvest index calculations&lt;/a&gt; (pg. 110-126)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>

<span class="sd">    `Ksw`: `KswClass` : Ksw object containing water stress paramaters</span>

<span class="sd">    `Kst`: `KstClass` : Kst object containing tempature stress paramaters</span>

<span class="sd">    `HIt`: `float` : time for harvest index build-up (calander days)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Caclulate harvest index adjustment for pollination ##</span>
    <span class="c1"># Get fractional flowering</span>
    <span class="k">if</span> <span class="n">HIt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># No flowering yet</span>
        <span class="n">FracFlow</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">HIt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Fractional flowering on previous day</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">HIt</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">F1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1Pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">t1</span> <span class="o">/</span> <span class="n">Crop_FloweringCD</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t1Pct</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">t1Pct</span> <span class="o">=</span> <span class="mi">100</span>

            <span class="n">F1</span> <span class="o">=</span> <span class="mf">0.00558</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.63</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t1Pct</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.000969</span> <span class="o">*</span> <span class="n">t1Pct</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.00383</span>

        <span class="k">if</span> <span class="n">F1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">F1</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Fractional flowering on current day</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">HIt</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">F2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t2Pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">t2</span> <span class="o">/</span> <span class="n">Crop_FloweringCD</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t2Pct</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">t2Pct</span> <span class="o">=</span> <span class="mi">100</span>

            <span class="n">F2</span> <span class="o">=</span> <span class="mf">0.00558</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.63</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t2Pct</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.000969</span> <span class="o">*</span> <span class="n">t2Pct</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.00383</span>

        <span class="k">if</span> <span class="n">F2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">F2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Weight values</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F1</span> <span class="o">-</span> <span class="n">F2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0000001</span><span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">F1</span> <span class="o">+</span> <span class="n">F2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">Crop_FloweringCD</span>

        <span class="n">FracFlow</span> <span class="o">=</span> <span class="n">F</span>

    <span class="c1"># Calculate pollination adjustment for current day</span>
    <span class="k">if</span> <span class="n">NewCond_CC</span> <span class="o">&lt;</span> <span class="n">Crop_CCmin</span><span class="p">:</span>
        <span class="c1"># No pollination can occur as canopy cover is smaller than minimum</span>
        <span class="c1"># threshold</span>
        <span class="n">dFpol</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ks</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">Ksw</span><span class="o">.</span><span class="n">Pol</span><span class="p">,</span> <span class="n">Kst</span><span class="o">.</span><span class="n">PolC</span><span class="p">,</span> <span class="n">Kst</span><span class="o">.</span><span class="n">PolH</span><span class="p">])</span>
        <span class="n">dFpol</span> <span class="o">=</span> <span class="n">Ks</span> <span class="o">*</span> <span class="n">FracFlow</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop_exc</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>

    <span class="c1"># Calculate pollination adjustment to date</span>
    <span class="n">NewCond_Fpol</span> <span class="o">=</span> <span class="n">NewCond_Fpol</span> <span class="o">+</span> <span class="n">dFpol</span>
    <span class="k">if</span> <span class="n">NewCond_Fpol</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Crop has fully pollinated</span>
        <span class="n">NewCond_Fpol</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">NewCond_Fpol</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.HIadj_post_anthesis" class="doc doc-heading">
<code class="highlight language-python"><span class="n">HIadj_post_anthesis</span><span class="p">(</span><span class="n">NewCond_DelayedCDs</span><span class="p">,</span> <span class="n">NewCond_sCor1</span><span class="p">,</span> <span class="n">NewCond_sCor2</span><span class="p">,</span> <span class="n">NewCond_DAP</span><span class="p">,</span> <span class="n">NewCond_Fpre</span><span class="p">,</span> <span class="n">NewCond_CC</span><span class="p">,</span> <span class="n">NewCond_fpost_upp</span><span class="p">,</span> <span class="n">NewCond_fpost_dwn</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">Ksw</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate adjustment to harvest index for post-anthesis water
stress</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=119" target="_blank">Reference Manual: harvest index calculations</a> (pg. 110-126)</p>
<p><em>Arguments:</em></p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><code>Ksw</code>: <code>KswClass</code> : Ksw object containing water stress paramaters</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_HIadj_post_anthesis&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">CropStructNT_type_sig</span><span class="p">,</span><span class="n">KswNT_type_sig</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">HIadj_post_anthesis</span><span class="p">(</span>
                    <span class="n">NewCond_DelayedCDs</span><span class="p">,</span>
                    <span class="n">NewCond_sCor1</span><span class="p">,</span>
                    <span class="n">NewCond_sCor2</span><span class="p">,</span>
                    <span class="n">NewCond_DAP</span><span class="p">,</span>
                    <span class="n">NewCond_Fpre</span><span class="p">,</span>
                    <span class="n">NewCond_CC</span><span class="p">,</span>
                    <span class="n">NewCond_fpost_upp</span><span class="p">,</span>
                    <span class="n">NewCond_fpost_dwn</span><span class="p">,</span>
                    <span class="n">Crop</span><span class="p">,</span> 
                    <span class="n">Ksw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate adjustment to harvest index for post-anthesis water</span>
<span class="sd">    stress</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=119&quot; target=&quot;_blank&quot;&gt;Reference Manual: harvest index calculations&lt;/a&gt; (pg. 110-126)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>

<span class="sd">    `Ksw`: `KswClass` : Ksw object containing water stress paramaters</span>

<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions in a structure for updating ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="n">InitCond_DelayedCDs</span> <span class="o">=</span> <span class="n">NewCond_DelayedCDs</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">InitCond_sCor1</span> <span class="o">=</span> <span class="n">NewCond_sCor1</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">InitCond_sCor2</span> <span class="o">=</span> <span class="n">NewCond_sCor2</span><span class="o">*</span><span class="mi">1</span>

    <span class="c1">## Calculate harvest index adjustment ##</span>
    <span class="c1"># 1. Adjustment for leaf expansion</span>
    <span class="n">tmax1</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEndCD</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIstartCD</span>
    <span class="n">DAP</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="n">InitCond_DelayedCDs</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">DAP</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEndCD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">tmax1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_Fpre</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_CC</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">a_HI</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">dCor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Exp</span><span class="p">)</span> <span class="o">/</span> <span class="n">Crop</span><span class="o">.</span><span class="n">a_HI</span>
        <span class="n">NewCond_sCor1</span> <span class="o">=</span> <span class="n">InitCond_sCor1</span> <span class="o">+</span> <span class="p">(</span><span class="n">dCor</span> <span class="o">/</span> <span class="n">tmax1</span><span class="p">)</span>
        <span class="n">DayCor</span> <span class="o">=</span> <span class="n">DAP</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIstartCD</span>
        <span class="n">NewCond_fpost_upp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmax1</span> <span class="o">/</span> <span class="n">DayCor</span><span class="p">)</span> <span class="o">*</span> <span class="n">NewCond_sCor1</span>

    <span class="c1"># 2. Adjustment for stomatal closure</span>
    <span class="n">tmax2</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">YldFormCD</span>
    <span class="n">DAP</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="n">InitCond_DelayedCDs</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">DAP</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIendCD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">tmax2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_Fpre</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_CC</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">b_HI</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="c1"># print(Ksw.Sto)</span>
        <span class="n">dCor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Ksw</span><span class="o">.</span><span class="n">Sto</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sto</span><span class="p">)</span> <span class="o">/</span> <span class="n">Crop</span><span class="o">.</span><span class="n">b_HI</span><span class="p">)</span>
        <span class="n">NewCond_sCor2</span> <span class="o">=</span> <span class="n">InitCond_sCor2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dCor</span> <span class="o">/</span> <span class="n">tmax2</span><span class="p">)</span>
        <span class="n">DayCor</span> <span class="o">=</span> <span class="n">DAP</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIstartCD</span>
        <span class="n">NewCond_fpost_dwn</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmax2</span> <span class="o">/</span> <span class="n">DayCor</span><span class="p">)</span> <span class="o">*</span> <span class="n">NewCond_sCor2</span>

    <span class="c1"># Determine total multiplier</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tmax1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmax2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">NewCond_Fpost</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tmax2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">NewCond_Fpost</span> <span class="o">=</span> <span class="n">NewCond_fpost_upp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmax1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">NewCond_Fpost</span> <span class="o">=</span> <span class="n">NewCond_fpost_dwn</span>
            <span class="k">elif</span> <span class="n">tmax1</span> <span class="o">&lt;=</span> <span class="n">tmax2</span><span class="p">:</span>
                <span class="n">NewCond_Fpost</span> <span class="o">=</span> <span class="n">NewCond_fpost_dwn</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="p">((</span><span class="n">tmax1</span> <span class="o">*</span> <span class="n">NewCond_fpost_upp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmax2</span> <span class="o">-</span> <span class="n">tmax1</span><span class="p">))</span> <span class="o">/</span> <span class="n">tmax2</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">NewCond_Fpost</span> <span class="o">=</span> <span class="n">NewCond_fpost_upp</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="p">((</span><span class="n">tmax2</span> <span class="o">*</span> <span class="n">NewCond_fpost_dwn</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmax1</span> <span class="o">-</span> <span class="n">tmax2</span><span class="p">))</span> <span class="o">/</span> <span class="n">tmax1</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
            <span class="n">NewCond_sCor1</span><span class="p">,</span>
            <span class="n">NewCond_sCor2</span><span class="p">,</span>
            <span class="n">NewCond_fpost_upp</span><span class="p">,</span>
            <span class="n">NewCond_fpost_dwn</span><span class="p">,</span>
            <span class="n">NewCond_Fpost</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.HIadj_pre_anthesis" class="doc doc-heading">
<code class="highlight language-python"><span class="n">HIadj_pre_anthesis</span><span class="p">(</span><span class="n">NewCond_B</span><span class="p">,</span> <span class="n">NewCond_B_NS</span><span class="p">,</span> <span class="n">NewCond_CC</span><span class="p">,</span> <span class="n">Crop_dHI_pre</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate adjustment to harvest index for pre-anthesis water
stress</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=119" target="_blank">Reference Manual: harvest index calculations</a> (pg. 110-126)</p>
<p><em>Arguments:</em></p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_HIadj_pre_anthesis&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">HIadj_pre_anthesis</span><span class="p">(</span>
    <span class="n">NewCond_B</span><span class="p">,</span>
    <span class="n">NewCond_B_NS</span><span class="p">,</span>
    <span class="n">NewCond_CC</span><span class="p">,</span>
    <span class="n">Crop_dHI_pre</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate adjustment to harvest index for pre-anthesis water</span>
<span class="sd">    stress</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=119&quot; target=&quot;_blank&quot;&gt;Reference Manual: harvest index calculations&lt;/a&gt; (pg. 110-126)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions in structure for updating ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="c1"># check that there is an adjustment to be made</span>
    <span class="k">if</span> <span class="n">Crop_dHI_pre</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">## Calculate adjustment ##</span>
        <span class="c1"># Get parameters</span>
        <span class="n">Br</span> <span class="o">=</span> <span class="n">NewCond_B</span> <span class="o">/</span> <span class="n">NewCond_B_NS</span>
        <span class="n">Br_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Crop_dHI_pre</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.62</span>
        <span class="n">Br_upp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Br_low</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Br_range</span>
        <span class="n">Br_top</span> <span class="o">=</span> <span class="n">Br_upp</span> <span class="o">-</span> <span class="p">(</span><span class="n">Br_range</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Get biomass ratios</span>
        <span class="n">ratio_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">Br</span> <span class="o">-</span> <span class="n">Br_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Br_top</span> <span class="o">-</span> <span class="n">Br_low</span><span class="p">)</span>
        <span class="n">ratio_upp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Br</span> <span class="o">-</span> <span class="n">Br_top</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Br_upp</span> <span class="o">-</span> <span class="n">Br_top</span><span class="p">)</span>

        <span class="c1"># Calculate adjustment factor</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Br</span> <span class="o">&gt;=</span> <span class="n">Br_low</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Br</span> <span class="o">&lt;</span> <span class="n">Br_top</span><span class="p">):</span>
            <span class="n">NewCond_Fpre</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mf">1.5</span> <span class="o">-</span> <span class="n">ratio_low</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Crop_dHI_pre</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">Br</span> <span class="o">&gt;</span> <span class="n">Br_top</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Br</span> <span class="o">&lt;=</span> <span class="n">Br_upp</span><span class="p">):</span>
            <span class="n">NewCond_Fpre</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">ratio_upp</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Crop_dHI_pre</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NewCond_Fpre</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">NewCond_Fpre</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">NewCond_CC</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="c1"># No green canopy cover left at start of flowering so no harvestable</span>
        <span class="c1"># crop will develop</span>
        <span class="n">NewCond_Fpre</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">NewCond_Fpre</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.HIref_current_day" class="doc doc-heading">
<code class="highlight language-python"><span class="n">HIref_current_day</span><span class="p">(</span><span class="n">NewCond_HIref</span><span class="p">,</span> <span class="n">NewCond_DAP</span><span class="p">,</span> <span class="n">NewCond_DelayedCDs</span><span class="p">,</span> <span class="n">NewCond_YieldForm</span><span class="p">,</span> <span class="n">NewCond_PctLagPhase</span><span class="p">,</span> <span class="n">NewCond_CCprev</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate reference (no adjustment for stress effects)
harvest index on current day</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=119" target="_blank">Reference Manual: harvest index calculations</a> (pg. 110-126)</p>
<p><em>Arguments:</em></p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><code>GrowingSeason</code>: <code>bool</code> : is growing season (True or Flase)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_HIref_current_day&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">f8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">CropStructNT_type_sig</span><span class="p">,</span><span class="n">b1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">HIref_current_day</span><span class="p">(</span>
    <span class="n">NewCond_HIref</span><span class="p">,</span>
    <span class="n">NewCond_DAP</span><span class="p">,</span>
    <span class="n">NewCond_DelayedCDs</span><span class="p">,</span>
    <span class="n">NewCond_YieldForm</span><span class="p">,</span>
    <span class="n">NewCond_PctLagPhase</span><span class="p">,</span>
    <span class="n">NewCond_CCprev</span><span class="p">,</span>
    <span class="n">Crop</span><span class="p">,</span>
    <span class="n">GrowingSeason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate reference (no adjustment for stress effects)</span>
<span class="sd">    harvest index on current day</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=119&quot; target=&quot;_blank&quot;&gt;Reference Manual: harvest index calculations&lt;/a&gt; (pg. 110-126)</span>



<span class="sd">    *Arguments:*</span>



<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>

<span class="sd">    `GrowingSeason`: `bool` : is growing season (True or Flase)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>




<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions for updating ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="n">InitCond_HIref</span> <span class="o">=</span> <span class="n">NewCond_HIref</span><span class="o">*</span><span class="mi">1</span>

    <span class="c1"># NewCond.HIref = 0.</span>

    <span class="c1">## Calculate reference harvest index (if in growing season) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Check if in yield formation period</span>
        <span class="n">tAdj</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="n">NewCond_DelayedCDs</span>
        <span class="k">if</span> <span class="n">tAdj</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIstartCD</span><span class="p">:</span>

            <span class="n">NewCond_YieldForm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NewCond_YieldForm</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get time for harvest index calculation</span>
        <span class="n">HIt</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="n">NewCond_DelayedCDs</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIstartCD</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">HIt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Yet to reach time for HI build-up</span>
            <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NewCond_PctLagPhase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">NewCond_CCprev</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CCmin</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">):</span>
                <span class="c1"># HI cannot develop further as canopy cover is too small</span>
                <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="n">InitCond_HIref</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check crop type</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="c1"># If crop type is leafy vegetable or root/tuber, then proceed with</span>
                    <span class="c1"># logistic growth (i.e. no linear switch)</span>
                    <span class="n">NewCond_PctLagPhase</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># No lag phase</span>
                    <span class="c1"># Calculate reference harvest index for current day</span>
                    <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIGC</span> <span class="o">*</span> <span class="n">HIt</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># Harvest index apprAOSP_hing maximum limit</span>
                    <span class="k">if</span> <span class="n">NewCond_HIref</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mf">0.9799</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span><span class="p">):</span>
                        <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span>

                <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># If crop type is fruit/grain producing, check for linear switch</span>
                    <span class="k">if</span> <span class="n">HIt</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">tLinSwitch</span><span class="p">:</span>
                        <span class="c1"># Not yet reached linear switch point, therefore proceed with</span>
                        <span class="c1"># logistic build-up</span>
                        <span class="n">NewCond_PctLagPhase</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">HIt</span> <span class="o">/</span> <span class="n">Crop</span><span class="o">.</span><span class="n">tLinSwitch</span><span class="p">)</span>
                        <span class="c1"># Calculate reference harvest index for current day</span>
                        <span class="c1"># (logistic build-up)</span>
                        <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIGC</span> <span class="o">*</span> <span class="n">HIt</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Linear switch point has been reached</span>
                        <span class="n">NewCond_PctLagPhase</span> <span class="o">=</span> <span class="mi">100</span>
                        <span class="c1"># Calculate reference harvest index for current day</span>
                        <span class="c1"># (logistic portion)</span>
                        <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIGC</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">tLinSwitch</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="c1"># Calculate reference harvest index for current day</span>
                        <span class="c1"># (total - logistic portion + linear portion)</span>
                        <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="n">NewCond_HIref</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">dHILinear</span> <span class="o">*</span> <span class="p">(</span><span class="n">HIt</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">tLinSwitch</span><span class="p">))</span>

                <span class="c1"># Limit HIref and round off computed value</span>
                <span class="k">if</span> <span class="n">NewCond_HIref</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span><span class="p">:</span>
                    <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span>
                <span class="k">elif</span> <span class="n">NewCond_HIref</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HIini</span> <span class="o">+</span> <span class="mf">0.004</span><span class="p">):</span>
                    <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span> <span class="o">-</span> <span class="n">NewCond_HIref</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.004</span><span class="p">:</span>
                    <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Reference harvest index is zero outside of growing season</span>
        <span class="n">NewCond_HIref</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">NewCond_HIref</span><span class="p">,</span>
            <span class="n">NewCond_YieldForm</span><span class="p">,</span>
            <span class="n">NewCond_PctLagPhase</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.adjust_CCx" class="doc doc-heading">
<code class="highlight language-python"><span class="n">adjust_CCx</span><span class="p">(</span><span class="n">CCprev</span><span class="p">,</span> <span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tSum</span><span class="p">,</span> <span class="n">Crop_CanopyDevEnd</span><span class="p">,</span> <span class="n">Crop_CCx</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to adjust CCx value for changes in CGC due to water stress during the growing season</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=36" target="_blank">Reference Manual: CC stress response</a> (pg. 27-33)</p>
<p><em>Arguments:</em></p>
<p><code>CCprev</code>: <code>float</code> : Canopy Cover at previous timestep.</p>
<p><code>CCo</code>: <code>float</code> : Fractional canopy cover size at emergence</p>
<p><code>CCx</code>: <code>float</code> : Maximum canopy cover (fraction of soil cover)</p>
<p><code>CGC</code>: <code>float</code> : Canopy growth coefficient (fraction per GDD)</p>
<p><code>CDC</code>: <code>float</code> : Canopy decline coefficient (fraction per GDD/calendar day)</p>
<p><code>dt</code>: <code>float</code> : Time delta of canopy growth (1 calander day or ... GDD)</p>
<p><code>tSum</code>: <code>float</code> : time since germination (CD or GDD)</p>
<p><code>Crop_CanopyDevEnd</code>: <code>float</code> : time that Canopy developement ends</p>
<p><code>Crop_CCx</code>: <code>float</code> : Maximum canopy cover (fraction of soil cover)</p>
<p><em>Returns:</em></p>
<p><code>CCxAdj</code>: <code>float</code> : Adjusted CCx</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">adjust_CCx</span><span class="p">(</span><span class="n">CCprev</span><span class="p">,</span> <span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tSum</span><span class="p">,</span> <span class="n">Crop_CanopyDevEnd</span><span class="p">,</span> <span class="n">Crop_CCx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to adjust CCx value for changes in CGC due to water stress during the growing season</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=36&quot; target=&quot;_blank&quot;&gt;Reference Manual: CC stress response&lt;/a&gt; (pg. 27-33)</span>


<span class="sd">    *Arguments:*</span>


<span class="sd">    `CCprev`: `float` : Canopy Cover at previous timestep.</span>

<span class="sd">    `CCo`: `float` : Fractional canopy cover size at emergence</span>

<span class="sd">    `CCx`: `float` : Maximum canopy cover (fraction of soil cover)</span>

<span class="sd">    `CGC`: `float` : Canopy growth coefficient (fraction per GDD)</span>

<span class="sd">    `CDC`: `float` : Canopy decline coefficient (fraction per GDD/calendar day)</span>

<span class="sd">    `dt`: `float` : Time delta of canopy growth (1 calander day or ... GDD)</span>

<span class="sd">    `tSum`: `float` : time since germination (CD or GDD)</span>

<span class="sd">    `Crop_CanopyDevEnd`: `float` : time that Canopy developement ends</span>

<span class="sd">    `Crop_CCx`: `float` : Maximum canopy cover (fraction of soil cover)</span>

<span class="sd">    *Returns:*</span>

<span class="sd">    `CCxAdj`: `float` : Adjusted CCx</span>





<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Get time required to reach CC on previous day ##</span>
    <span class="n">tCCtmp</span> <span class="o">=</span> <span class="n">_cc_required_time</span><span class="p">(</span><span class="n">CCprev</span><span class="p">,</span> <span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="s2">&quot;CGC&quot;</span><span class="p">)</span>

    <span class="c1">## Determine CCx adjusted ##</span>
    <span class="k">if</span> <span class="n">tCCtmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tCCtmp</span> <span class="o">=</span> <span class="n">tCCtmp</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop_CanopyDevEnd</span> <span class="o">-</span> <span class="n">tSum</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span>
        <span class="n">CCxAdj</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span><span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">tCCtmp</span><span class="p">,</span> <span class="s2">&quot;Growth&quot;</span><span class="p">,</span> <span class="n">Crop_CCx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">CCxAdj</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">CCxAdj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.aeration_stress" class="doc doc-heading">
<code class="highlight language-python"><span class="n">aeration_stress</span><span class="p">(</span><span class="n">NewCond_AerDays</span><span class="p">,</span> <span class="n">Crop_LagAer</span><span class="p">,</span> <span class="n">thRZ</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate aeration stress coefficient</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=90" target="_blank">Reference Manual: aeration stress</a> (pg. 89-90)</p>
<p><em>Arguments:</em></p>
<p><code>NewCond_AerDays</code>: <code>int</code> : number aeration stress days</p>
<p><code>Crop_LagAer</code>: <code>int</code> : lag days before aeration stress</p>
<p><code>thRZ</code>: <code>thRZClass</code> : object that contains information on the total water in the root zone</p>
<p><em>Returns:</em></p>
<p><code>Ksa_Aer</code>: <code>float</code> : aeration stress coefficient</p>
<p><code>NewCond_AerDays</code>: <code>float</code> : updated aer days</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_aeration_stress&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">thRZNT_type_sig</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">aeration_stress</span><span class="p">(</span><span class="n">NewCond_AerDays</span><span class="p">,</span> <span class="n">Crop_LagAer</span><span class="p">,</span> <span class="n">thRZ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate aeration stress coefficient</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=90&quot; target=&quot;_blank&quot;&gt;Reference Manual: aeration stress&lt;/a&gt; (pg. 89-90)</span>


<span class="sd">    *Arguments:*</span>


<span class="sd">    `NewCond_AerDays`: `int` : number aeration stress days</span>

<span class="sd">    `Crop_LagAer`: `int` : lag days before aeration stress</span>

<span class="sd">    `thRZ`: `thRZClass` : object that contains information on the total water in the root zone</span>



<span class="sd">    *Returns:*</span>

<span class="sd">    `Ksa_Aer`: `float` : aeration stress coefficient</span>

<span class="sd">    `NewCond_AerDays`: `float` : updated aer days</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Determine aeration stress (root zone) ##</span>
    <span class="k">if</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">Act</span> <span class="o">&gt;</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">Aer</span><span class="p">:</span>
        <span class="c1"># Calculate aeration stress coefficient</span>
        <span class="k">if</span> <span class="n">NewCond_AerDays</span> <span class="o">&lt;</span> <span class="n">Crop_LagAer</span><span class="p">:</span>
            <span class="n">stress</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">thRZ</span><span class="o">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">Act</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">thRZ</span><span class="o">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">Aer</span><span class="p">))</span>
            <span class="n">Ksa_Aer</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">NewCond_AerDays</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">stress</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">NewCond_AerDays</span> <span class="o">&gt;=</span> <span class="n">Crop_LagAer</span><span class="p">:</span>
            <span class="n">Ksa_Aer</span> <span class="o">=</span> <span class="p">(</span><span class="n">thRZ</span><span class="o">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">Act</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">thRZ</span><span class="o">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">Aer</span><span class="p">)</span>

        <span class="c1"># Increment aeration days counter</span>
        <span class="n">NewCond_AerDays</span> <span class="o">=</span> <span class="n">NewCond_AerDays</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">NewCond_AerDays</span> <span class="o">&gt;</span> <span class="n">Crop_LagAer</span><span class="p">:</span>
            <span class="n">NewCond_AerDays</span> <span class="o">=</span> <span class="n">Crop_LagAer</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set aeration stress coefficient to one (no stress value)</span>
        <span class="n">Ksa_Aer</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Reset aeration days counter</span>
        <span class="n">NewCond_AerDays</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">Ksa_Aer</span><span class="p">,</span> <span class="n">NewCond_AerDays</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.biomass_accumulation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">biomass_accumulation</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">NewCond_DAP</span><span class="p">,</span> <span class="n">NewCond_DelayedCDs</span><span class="p">,</span> <span class="n">NewCond_HIref</span><span class="p">,</span> <span class="n">NewCond_PctLagPhase</span><span class="p">,</span> <span class="n">NewCond_B</span><span class="p">,</span> <span class="n">NewCond_B_NS</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">TrPot</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate biomass accumulation</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=107" target="_blank">Reference Manual: biomass accumulaiton</a> (pg. 98-108)</p>
<p><em>Arguments:</em></p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Tr</code>: <code>float</code> : Daily transpiration</p>
<p><code>TrPot</code>: <code>float</code> : Daily potential transpiration</p>
<p><code>Et0</code>: <code>float</code> : Daily reference evapotranspiration</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is Growing season? (True, False)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_biomass_accumulation&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">CropStructNT_type_sig</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">biomass_accumulation</span><span class="p">(</span>
                        <span class="n">Crop</span><span class="p">,</span>
                        <span class="n">NewCond_DAP</span><span class="p">,</span>
                        <span class="n">NewCond_DelayedCDs</span><span class="p">,</span>
                        <span class="n">NewCond_HIref</span><span class="p">,</span>
                        <span class="n">NewCond_PctLagPhase</span><span class="p">,</span>
                        <span class="n">NewCond_B</span><span class="p">,</span>
                        <span class="n">NewCond_B_NS</span><span class="p">,</span>
                        <span class="n">Tr</span><span class="p">,</span> 
                        <span class="n">TrPot</span><span class="p">,</span> 
                        <span class="n">Et0</span><span class="p">,</span> 
                        <span class="n">GrowingSeason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate biomass accumulation</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=107&quot; target=&quot;_blank&quot;&gt;Reference Manual: biomass accumulaiton&lt;/a&gt; (pg. 98-108)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `Crop`: `CropClass` : Crop object</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Tr`: `float` : Daily transpiration</span>

<span class="sd">    `TrPot`: `float` : Daily potential transpiration</span>

<span class="sd">    `Et0`: `float` : Daily reference evapotranspiration</span>

<span class="sd">    `GrowingSeason`:: `bool` : is Growing season? (True, False)</span>

<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>




<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions in a new structure for updating ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="c1">## Calculate biomass accumulation (if in growing season) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Get time for harvest index build-up</span>
        <span class="n">HIt</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="n">NewCond_DelayedCDs</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIstartCD</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_HIref</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Adjust WP for reproductive stage</span>
            <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Determinant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fswitch</span> <span class="o">=</span> <span class="n">NewCond_PctLagPhase</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">HIt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">YldFormCD</span> <span class="o">/</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">fswitch</span> <span class="o">=</span> <span class="n">HIt</span> <span class="o">/</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">YldFormCD</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fswitch</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">WPadj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">WP</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">WPy</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">fswitch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WPadj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">WP</span>

        <span class="c1"># print(WPadj)</span>

        <span class="c1"># Adjust WP for CO2 effects</span>
        <span class="n">WPadj</span> <span class="o">=</span> <span class="n">WPadj</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">fCO2</span>

        <span class="c1"># print(WPadj)</span>

        <span class="c1"># Calculate biomass accumulation on current day</span>
        <span class="c1"># No water stress</span>
        <span class="n">dB_NS</span> <span class="o">=</span> <span class="n">WPadj</span> <span class="o">*</span> <span class="p">(</span><span class="n">TrPot</span> <span class="o">/</span> <span class="n">Et0</span><span class="p">)</span>
        <span class="c1"># With water stress</span>
        <span class="n">dB</span> <span class="o">=</span> <span class="n">WPadj</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tr</span> <span class="o">/</span> <span class="n">Et0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dB</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">dB</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Update biomass accumulation</span>
        <span class="n">NewCond_B</span> <span class="o">=</span> <span class="n">NewCond_B</span> <span class="o">+</span> <span class="n">dB</span>
        <span class="n">NewCond_B_NS</span> <span class="o">=</span> <span class="n">NewCond_B_NS</span> <span class="o">+</span> <span class="n">dB_NS</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No biomass accumulation outside of growing season</span>
        <span class="n">NewCond_B</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond_B_NS</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">NewCond_B</span><span class="p">,</span>
            <span class="n">NewCond_B_NS</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.canopy_cover" class="doc doc-heading">
<code class="highlight language-python"><span class="n">canopy_cover</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">GDD</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to simulate canopy growth/decline</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=30" target="_blank">Reference Manual: CC equations</a> (pg. 21-33)</p>
<p><em>Arguments:</em></p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object</p>
<p><code>prof</code>: <code>SoilProfileClass</code> : Soil object</p>
<p><code>Soil_zTop</code>: <code>float</code> : top soil depth</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object</p>
<p><code>GDD</code>: <code>float</code> : Growing Degree Days</p>
<p><code>Et0</code>: <code>float</code> : reference evapotranspiration</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is it currently within the growing season (True, Flase)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : updated InitCond object</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">canopy_cover</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">GDD</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">):</span>
    <span class="c1"># def canopy_cover(Crop,Soil_Profile,Soil_zTop,InitCond,GDD,Et0,GrowingSeason):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to simulate canopy growth/decline</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=30&quot; target=&quot;_blank&quot;&gt;Reference Manual: CC equations&lt;/a&gt; (pg. 21-33)</span>


<span class="sd">    *Arguments:*</span>


<span class="sd">    `Crop`: `CropClass` : Crop object</span>

<span class="sd">    `prof`: `SoilProfileClass` : Soil object</span>

<span class="sd">    `Soil_zTop`: `float` : top soil depth</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object</span>

<span class="sd">    `GDD`: `float` : Growing Degree Days</span>

<span class="sd">    `Et0`: `float` : reference evapotranspiration</span>

<span class="sd">    `GrowingSeason`:: `bool` : is it currently within the growing season (True, Flase)</span>

<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : updated InitCond object</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Function to simulate canopy growth/decline</span>

    <span class="n">InitCond_CC_NS</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">CC_NS</span>
    <span class="n">InitCond_CC</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">CC</span>
    <span class="n">InitCond_ProtectedSeed</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">ProtectedSeed</span>
    <span class="n">InitCond_CCxAct</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">CCxAct</span>
    <span class="n">InitCond_CropDead</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">CropDead</span>
    <span class="n">InitCond_tEarlySen</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">tEarlySen</span>
    <span class="n">InitCond_CCxW</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">CCxW</span>

    <span class="c1">## Store initial conditions in a new structure for updating ##</span>
    <span class="n">NewCond</span> <span class="o">=</span> <span class="n">InitCond</span>
    <span class="n">NewCond</span><span class="o">.</span><span class="n">CCprev</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">CC</span>

    <span class="c1">## Calculate canopy development (if in growing season) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Calculate root zone water content</span>
        <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAWClass</span><span class="p">()</span>
        <span class="n">Dr</span> <span class="o">=</span> <span class="n">DrClass</span><span class="p">()</span>
        <span class="c1"># thRZ = thRZClass()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">_root_zone_water</span><span class="p">(</span>
            <span class="n">prof</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">Zroot</span><span class="p">),</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">,</span>
            <span class="n">Soil_zTop</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">),</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">Aer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># _,Dr,TAW,_ = root_zone_water(Soil_Profile,float(NewCond.Zroot),NewCond.th,Soil_zTop,float(Crop.Zmin),Crop.Aer)</span>
        <span class="c1"># Check whether to use root zone or top soil depletions for calculating</span>
        <span class="c1"># water stress</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span> <span class="o">/</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span> <span class="o">/</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span><span class="p">):</span>
            <span class="c1"># Root zone is wetter than top soil, so use root zone value</span>
            <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span>
            <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Top soil is wetter than root zone, so use top soil values</span>
            <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span>
            <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span>

        <span class="c1"># Determine if water stress is occurring</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">Ksw</span> <span class="o">=</span> <span class="n">KswClass</span><span class="p">()</span>
        <span class="n">Ksw</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sto</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sen</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Pol</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">StoLin</span> <span class="o">=</span> <span class="n">_water_stress</span><span class="p">(</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">p_lo</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">ETadj</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">,</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">tEarlySen</span><span class="p">,</span>
            <span class="n">Dr</span><span class="p">,</span>
            <span class="n">TAW</span><span class="p">,</span>
            <span class="n">Et0</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># water_stress(Crop, NewCond, Dr, TAW, Et0, beta)</span>

        <span class="c1"># Get canopy cover growth time</span>
        <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dtCC</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tCCadj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DAP</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span>
        <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dtCC</span> <span class="o">=</span> <span class="n">GDD</span>
            <span class="n">tCCadj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">GDDcum</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedGDDs</span>

        <span class="c1">## Canopy development (potential) ##</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tCCadj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Maturity</span><span class="p">):</span>
            <span class="c1"># No canopy development before emergence/germination or after</span>
            <span class="c1"># maturity</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEnd</span><span class="p">:</span>
            <span class="c1"># Canopy growth can occur</span>
            <span class="k">if</span> <span class="n">InitCond_CC_NS</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span><span class="p">:</span>
                <span class="c1"># Very small initial CC.</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span> <span class="o">*</span> <span class="n">dtCC</span><span class="p">)</span>
                <span class="c1"># print(Crop.CC0,np.exp(Crop.CGC*dtCC))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Canopy growing</span>
                <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                    <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span><span class="p">,</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span> <span class="n">tmp_tCC</span><span class="p">,</span> <span class="s2">&quot;Growth&quot;</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span>
                <span class="p">)</span>

            <span class="c1"># Update maximum canopy cover size in growing season</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct_NS</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span>
        <span class="k">elif</span> <span class="n">tCCadj</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEnd</span><span class="p">:</span>
            <span class="c1"># No more canopy growth is possible or canopy in decline</span>
            <span class="c1"># Set CCx for calculation of withered canopy effects</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW_NS</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct_NS</span>
            <span class="k">if</span> <span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span><span class="p">:</span>
                <span class="c1"># Mid-season stage - no canopy growth</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">=</span> <span class="n">InitCond_CC_NS</span>
                <span class="c1"># Update maximum canopy cover size in growing season</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct_NS</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Late-season stage - canopy decline</span>
                <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                    <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct_NS</span><span class="p">,</span>
                    <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span><span class="p">,</span>
                    <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span>
                    <span class="n">tmp_tCC</span><span class="p">,</span>
                    <span class="s2">&quot;Decline&quot;</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct_NS</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1">## Canopy development (actual) ##</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tCCadj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Maturity</span><span class="p">):</span>
            <span class="c1"># No canopy development before emergence/germination or after</span>
            <span class="c1"># maturity</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span>
        <span class="k">elif</span> <span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEnd</span><span class="p">:</span>
            <span class="c1"># Canopy growth can occur</span>
            <span class="k">if</span> <span class="n">InitCond_CC</span> <span class="o">&lt;=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">InitCond_ProtectedSeed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">InitCond_CC</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mf">1.25</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="c1"># Very small initial CC or seedling in protected phase of</span>
                <span class="c1"># growth. In this case, assume no leaf water expansion stress</span>
                <span class="k">if</span> <span class="n">InitCond_ProtectedSeed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span> <span class="n">tmp_tCC</span><span class="p">,</span> <span class="s2">&quot;Growth&quot;</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span>
                    <span class="p">)</span>
                    <span class="c1"># Check if seed protection should be turned off</span>
                    <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">1.25</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">):</span>
                        <span class="c1"># Turn off seed protection - lead expansion stress can</span>
                        <span class="c1"># occur on future time steps.</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">ProtectedSeed</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span> <span class="o">*</span> <span class="n">dtCC</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Canopy growing</span>

                <span class="k">if</span> <span class="n">InitCond_CC</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">0.9799</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">):</span>
                    <span class="c1"># Adjust canopy growth coefficient for leaf expansion water</span>
                    <span class="c1"># stress effects</span>
                    <span class="n">CGCadj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span> <span class="o">*</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Exp</span>
                    <span class="k">if</span> <span class="n">CGCadj</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="c1"># Adjust CCx for change in CGC</span>
                        <span class="n">CCXadj</span> <span class="o">=</span> <span class="n">adjust_CCx</span><span class="p">(</span>
                            <span class="n">InitCond_CC</span><span class="p">,</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">,</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span>
                            <span class="n">CGCadj</span><span class="p">,</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span>
                            <span class="n">dtCC</span><span class="p">,</span>
                            <span class="n">tCCadj</span><span class="p">,</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEnd</span><span class="p">,</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">CCXadj</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>

                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">InitCond_CC</span>
                        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">InitCond_CC</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.9799</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>

                            <span class="c1"># Approaching maximum canopy cover size</span>
                            <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                                <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span> <span class="n">tmp_tCC</span><span class="p">,</span> <span class="s2">&quot;Growth&quot;</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>

                            <span class="c1"># Determine time required to reach CC on previous,</span>
                            <span class="c1"># day, given CGCAdj value</span>
                            <span class="n">tReq</span> <span class="o">=</span> <span class="n">_cc_required_time</span><span class="p">(</span>
                                <span class="n">InitCond_CC</span><span class="p">,</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">,</span> <span class="n">CCXadj</span><span class="p">,</span> <span class="n">CGCadj</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span> <span class="s2">&quot;CGC&quot;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">tReq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                                <span class="c1"># Calclate GDD&#39;s for canopy growth</span>
                                <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tReq</span> <span class="o">+</span> <span class="n">dtCC</span>
                                <span class="c1"># Determine new canopy size</span>
                                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">,</span>
                                    <span class="n">CCXadj</span><span class="p">,</span>
                                    <span class="n">CGCadj</span><span class="p">,</span>
                                    <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span>
                                    <span class="n">tmp_tCC</span><span class="p">,</span>
                                    <span class="s2">&quot;Growth&quot;</span><span class="p">,</span>
                                    <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="c1"># print(NewCond.DAP,CCXadj,tReq)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># No canopy growth</span>
                                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">InitCond_CC</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="c1"># No canopy growth</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">InitCond_CC</span>
                        <span class="c1"># Update CC0</span>
                        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&gt;</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">:</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Canopy approaching maximum size</span>
                    <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span> <span class="n">tmp_tCC</span><span class="p">,</span> <span class="s2">&quot;Growth&quot;</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span>
                    <span class="p">)</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span>

            <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&gt;</span> <span class="n">InitCond_CCxAct</span><span class="p">:</span>
                <span class="c1"># Update actual maximum canopy cover size during growing season</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span>

        <span class="k">elif</span> <span class="n">tCCadj</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEnd</span><span class="p">:</span>

            <span class="c1"># No more canopy growth is possible or canopy is in decline</span>
            <span class="k">if</span> <span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span><span class="p">:</span>
                <span class="c1"># Mid-season stage - no canopy growth</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">InitCond_CC</span>
                <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&gt;</span> <span class="n">InitCond_CCxAct</span><span class="p">:</span>
                    <span class="c1"># Update actual maximum canopy cover size during growing</span>
                    <span class="c1"># season</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Late-season stage - canopy decline</span>
                <span class="c1"># Adjust canopy decline coefficient for difference between actual</span>
                <span class="c1"># and potential CCx</span>
                <span class="n">CDCadj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span> <span class="o">*</span> <span class="p">((</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">))</span>
                <span class="c1"># Determine new canopy size</span>
                <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span><span class="p">,</span>
                    <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span><span class="p">,</span>
                    <span class="n">CDCadj</span><span class="p">,</span>
                    <span class="n">tmp_tCC</span><span class="p">,</span>
                    <span class="s2">&quot;Decline&quot;</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Check for crop growth termination</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">InitCond_CropDead</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="c1"># Crop has died</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CropDead</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">## Canopy senescence due to water stress (actual) ##</span>
        <span class="k">if</span> <span class="n">tCCadj</span> <span class="o">&gt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">InitCond_tEarlySen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># Check for early canopy senescence  due to severe water</span>
                <span class="c1"># stress.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Ksw</span><span class="o">.</span><span class="n">Sen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">InitCond_ProtectedSeed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>

                    <span class="c1"># Early canopy senescence</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">PrematSenes</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">InitCond_tEarlySen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># No prior early senescence</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxEarlySen</span> <span class="o">=</span> <span class="n">InitCond_CC</span>

                    <span class="c1"># Increment early senescence GDD counter</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">tEarlySen</span> <span class="o">=</span> <span class="n">InitCond_tEarlySen</span> <span class="o">+</span> <span class="n">dtCC</span>
                    <span class="c1"># Adjust canopy decline coefficient for water stress</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">Ksw</span> <span class="o">=</span> <span class="n">KswClass</span><span class="p">()</span>
                    <span class="n">Ksw</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sto</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sen</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Pol</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">StoLin</span> <span class="o">=</span> <span class="n">_water_stress</span><span class="p">(</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">,</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">p_lo</span><span class="p">,</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">ETadj</span><span class="p">,</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                        <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">,</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">tEarlySen</span><span class="p">,</span>
                        <span class="n">Dr</span><span class="p">,</span>
                        <span class="n">TAW</span><span class="p">,</span>
                        <span class="n">Et0</span><span class="p">,</span>
                        <span class="n">beta</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Ksw = water_stress(Crop, NewCond, Dr, TAW, Et0, beta)</span>
                    <span class="k">if</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sen</span> <span class="o">&gt;</span> <span class="mf">0.99999</span><span class="p">:</span>
                        <span class="n">CDCadj</span> <span class="o">=</span> <span class="mf">0.0001</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">CDCadj</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">Ksw</span><span class="o">.</span><span class="n">Sen</span> <span class="o">**</span> <span class="mi">8</span><span class="p">))</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span>

                    <span class="c1"># Get new canpy cover size after senescence</span>
                    <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxEarlySen</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
                        <span class="n">CCsen</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Get time required to reach CC at end of previous day, given</span>
                        <span class="c1"># CDCadj</span>
                        <span class="n">tReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">InitCond_CC</span> <span class="o">/</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxEarlySen</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.05</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">CDCadj</span> <span class="o">*</span> <span class="mf">3.33</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CCxEarlySen</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="c1"># Calculate GDD&#39;s for canopy decline</span>
                        <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tReq</span> <span class="o">+</span> <span class="n">dtCC</span>
                        <span class="c1"># Determine new canopy size</span>
                        <span class="n">CCsen</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxEarlySen</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="mi">1</span>
                            <span class="o">-</span> <span class="mf">0.05</span>
                            <span class="o">*</span> <span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tmp_tCC</span> <span class="o">*</span> <span class="p">((</span><span class="n">CDCadj</span> <span class="o">*</span> <span class="mf">3.33</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CCxEarlySen</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">)))</span>
                                <span class="o">-</span> <span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">CCsen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">CCsen</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># Update canopy cover size</span>
                    <span class="k">if</span> <span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span><span class="p">:</span>
                        <span class="c1"># Limit CC to CCx</span>
                        <span class="k">if</span> <span class="n">CCsen</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">:</span>
                            <span class="n">CCsen</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span>

                        <span class="c1"># CC cannot be greater than value on previous day</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">CCsen</span>
                        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&gt;</span> <span class="n">InitCond_CC</span><span class="p">:</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">InitCond_CC</span>

                        <span class="c1"># Update maximum canopy cover size during growing</span>
                        <span class="c1"># season</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span>
                        <span class="c1"># Update CC0 if current CC is less than initial canopy</span>
                        <span class="c1"># cover size at planting</span>
                        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span><span class="p">:</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CC0</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Update CC to account for canopy cover senescence due</span>
                        <span class="c1"># to water stress</span>
                        <span class="k">if</span> <span class="n">CCsen</span> <span class="o">&lt;</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span><span class="p">:</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">CCsen</span>

                    <span class="c1"># Check for crop growth termination</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">InitCond_CropDead</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="c1"># Crop has died</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CropDead</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No water stress</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">PrematSenes</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tCCadj</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">InitCond_tEarlySen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># Rewatering of canopy in late season</span>
                        <span class="c1"># Get new values for CCx and CDC</span>
                        <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">dtCC</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span>
                        <span class="n">CCXadj</span><span class="p">,</span> <span class="n">CDCadj</span> <span class="o">=</span> <span class="n">_update_CCx_CDC</span><span class="p">(</span><span class="n">InitCond_CC</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CDC</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CCx</span><span class="p">,</span> <span class="n">tmp_tCC</span><span class="p">)</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span> <span class="o">=</span> <span class="n">CCXadj</span>
                        <span class="c1"># Get new CC value for end of current day</span>
                        <span class="n">tmp_tCC</span> <span class="o">=</span> <span class="n">tCCadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span>
                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">_cc_development</span><span class="p">(</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC0adj</span><span class="p">,</span> <span class="n">CCXadj</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CGC</span><span class="p">,</span> <span class="n">CDCadj</span><span class="p">,</span> <span class="n">tmp_tCC</span><span class="p">,</span> <span class="s2">&quot;Decline&quot;</span><span class="p">,</span> <span class="n">CCXadj</span>
                        <span class="p">)</span>
                        <span class="c1"># Check for crop growth termination</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">InitCond_CropDead</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CropDead</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Reset early senescence counter</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">tEarlySen</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Adjust CCx for effects of withered canopy</span>
                <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&gt;</span> <span class="n">InitCond_CCxW</span><span class="p">:</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span>

        <span class="c1">## Calculate canopy size adjusted for micro-advective effects ##</span>
        <span class="c1"># Check to ensure potential CC is not slightly lower than actual</span>
        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">&lt;</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span>
            <span class="k">if</span> <span class="n">tCCadj</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CanopyDevEnd</span><span class="p">:</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct_NS</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span>

        <span class="c1"># Actual (with water stress)</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCadj</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.72</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span>
        <span class="c1"># Potential (without water stress)</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCadj_NS</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mf">1.72</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No canopy outside growing season - set various values to zero</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCadj</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCadj_NS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW_NS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxAct_NS</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">NewCond</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.capillary_rise" class="doc doc-heading">
<code class="highlight language-python"><span class="n">capillary_rise</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">Soil_nLayer</span><span class="p">,</span> <span class="n">Soil_fshape_cr</span><span class="p">,</span> <span class="n">NewCond</span><span class="p">,</span> <span class="n">FluxOut</span><span class="p">,</span> <span class="n">water_table_presence</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate capillary rise from a shallow groundwater table</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=61" target="_blank">Reference Manual: capillary rise calculations</a> (pg. 52-61)</p>
<p><em>Arguments:</em></p>
<p><code>Soil</code>: <code>SoilClass</code> : Soil object</p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>FluxOut</code>: <code>np.array</code> : FLux of water out of each soil compartment</p>
<p><code>water_table_presence</code>: <code>int</code> : WaterTable present (1:yes, 0:no)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>CrTot</code>: <code>float</code> : Total Capillary rise</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">capillary_rise</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">Soil_nLayer</span><span class="p">,</span> <span class="n">Soil_fshape_cr</span><span class="p">,</span> <span class="n">NewCond</span><span class="p">,</span> <span class="n">FluxOut</span><span class="p">,</span> <span class="n">water_table_presence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate capillary rise from a shallow groundwater table</span>


<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=61&quot; target=&quot;_blank&quot;&gt;Reference Manual: capillary rise calculations&lt;/a&gt; (pg. 52-61)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `Soil`: `SoilClass` : Soil object</span>

<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `FluxOut`: `np.array` : FLux of water out of each soil compartment</span>

<span class="sd">    `water_table_presence`: `int` : WaterTable present (1:yes, 0:no)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `CrTot`: `float` : Total Capillary rise</span>





<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Get groundwater table elevation on current day ##</span>
    <span class="n">zGW</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">zGW</span>

    <span class="c1">## Calculate capillary rise ##</span>
    <span class="k">if</span> <span class="n">water_table_presence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># No water table present</span>
        <span class="c1"># Capillary rise is zero</span>
        <span class="n">CrTot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">water_table_presence</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Water table present</span>
        <span class="c1"># Get maximum capillary rise for bottom compartment</span>
        <span class="n">zBot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">zBotMid</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">zMid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="n">prof</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">zGW</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">zGW</span> <span class="o">-</span> <span class="n">zBotMid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">zBotMid</span> <span class="o">&gt;=</span> <span class="n">zGW</span><span class="p">:</span>
                <span class="n">MaxCR</span> <span class="o">=</span> <span class="mi">99</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">MaxCR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">zGW</span> <span class="o">-</span> <span class="n">zBotMid</span><span class="p">)</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">bCR</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">aCR</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">MaxCR</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">:</span>
                    <span class="n">MaxCR</span> <span class="o">=</span> <span class="mi">99</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">MaxCR</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">######################### this needs fixing, will currently break####################</span>

        <span class="c1">#         # Find top of next soil layer that is not within modelled soil profile</span>
        <span class="c1">#         zTopLayer = 0</span>
        <span class="c1">#         for layeri in np.sort(np.unique(prof.Layer)):</span>
        <span class="c1">#             # Calculate layer thickness</span>
        <span class="c1">#             l_idx = np.argwhere(prof.Layer==layeri).flatten()</span>

        <span class="c1">#             LayThk = prof.dz[l_idx].sum()</span>
        <span class="c1">#             zTopLayer = zTopLayer+LayThk</span>

        <span class="c1">#         # Check for restrictions on upward flow caused by properties of</span>
        <span class="c1">#         # compartments that are not modelled in the soil water balance</span>
        <span class="c1">#         layeri = prof.Layer[-1]</span>

        <span class="c1">#         assert layeri == Soil_nLayer</span>

        <span class="c1">#         while (zTopLayer &lt; zGW) and (layeri &lt; Soil_nLayer):</span>
        <span class="c1">#             # this needs fixing, will currently break</span>

        <span class="c1">#             layeri = layeri+1</span>
        <span class="c1">#             compdf = prof.Layer[layeri]</span>
        <span class="c1">#             if (compdf.Ksat &gt; 0) and (zGW &gt; 0) and ((zGW-zTopLayer) &lt; 4):</span>
        <span class="c1">#                 if zTopLayer &gt;= zGW:</span>
        <span class="c1">#                     LimCR = 99</span>
        <span class="c1">#                 else:</span>
        <span class="c1">#                     LimCR = np.exp((np.log(zGW-zTopLayer)-compdf.bCR)/compdf.aCR)</span>
        <span class="c1">#                     if LimCR &gt; 99:</span>
        <span class="c1">#                         LimCR = 99</span>

        <span class="c1">#             else:</span>
        <span class="c1">#                 LimCR = 0</span>

        <span class="c1">#             if MaxCR &gt; LimCR:</span>
        <span class="c1">#                 MaxCR = LimCR</span>

        <span class="c1">#             zTopLayer = zTopLayer+compdf.dz</span>

        <span class="c1">#####################################################################################</span>

        <span class="c1"># Calculate capillary rise</span>
        <span class="n">compi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Comp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Start at bottom of root zone</span>
        <span class="n">WCr</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Capillary rise counter</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">MaxCR</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">compi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">FluxOut</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Proceed upwards until maximum capillary rise occurs, soil surface</span>
            <span class="c1"># is reached, or encounter a compartment where downward</span>
            <span class="c1"># drainage/infiltration has already occurred on current day</span>
            <span class="c1"># Find layer of current compartment</span>
            <span class="c1"># Calculate driving force</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Soil_fshape_cr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">Df</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">th_fc_Adj</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="o">**</span> <span class="n">Soil_fshape_cr</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">Df</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Df</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">Df</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Df</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">Df</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Calculate relative hydraulic conductivity</span>
            <span class="n">thThr</span> <span class="o">=</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thThr</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">thThr</span> <span class="o">&lt;=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">]):</span>
                    <span class="n">Krel</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Krel</span> <span class="o">=</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">thThr</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">Krel</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Check if room is available to store water from capillary rise</span>
            <span class="n">dth</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th_fc_Adj</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>

            <span class="c1"># Store water if room is available</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">zBot</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zGW</span><span class="p">):</span>
                <span class="n">dthMax</span> <span class="o">=</span> <span class="n">Krel</span> <span class="o">*</span> <span class="n">Df</span> <span class="o">*</span> <span class="n">MaxCR</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">dth</span> <span class="o">&gt;=</span> <span class="n">dthMax</span><span class="p">:</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">+</span> <span class="n">dthMax</span>
                    <span class="n">CRcomp</span> <span class="o">=</span> <span class="n">dthMax</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
                    <span class="n">MaxCR</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th_fc_Adj</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
                    <span class="n">CRcomp</span> <span class="o">=</span> <span class="n">dth</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
                    <span class="n">MaxCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">Krel</span> <span class="o">*</span> <span class="n">MaxCR</span><span class="p">)</span> <span class="o">-</span> <span class="n">CRcomp</span>

                <span class="n">WCr</span> <span class="o">=</span> <span class="n">WCr</span> <span class="o">+</span> <span class="n">CRcomp</span>

            <span class="c1"># Update bottom elevation of compartment</span>
            <span class="n">zBot</span> <span class="o">=</span> <span class="n">zBot</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
            <span class="c1"># Update compartment and layer counters</span>
            <span class="n">compi</span> <span class="o">=</span> <span class="n">compi</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1"># Update restriction on maximum capillary rise</span>
            <span class="k">if</span> <span class="n">compi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>

                <span class="n">zBotMid</span> <span class="o">=</span> <span class="n">zBot</span> <span class="o">-</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">zGW</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">zGW</span> <span class="o">-</span> <span class="n">zBotMid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zBotMid</span> <span class="o">&gt;=</span> <span class="n">zGW</span><span class="p">:</span>
                        <span class="n">LimCR</span> <span class="o">=</span> <span class="mi">99</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">LimCR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">zGW</span> <span class="o">-</span> <span class="n">zBotMid</span><span class="p">)</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">bCR</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">aCR</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">LimCR</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">:</span>
                            <span class="n">LimCR</span> <span class="o">=</span> <span class="mi">99</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LimCR</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">MaxCR</span> <span class="o">&gt;</span> <span class="n">LimCR</span><span class="p">:</span>
                    <span class="n">MaxCR</span> <span class="o">=</span> <span class="n">LimCR</span>

        <span class="c1"># Store total depth of capillary rise</span>
        <span class="n">CrTot</span> <span class="o">=</span> <span class="n">WCr</span>

    <span class="k">return</span> <span class="n">NewCond</span><span class="p">,</span> <span class="n">CrTot</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.cc_development" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cc_development</span><span class="p">(</span><span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">CCx0</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate canopy cover development by end of the current simulation day</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=30" target="_blank">Reference Manual: CC devlopment</a> (pg. 21-24)</p>
<p><em>Arguments:</em></p>
<p><code>CCo</code>: <code>float</code> : Fractional canopy cover size at emergence</p>
<p><code>CCx</code>: <code>float</code> : Maximum canopy cover (fraction of soil cover)</p>
<p><code>CGC</code>: <code>float</code> : Canopy growth coefficient (fraction per GDD)</p>
<p><code>CDC</code>: <code>float</code> : Canopy decline coefficient (fraction per GDD/calendar day)</p>
<p><code>dt</code>: <code>float</code> : Time delta of canopy growth (1 calander day or ... GDD)</p>
<p><code>Mode</code>: <code>str</code> : Stage of Canopy developement (Growth or Decline)</p>
<p><code>CCx0</code>: <code>float</code> : Maximum canopy cover (fraction of soil cover)</p>
<p><em>Returns:</em></p>
<p><code>CC</code>: <code>float</code> : Canopy Cover</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_cc_development&quot;</span><span class="p">,</span> <span class="s2">&quot;f8(f8,f8,f8,f8,f8,unicode_type,f8)&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cc_development</span><span class="p">(</span><span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">CCx0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate canopy cover development by end of the current simulation day</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=30&quot; target=&quot;_blank&quot;&gt;Reference Manual: CC devlopment&lt;/a&gt; (pg. 21-24)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `CCo`: `float` : Fractional canopy cover size at emergence</span>

<span class="sd">    `CCx`: `float` : Maximum canopy cover (fraction of soil cover)</span>

<span class="sd">    `CGC`: `float` : Canopy growth coefficient (fraction per GDD)</span>

<span class="sd">    `CDC`: `float` : Canopy decline coefficient (fraction per GDD/calendar day)</span>

<span class="sd">    `dt`: `float` : Time delta of canopy growth (1 calander day or ... GDD)</span>

<span class="sd">    `Mode`: `str` : Stage of Canopy developement (Growth or Decline)</span>

<span class="sd">    `CCx0`: `float` : Maximum canopy cover (fraction of soil cover)</span>

<span class="sd">    *Returns:*</span>

<span class="sd">    `CC`: `float` : Canopy Cover</span>




<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Initialise output ##</span>

    <span class="c1">## Calculate new canopy cover ##</span>
    <span class="k">if</span> <span class="n">Mode</span> <span class="o">==</span> <span class="s2">&quot;Growth&quot;</span><span class="p">:</span>
        <span class="c1"># Calculate canopy growth</span>
        <span class="c1"># Exponential growth stage</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="n">CCo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">CGC</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CC</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">CCx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Exponential decay stage</span>
            <span class="n">CC</span> <span class="o">=</span> <span class="n">CCx</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">CCx</span> <span class="o">/</span> <span class="n">CCo</span><span class="p">)</span> <span class="o">*</span> <span class="n">CCx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CGC</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Limit CC to CCx</span>
        <span class="k">if</span> <span class="n">CC</span> <span class="o">&gt;</span> <span class="n">CCx</span><span class="p">:</span>
            <span class="n">CC</span> <span class="o">=</span> <span class="n">CCx</span>

    <span class="k">elif</span> <span class="n">Mode</span> <span class="o">==</span> <span class="s2">&quot;Decline&quot;</span><span class="p">:</span>
        <span class="c1"># Calculate canopy decline</span>
        <span class="k">if</span> <span class="n">CCx</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">CC</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CC</span> <span class="o">=</span> <span class="n">CCx</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span>
                <span class="o">-</span> <span class="mf">0.05</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">CDC</span> <span class="o">*</span> <span class="mf">3.33</span> <span class="o">*</span> <span class="p">((</span><span class="n">CCx</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CCx0</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">CCx</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1">## Limit canopy cover to between 0 and 1 ##</span>
    <span class="k">if</span> <span class="n">CC</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">CC</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">CC</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.cc_required_time" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cc_required_time</span><span class="p">(</span><span class="n">CCprev</span><span class="p">,</span> <span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">Mode</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to find time required to reach CC at end of previous day, given current CGC or CDC</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=30" target="_blank">Reference Manual: CC devlopment</a> (pg. 21-24)</p>
<p><em>Arguments:</em></p>
<p><code>CCprev</code>: <code>float</code> : Canopy Cover at previous timestep.</p>
<p><code>CCo</code>: <code>float</code> : Fractional canopy cover size at emergence</p>
<p><code>CCx</code>: <code>float</code> : Maximum canopy cover (fraction of soil cover)</p>
<p><code>CGC</code>: <code>float</code> : Canopy growth coefficient (fraction per GDD)</p>
<p><code>CDC</code>: <code>float</code> : Canopy decline coefficient (fraction per GDD/calendar day)</p>
<p><code>Mode</code>: <code>str</code> : Canopy growth/decline coefficient (fraction per GDD/calendar day)</p>
<p><em>Returns:</em></p>
<p><code>tReq</code>: <code>float</code> : time required to reach CC at end of previous day</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_cc_required_time&quot;</span><span class="p">,</span> <span class="s2">&quot;f8(f8,f8,f8,f8,f8,unicode_type)&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cc_required_time</span><span class="p">(</span><span class="n">CCprev</span><span class="p">,</span> <span class="n">CCo</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">Mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to find time required to reach CC at end of previous day, given current CGC or CDC</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=30&quot; target=&quot;_blank&quot;&gt;Reference Manual: CC devlopment&lt;/a&gt; (pg. 21-24)</span>



<span class="sd">    *Arguments:*</span>


<span class="sd">    `CCprev`: `float` : Canopy Cover at previous timestep.</span>

<span class="sd">    `CCo`: `float` : Fractional canopy cover size at emergence</span>

<span class="sd">    `CCx`: `float` : Maximum canopy cover (fraction of soil cover)</span>

<span class="sd">    `CGC`: `float` : Canopy growth coefficient (fraction per GDD)</span>

<span class="sd">    `CDC`: `float` : Canopy decline coefficient (fraction per GDD/calendar day)</span>

<span class="sd">    `Mode`: `str` : Canopy growth/decline coefficient (fraction per GDD/calendar day)</span>


<span class="sd">    *Returns:*</span>

<span class="sd">    `tReq`: `float` : time required to reach CC at end of previous day</span>





<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Get CGC and/or time (GDD or CD) required to reach CC on previous day ##</span>
    <span class="k">if</span> <span class="n">Mode</span> <span class="o">==</span> <span class="s2">&quot;CGC&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">CCprev</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">CCx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>

            <span class="c1"># print(CCprev,CCo,(tSum-dt),tSum,dt)</span>
            <span class="n">CGCx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">CCprev</span> <span class="o">/</span> <span class="n">CCo</span><span class="p">)</span>
            <span class="c1"># print(np.log(CCprev/CCo),(tSum-dt),CGCx)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(CCx,CCo,CCprev)</span>
            <span class="n">CGCx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">CCx</span> <span class="o">*</span> <span class="n">CCx</span> <span class="o">/</span> <span class="n">CCo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CCx</span> <span class="o">-</span> <span class="n">CCprev</span><span class="p">))</span>

        <span class="n">tReq</span> <span class="o">=</span> <span class="n">CGCx</span> <span class="o">/</span> <span class="n">CGC</span>

    <span class="k">elif</span> <span class="n">Mode</span> <span class="o">==</span> <span class="s2">&quot;CDC&quot;</span><span class="p">:</span>
        <span class="n">tReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CCprev</span> <span class="o">/</span> <span class="n">CCx</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.05</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">CDC</span> <span class="o">/</span> <span class="n">CCx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tReq</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.check_groundwater_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_groundwater_table</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">NewCond_zGW</span><span class="p">,</span> <span class="n">NewCond_th</span><span class="p">,</span> <span class="n">NewCond_th_fc_Adj</span><span class="p">,</span> <span class="n">water_table_presence</span><span class="p">,</span> <span class="n">zGW</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to check for presence of a groundwater table, and, if present,
to adjust compartment water contents and field capacities where necessary</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=61" target="_blank">Reference manual: water table adjustment equations</a> (pg. 52-57)</p>
<p><em>Arguments:</em></p>
<p><code>Soil</code>: <code>SoilClass</code> : Soil object containing soil paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>water_table_presence</code>: int :  indicates if water table is present or not</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>Soil</code>: <code>SoilClass</code> : Soil object containing updated soil paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_check_groundwater_table&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SoilProfileNT_typ_sig</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">[:],</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">check_groundwater_table</span><span class="p">(</span>
    <span class="n">prof</span><span class="p">,</span>
    <span class="n">NewCond_zGW</span><span class="p">,</span>
    <span class="n">NewCond_th</span><span class="p">,</span>
    <span class="n">NewCond_th_fc_Adj</span><span class="p">,</span>
    <span class="n">water_table_presence</span><span class="p">,</span>
    <span class="n">zGW</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to check for presence of a groundwater table, and, if present,</span>
<span class="sd">    to adjust compartment water contents and field capacities where necessary</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=61&quot; target=&quot;_blank&quot;&gt;Reference manual: water table adjustment equations&lt;/a&gt; (pg. 52-57)</span>


<span class="sd">    *Arguments:*</span>

<span class="sd">    `Soil`: `SoilClass` : Soil object containing soil paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `water_table_presence`: int :  indicates if water table is present or not</span>


<span class="sd">    *Returns:*</span>

<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `Soil`: `SoilClass` : Soil object containing updated soil paramaters</span>




<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Perform calculations (if variable water table is present) ##</span>
    <span class="k">if</span> <span class="n">water_table_presence</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

        <span class="c1"># Update groundwater conditions for current day</span>
        <span class="n">NewCond_zGW</span> <span class="o">=</span> <span class="n">zGW</span>

        <span class="c1"># Find compartment mid-points</span>
        <span class="n">zMid</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">zMid</span>

        <span class="c1"># Check if water table is within modelled soil profile</span>
        <span class="k">if</span> <span class="n">NewCond_zGW</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zMid</span><span class="p">[</span><span class="n">zMid</span> <span class="o">&gt;=</span> <span class="n">NewCond_zGW</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">NewCond_WTinSoil</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">NewCond_WTinSoil</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If water table is in soil profile, adjust water contents</span>
        <span class="k">if</span> <span class="n">NewCond_WTinSoil</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">zMid</span> <span class="o">&gt;=</span> <span class="n">NewCond_zGW</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Comp</span><span class="p">)):</span>
                <span class="n">NewCond_th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="c1"># Adjust compartment field capacity</span>
        <span class="n">compi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Comp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">thfcAdj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">compi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Find thFCadj for all compartments</span>
        <span class="k">while</span> <span class="n">compi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">Xmax</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="p">:</span>
                    <span class="n">Xmax</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pF</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.2</span>
                    <span class="n">Xmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pF</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">100</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">NewCond_zGW</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">NewCond_zGW</span> <span class="o">-</span> <span class="n">zMid</span><span class="p">[</span><span class="n">compi</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">Xmax</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">compi</span><span class="p">):</span>

                    <span class="n">thfcAdj</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                <span class="n">compi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">compi</span><span class="p">]:</span>
                    <span class="n">thfcAdj</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">zMid</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">NewCond_zGW</span><span class="p">:</span>
                        <span class="n">thfcAdj</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dV</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
                        <span class="n">dFC</span> <span class="o">=</span> <span class="p">(</span><span class="n">dV</span> <span class="o">/</span> <span class="p">(</span><span class="n">Xmax</span> <span class="o">*</span> <span class="n">Xmax</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">zMid</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">NewCond_zGW</span> <span class="o">-</span> <span class="n">Xmax</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">thfcAdj</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">+</span> <span class="n">dFC</span>

                <span class="n">compi</span> <span class="o">=</span> <span class="n">compi</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Store adjusted field capacity values</span>
        <span class="n">NewCond_th_fc_Adj</span> <span class="o">=</span> <span class="n">thfcAdj</span>
        <span class="c1"># prof.th_fc_Adj = thfcAdj</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">NewCond_th_fc_Adj</span><span class="p">,</span> <span class="n">thfcAdj</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.drainage" class="doc doc-heading">
<code class="highlight language-python"><span class="n">drainage</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">th_init</span><span class="p">,</span> <span class="n">th_fc_Adj_init</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to redistribute stored soil water</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=51" target="_blank">Reference Manual: drainage calculations</a> (pg. 42-65)</p>
<p><em>Arguments:</em></p>
<p><code>prof</code>: <code>SoilProfileClass</code> : jit class object object containing soil paramaters</p>
<p><code>th_init</code>: <code>np.array</code> : initial water content</p>
<p><code>th_fc_Adj_init</code>: <code>np.array</code> : adjusted water content at field capacity</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>DeepPerc</code>:: <code>float</code> : Total Deep Percolation</p>
<p><code>FluxOut</code>:: <code>array-like</code> : Flux of water out of each compartment</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_drainage&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SoilProfileNT_typ_sig</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">[:]))</span>
<span class="k">def</span> <span class="nf">drainage</span><span class="p">(</span>
    <span class="n">prof</span><span class="p">,</span> <span class="n">th_init</span><span class="p">,</span> <span class="n">th_fc_Adj_init</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to redistribute stored soil water</span>



<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=51&quot; target=&quot;_blank&quot;&gt;Reference Manual: drainage calculations&lt;/a&gt; (pg. 42-65)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `prof`: `SoilProfileClass` : jit class object object containing soil paramaters</span>

<span class="sd">    `th_init`: `np.array` : initial water content</span>

<span class="sd">    `th_fc_Adj_init`: `np.array` : adjusted water content at field capacity</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `DeepPerc`:: `float` : Total Deep Percolation</span>

<span class="sd">    `FluxOut`:: `array-like` : Flux of water out of each compartment</span>





<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Store initial conditions in new structure for updating %%</span>
    <span class="c1">#     NewCond = InitCond</span>

    <span class="c1">#     th_init = InitCond.th</span>
    <span class="c1">#     th_fc_Adj_init = InitCond.th_fc_Adj</span>

    <span class="c1">#  Preallocate arrays %%</span>
    <span class="n">thnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">th_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">FluxOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">th_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Initialise counters and states %%</span>
    <span class="n">drainsum</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Calculate drainage and updated water contents %%</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">th_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Specify layer for compartment</span>
        <span class="n">cth_fc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">cth_s</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ctau</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">cdz</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">cdzsum</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">cKsat</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="c1"># Calculate drainage ability of compartment ii</span>
        <span class="k">if</span> <span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
            <span class="n">dthdt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cth_s</span><span class="p">:</span>
            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">ctau</span> <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                <span class="n">dthdt</span> <span class="o">=</span> <span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dthdt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ctau</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                <span class="n">dthdt</span> <span class="o">=</span> <span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="c1"># Drainage from compartment ii (mm)</span>
        <span class="n">draincomp</span> <span class="o">=</span> <span class="n">dthdt</span> <span class="o">*</span> <span class="n">cdz</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1"># Check drainage ability of compartment ii against cumulative drainage</span>
        <span class="c1"># from compartments above</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prethick</span> <span class="o">=</span> <span class="n">cdzsum</span> <span class="o">-</span> <span class="n">cdz</span>
        <span class="n">drainmax</span> <span class="o">=</span> <span class="n">dthdt</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prethick</span>
        <span class="k">if</span> <span class="n">drainsum</span> <span class="o">&lt;=</span> <span class="n">drainmax</span><span class="p">:</span>
            <span class="n">drainability</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drainability</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Drain compartment ii</span>
        <span class="k">if</span> <span class="n">drainability</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># No storage needed. Update water content in compartment ii</span>
            <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span>

            <span class="c1"># Update cumulative drainage (mm)</span>
            <span class="n">drainsum</span> <span class="o">=</span> <span class="n">drainsum</span> <span class="o">+</span> <span class="n">draincomp</span>

            <span class="c1"># Restrict cumulative drainage to saturated hydraulic</span>
            <span class="c1"># conductivity and adjust excess drainage flow</span>
            <span class="k">if</span> <span class="n">drainsum</span> <span class="o">&gt;</span> <span class="n">cKsat</span><span class="p">:</span>
                <span class="n">excess</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">+</span> <span class="n">drainsum</span> <span class="o">-</span> <span class="n">cKsat</span>
                <span class="n">drainsum</span> <span class="o">=</span> <span class="n">cKsat</span>

        <span class="k">elif</span> <span class="n">drainability</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Storage is needed</span>
            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">drainsum</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prethick</span><span class="p">)</span>

            <span class="c1"># Calculate value of theta (thX) needed to provide a</span>
            <span class="c1"># drainage ability equal to cumulative drainage</span>
            <span class="k">if</span> <span class="n">dthdt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">thX</span> <span class="o">=</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">ctau</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">dthdt</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">ctau</span> <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)))</span>
                <span class="n">thX</span> <span class="o">=</span> <span class="n">cth_fc</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">thX</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                    <span class="n">thX</span> <span class="o">=</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">thX</span> <span class="o">=</span> <span class="n">cth_s</span> <span class="o">+</span> <span class="mf">0.01</span>

            <span class="c1"># Check thX against hydraulic properties of current soil layer</span>
            <span class="k">if</span> <span class="n">thX</span> <span class="o">&lt;=</span> <span class="n">cth_s</span><span class="p">:</span>
                <span class="c1"># Increase compartment ii water content with cumulative</span>
                <span class="c1"># drainage</span>
                <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">drainsum</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span><span class="p">))</span>
                <span class="c1"># Check updated water content against thX</span>
                <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thX</span><span class="p">:</span>
                    <span class="c1"># Cumulative drainage is the drainage difference</span>
                    <span class="c1"># between theta_x and new theta plus drainage ability</span>
                    <span class="c1"># at theta_x.</span>
                    <span class="n">drainsum</span> <span class="o">=</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">thX</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span>
                    <span class="c1"># Calculate drainage ability for thX</span>
                    <span class="k">if</span> <span class="n">thX</span> <span class="o">&lt;=</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">thX</span> <span class="o">&gt;=</span> <span class="n">cth_s</span><span class="p">:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="n">ctau</span> <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">thX</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thX</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ctau</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                            <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">thX</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">thX</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thX</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                    <span class="c1"># Update drainage total</span>
                    <span class="n">drainsum</span> <span class="o">=</span> <span class="n">drainsum</span> <span class="o">+</span> <span class="p">(</span><span class="n">dthdt</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span><span class="p">)</span>
                    <span class="c1"># Restrict cumulative drainage to saturated hydraulic</span>
                    <span class="c1"># conductivity and adjust excess drainage flow</span>
                    <span class="k">if</span> <span class="n">drainsum</span> <span class="o">&gt;</span> <span class="n">cKsat</span><span class="p">:</span>
                        <span class="n">excess</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">+</span> <span class="n">drainsum</span> <span class="o">-</span> <span class="n">cKsat</span>
                        <span class="n">drainsum</span> <span class="o">=</span> <span class="n">cKsat</span>

                    <span class="c1"># Update water content</span>
                    <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">thX</span> <span class="o">-</span> <span class="n">dthdt</span>

                <span class="k">elif</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                    <span class="c1"># Calculate drainage ability for updated water content</span>
                    <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cth_s</span><span class="p">:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="n">ctau</span> <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ctau</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                            <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                    <span class="c1"># Update water content in compartment ii</span>
                    <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span>
                    <span class="c1"># Update cumulative drainage</span>
                    <span class="n">drainsum</span> <span class="o">=</span> <span class="n">dthdt</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span>
                    <span class="c1"># Restrict cumulative drainage to saturated hydraulic</span>
                    <span class="c1"># conductivity and adjust excess drainage flow</span>
                    <span class="k">if</span> <span class="n">drainsum</span> <span class="o">&gt;</span> <span class="n">cKsat</span><span class="p">:</span>
                        <span class="n">excess</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">+</span> <span class="n">drainsum</span> <span class="o">-</span> <span class="n">cKsat</span>
                        <span class="n">drainsum</span> <span class="o">=</span> <span class="n">cKsat</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Drainage and cumulative drainage are zero as water</span>
                    <span class="c1"># content has not risen above field capacity in</span>
                    <span class="c1"># compartment ii.</span>
                    <span class="n">drainsum</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">elif</span> <span class="n">thX</span> <span class="o">&gt;</span> <span class="n">cth_s</span><span class="p">:</span>
                <span class="c1"># Increase water content in compartment ii with cumulative</span>
                <span class="c1"># drainage from above</span>
                <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">th_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">drainsum</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span><span class="p">))</span>
                <span class="c1"># Check new water content against hydraulic properties of soil</span>
                <span class="c1"># layer</span>
                <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cth_s</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                        <span class="c1"># Calculate new drainage ability</span>
                        <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">elif</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cth_s</span><span class="p">:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">ctau</span> <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                                <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">ctau</span>
                                <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                                <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                        <span class="c1"># Update water content in compartment ii</span>
                        <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span>
                        <span class="c1"># Update cumulative drainage</span>
                        <span class="n">drainsum</span> <span class="o">=</span> <span class="n">dthdt</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span>
                        <span class="c1"># Restrict cumulative drainage to saturated hydraulic</span>
                        <span class="c1"># conductivity and adjust excess drainage flow</span>
                        <span class="k">if</span> <span class="n">drainsum</span> <span class="o">&gt;</span> <span class="n">cKsat</span><span class="p">:</span>
                            <span class="n">excess</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">+</span> <span class="n">drainsum</span> <span class="o">-</span> <span class="n">cKsat</span>
                            <span class="n">drainsum</span> <span class="o">=</span> <span class="n">cKsat</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">drainsum</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">elif</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cth_s</span><span class="p">:</span>
                    <span class="c1"># Calculate excess drainage above saturation</span>
                    <span class="n">excess</span> <span class="o">=</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">cth_s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span>
                    <span class="c1"># Calculate drainage ability for updated water content</span>
                    <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cth_s</span><span class="p">:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="n">ctau</span> <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dthdt</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ctau</span>
                            <span class="o">*</span> <span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span>
                            <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">cth_s</span> <span class="o">-</span> <span class="n">cth_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">dthdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                            <span class="n">dthdt</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">th_fc_Adj_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                    <span class="c1"># Update water content in compartment ii</span>
                    <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">cth_s</span> <span class="o">-</span> <span class="n">dthdt</span>

                    <span class="c1"># Update drainage from compartment ii</span>
                    <span class="n">draincomp</span> <span class="o">=</span> <span class="n">dthdt</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">cdz</span>
                    <span class="c1"># Update maximum drainage</span>
                    <span class="n">drainmax</span> <span class="o">=</span> <span class="n">dthdt</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prethick</span>

                    <span class="c1"># Update excess drainage</span>
                    <span class="k">if</span> <span class="n">drainmax</span> <span class="o">&gt;</span> <span class="n">excess</span><span class="p">:</span>
                        <span class="n">drainmax</span> <span class="o">=</span> <span class="n">excess</span>

                    <span class="n">excess</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">-</span> <span class="n">drainmax</span>
                    <span class="c1"># Update drainsum and restrict to saturated hydraulic</span>
                    <span class="c1"># conductivity of soil layer</span>
                    <span class="n">drainsum</span> <span class="o">=</span> <span class="n">draincomp</span> <span class="o">+</span> <span class="n">drainmax</span>
                    <span class="k">if</span> <span class="n">drainsum</span> <span class="o">&gt;</span> <span class="n">cKsat</span><span class="p">:</span>
                        <span class="n">excess</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">+</span> <span class="n">drainsum</span> <span class="o">-</span> <span class="n">cKsat</span>
                        <span class="n">drainsum</span> <span class="o">=</span> <span class="n">cKsat</span>

        <span class="c1"># Store output flux from compartment ii</span>
        <span class="n">FluxOut</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">drainsum</span>

        <span class="c1"># Redistribute excess in compartment above</span>
        <span class="k">if</span> <span class="n">excess</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">precomp</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">excess</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">precomp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># Update compartment counter</span>
                <span class="n">precomp</span> <span class="o">=</span> <span class="n">precomp</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="c1"># Update layer counter</span>
                <span class="c1"># precompdf = Soil.Profile.Comp[precomp]</span>

                <span class="c1"># Update flux from compartment</span>
                <span class="k">if</span> <span class="n">precomp</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">:</span>
                    <span class="n">FluxOut</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">FluxOut</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">-</span> <span class="n">excess</span>

                <span class="c1"># Increase water content to store excess</span>
                <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">excess</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">precomp</span><span class="p">]))</span>

                <span class="c1"># Limit water content to saturation and adjust excess counter</span>
                <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">precomp</span><span class="p">]:</span>
                    <span class="n">excess</span> <span class="o">=</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">precomp</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span>
                    <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">excess</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">## Update conditions and outputs ##</span>
    <span class="c1"># Total deep percolation (mm)</span>
    <span class="n">DeepPerc</span> <span class="o">=</span> <span class="n">drainsum</span>
    <span class="c1"># Water contents</span>
    <span class="c1"># NewCond.th = thnew</span>

    <span class="k">return</span> <span class="n">thnew</span><span class="p">,</span> <span class="n">DeepPerc</span><span class="p">,</span> <span class="n">FluxOut</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.germination" class="doc doc-heading">
<code class="highlight language-python"><span class="n">germination</span><span class="p">(</span><span class="n">InitCond</span><span class="p">,</span> <span class="n">Soil_zGerm</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">Crop_GermThr</span><span class="p">,</span> <span class="n">Crop_PlantMethod</span><span class="p">,</span> <span class="n">GDD</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to check if crop has germinated</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=32" target="_blank">Reference Manual: germination condition</a> (pg. 23)</p>
<p><em>Arguments:</em></p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Soil_zGerm</code>: <code>float</code> : Soil depth affecting germination</p>
<p><code>prof</code>: <code>SoilProfileClass</code> : Soil object containing soil paramaters</p>
<p><code>Crop_GermThr</code>: <code>float</code> : Crop germination threshold</p>
<p><code>Crop_PlantMethod</code>: <code>bool</code> : sown as seedling True or False</p>
<p><code>GDD</code>: <code>float</code> : Number of Growing Degree Days on current day</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is growing season (True or Flase)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">germination</span><span class="p">(</span><span class="n">InitCond</span><span class="p">,</span> <span class="n">Soil_zGerm</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">Crop_GermThr</span><span class="p">,</span> <span class="n">Crop_PlantMethod</span><span class="p">,</span> <span class="n">GDD</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to check if crop has germinated</span>


<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=32&quot; target=&quot;_blank&quot;&gt;Reference Manual: germination condition&lt;/a&gt; (pg. 23)</span>


<span class="sd">    *Arguments:*</span>


<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Soil_zGerm`: `float` : Soil depth affecting germination</span>

<span class="sd">    `prof`: `SoilProfileClass` : Soil object containing soil paramaters</span>

<span class="sd">    `Crop_GermThr`: `float` : Crop germination threshold</span>

<span class="sd">    `Crop_PlantMethod`: `bool` : sown as seedling True or False</span>

<span class="sd">    `GDD`: `float` : Number of Growing Degree Days on current day</span>

<span class="sd">    `GrowingSeason`:: `bool` : is growing season (True or Flase)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>







<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions in new structure for updating ##</span>
    <span class="n">NewCond</span> <span class="o">=</span> <span class="n">InitCond</span>

    <span class="c1">## Check for germination (if in growing season) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">Germination</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Find compartments covered by top soil layer affecting germination</span>
            <span class="n">comp_sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&gt;=</span> <span class="n">Soil_zGerm</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Calculate water content in top soil layer</span>
            <span class="n">Wr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">WrFC</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">WrWP</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Get soil layer</span>
                <span class="c1"># Determine fraction of compartment covered by top soil layer</span>
                <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Soil_zGerm</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">Soil_zGerm</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Increment actual water storage (mm)</span>
                <span class="n">Wr</span> <span class="o">=</span> <span class="n">Wr</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
                <span class="c1"># Increment water storage at field capacity (mm)</span>
                <span class="n">WrFC</span> <span class="o">=</span> <span class="n">WrFC</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
                <span class="c1"># Increment water storage at permanent wilting point (mm)</span>
                <span class="n">WrWP</span> <span class="o">=</span> <span class="n">WrWP</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Limit actual water storage to not be less than zero</span>
            <span class="k">if</span> <span class="n">Wr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Wr</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Calculate proportional water content</span>
            <span class="n">WcProp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">WrFC</span> <span class="o">-</span> <span class="n">Wr</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">WrFC</span> <span class="o">-</span> <span class="n">WrWP</span><span class="p">))</span>

            <span class="c1"># Check if water content is above germination threshold</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">WcProp</span> <span class="o">&gt;=</span> <span class="n">Crop_GermThr</span><span class="p">):</span>
                <span class="c1"># Crop has germinated</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">Germination</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># If crop sown as seedling, turn on seedling protection</span>
                <span class="k">if</span> <span class="n">Crop_PlantMethod</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">ProtectedSeed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Crop is transplanted so no protection</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">ProtectedSeed</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Increment delayed growth time counters if germination is yet to</span>
            <span class="c1"># occur, and also set seed protection to False if yet to germinate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">DelayedCDs</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedGDDs</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">DelayedGDDs</span> <span class="o">+</span> <span class="n">GDD</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">ProtectedSeed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Not in growing season so no germination calculation is performed.</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">Germination</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">ProtectedSeed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedGDDs</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">NewCond</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.groundwater_inflow" class="doc doc-heading">
<code class="highlight language-python"><span class="n">groundwater_inflow</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">NewCond</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate capillary rise in the presence of a shallow groundwater table</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=61" target="_blank">Reference Manual: capillary rise calculations</a> (pg. 52-61)</p>
<p><em>Arguments:</em></p>
<p><code>Soil</code>: <code>SoilClass</code> : Soil object containing soil paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>GwIn</code>: <code>float</code> : Groundwater inflow</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">groundwater_inflow</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">NewCond</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate capillary rise in the presence of a shallow groundwater table</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=61&quot; target=&quot;_blank&quot;&gt;Reference Manual: capillary rise calculations&lt;/a&gt; (pg. 52-61)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `Soil`: `SoilClass` : Soil object containing soil paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `GwIn`: `float` : Groundwater inflow</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions for updating ##</span>
    <span class="n">GwIn</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">## Perform calculations ##</span>
    <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">WTinSoil</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Water table in soil profile. Calculate horizontal inflow.</span>
        <span class="c1"># Get groundwater table elevation on current day</span>
        <span class="n">zGW</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">zGW</span>

        <span class="c1"># Find compartment mid-points</span>
        <span class="n">zMid</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">zMid</span>
        <span class="c1"># For compartments below water table, set to saturation #</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">zMid</span> <span class="o">&gt;=</span> <span class="n">zGW</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Comp</span><span class="p">)):</span>
            <span class="c1"># Get soil layer</span>
            <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                <span class="c1"># Update water content</span>
                <span class="n">dth</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="c1"># Update groundwater inflow</span>
                <span class="n">GwIn</span> <span class="o">=</span> <span class="n">GwIn</span> <span class="o">+</span> <span class="p">(</span><span class="n">dth</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">NewCond</span><span class="p">,</span> <span class="n">GwIn</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.growing_degree_day" class="doc doc-heading">
<code class="highlight language-python"><span class="n">growing_degree_day</span><span class="p">(</span><span class="n">GDDmethod</span><span class="p">,</span> <span class="n">Tupp</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">,</span> <span class="n">Tmin</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate number of growing degree days on current day</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=28" target="_blank">Reference manual: growing degree day calculations</a> (pg. 19-20)</p>
<p><em>Arguments:</em></p>
<p><code>GDDmethod</code>: <code>int</code> : GDD calculation method</p>
<p><code>Tupp</code>: <code>float</code> : Upper temperature (degC) above which crop development no longer increases</p>
<p><code>Tbase</code>: <code>float</code> : Base temperature (degC) below which growth does not progress</p>
<p><code>Tmax</code>: <code>float</code> : Maximum tempature on current day (celcius)</p>
<p><code>Tmin</code>: <code>float</code> : Minimum tempature on current day (celcius)</p>
<p><em>Returns:</em></p>
<p><code>GDD</code>: <code>float</code> : Growing degree days for current day</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_growing_degree_day&quot;</span><span class="p">,</span> <span class="s2">&quot;f8(i4,f8,f8,f8,f8)&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">growing_degree_day</span><span class="p">(</span><span class="n">GDDmethod</span><span class="p">,</span> <span class="n">Tupp</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">,</span> <span class="n">Tmin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate number of growing degree days on current day</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=28&quot; target=&quot;_blank&quot;&gt;Reference manual: growing degree day calculations&lt;/a&gt; (pg. 19-20)</span>



<span class="sd">    *Arguments:*</span>

<span class="sd">    `GDDmethod`: `int` : GDD calculation method</span>

<span class="sd">    `Tupp`: `float` : Upper temperature (degC) above which crop development no longer increases</span>

<span class="sd">    `Tbase`: `float` : Base temperature (degC) below which growth does not progress</span>

<span class="sd">    `Tmax`: `float` : Maximum tempature on current day (celcius)</span>

<span class="sd">    `Tmin`: `float` : Minimum tempature on current day (celcius)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `GDD`: `float` : Growing degree days for current day</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Calculate GDDs ##</span>
    <span class="k">if</span> <span class="n">GDDmethod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Method 1</span>
        <span class="n">Tmean</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tmax</span> <span class="o">+</span> <span class="n">Tmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">Tmean</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Tmean</span><span class="p">,</span> <span class="n">Tupp</span><span class="p">)</span>
        <span class="n">Tmean</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tmean</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">)</span>
        <span class="n">GDD</span> <span class="o">=</span> <span class="n">Tmean</span> <span class="o">-</span> <span class="n">Tbase</span>
    <span class="k">elif</span> <span class="n">GDDmethod</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Method 2</span>
        <span class="n">Tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Tmax</span><span class="p">,</span> <span class="n">Tupp</span><span class="p">)</span>
        <span class="n">Tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tmax</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">)</span>

        <span class="n">Tmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Tmin</span><span class="p">,</span> <span class="n">Tupp</span><span class="p">)</span>
        <span class="n">Tmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tmin</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">)</span>

        <span class="n">Tmean</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tmax</span> <span class="o">+</span> <span class="n">Tmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">GDD</span> <span class="o">=</span> <span class="n">Tmean</span> <span class="o">-</span> <span class="n">Tbase</span>
    <span class="k">elif</span> <span class="n">GDDmethod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Method 3</span>
        <span class="n">Tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Tmax</span><span class="p">,</span> <span class="n">Tupp</span><span class="p">)</span>
        <span class="n">Tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tmax</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">)</span>

        <span class="n">Tmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Tmin</span><span class="p">,</span> <span class="n">Tupp</span><span class="p">)</span>
        <span class="n">Tmean</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tmax</span> <span class="o">+</span> <span class="n">Tmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">Tmean</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tmean</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">)</span>
        <span class="n">GDD</span> <span class="o">=</span> <span class="n">Tmean</span> <span class="o">-</span> <span class="n">Tbase</span>

    <span class="k">return</span> <span class="n">GDD</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.growth_stage" class="doc doc-heading">
<code class="highlight language-python"><span class="n">growth_stage</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to determine current growth stage of crop</p>
<p>(used only for irrigation soil moisture thresholds)</p>
<p><em>Arguments:</em></p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is growing season (True or Flase)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">growth_stage</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to determine current growth stage of crop</span>

<span class="sd">    (used only for irrigation soil moisture thresholds)</span>

<span class="sd">    *Arguments:*</span>



<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `GrowingSeason`:: `bool` : is growing season (True or Flase)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>





<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions in new structure for updating ##</span>
    <span class="n">NewCond</span> <span class="o">=</span> <span class="n">InitCond</span>

    <span class="c1">## Get growth stage (if in growing season) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Adjust time for any delayed growth</span>
        <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tAdj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DAP</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span>
        <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tAdj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">GDDcum</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedGDDs</span>

        <span class="c1"># Update growth stage</span>
        <span class="k">if</span> <span class="n">tAdj</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Canopy10Pct</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">GrowthStage</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">tAdj</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">MaxCanopy</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">GrowthStage</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">tAdj</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">GrowthStage</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">tAdj</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Senescence</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">GrowthStage</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Not in growing season so growth stage is set to dummy value</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">GrowthStage</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">NewCond</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.harvest_index" class="doc doc-heading">
<code class="highlight language-python"><span class="n">harvest_index</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">,</span> <span class="n">Tmin</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to simulate build up of harvest index</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=119" target="_blank">Reference Manual: harvest index calculations</a> (pg. 110-126)</p>
<p><em>Arguments:</em></p>
<p><code>Soil</code>: <code>SoilClass</code> : Soil object containing soil paramaters</p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Et0</code>: <code>float</code> : reference evapotranspiration on current day</p>
<p><code>Tmax</code>: <code>float</code> : maximum tempature on current day (celcius)</p>
<p><code>Tmin</code>: <code>float</code> : minimum tempature on current day (celcius)</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is growing season (True or Flase)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">harvest_index</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">,</span> <span class="n">Tmin</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to simulate build up of harvest index</span>


<span class="sd">     &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=119&quot; target=&quot;_blank&quot;&gt;Reference Manual: harvest index calculations&lt;/a&gt; (pg. 110-126)</span>

<span class="sd">    *Arguments:*</span>


<span class="sd">    `Soil`: `SoilClass` : Soil object containing soil paramaters</span>

<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Et0`: `float` : reference evapotranspiration on current day</span>

<span class="sd">    `Tmax`: `float` : maximum tempature on current day (celcius)</span>

<span class="sd">    `Tmin`: `float` : minimum tempature on current day (celcius)</span>

<span class="sd">    `GrowingSeason`:: `bool` : is growing season (True or Flase)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions for updating ##</span>
    <span class="n">NewCond</span> <span class="o">=</span> <span class="n">InitCond</span>

    <span class="n">InitCond_HI</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">HI</span>
    <span class="n">InitCond_HIadj</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">HIadj</span>
    <span class="n">InitCond_PreAdj</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">PreAdj</span>

    <span class="c1">## Calculate harvest index build up (if in growing season) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Calculate root zone water content</span>

        <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAWClass</span><span class="p">()</span>
        <span class="n">Dr</span> <span class="o">=</span> <span class="n">DrClass</span><span class="p">()</span>
        <span class="c1"># thRZ = thRZClass()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span> <span class="o">=</span> <span class="n">_root_zone_water</span><span class="p">(</span>
            <span class="n">prof</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">Zroot</span><span class="p">),</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">,</span>
            <span class="n">Soil_zTop</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">),</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">Aer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># _,Dr,TAW,_ = root_zone_water(Soil_Profile,float(NewCond.Zroot),NewCond.th,Soil_zTop,float(Crop.Zmin),Crop.Aer)</span>
        <span class="c1"># Check whether to use root zone or top soil depletions for calculating</span>
        <span class="c1"># water stress</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span> <span class="o">/</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span> <span class="o">/</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span><span class="p">):</span>
            <span class="c1"># Root zone is wetter than top soil, so use root zone value</span>
            <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span>
            <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Top soil is wetter than root zone, so use top soil values</span>
            <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span>
            <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span>

        <span class="c1"># Calculate water stress</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Ksw = water_stress(Crop, NewCond, Dr, TAW, Et0, beta)</span>
        <span class="c1"># Ksw = KswClass()</span>
        <span class="n">Ksw_Exp</span><span class="p">,</span> <span class="n">Ksw_Sto</span><span class="p">,</span> <span class="n">Ksw_Sen</span><span class="p">,</span> <span class="n">Ksw_Pol</span><span class="p">,</span> <span class="n">Ksw_StoLin</span> <span class="o">=</span> <span class="n">_water_stress</span><span class="p">(</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">p_lo</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">ETadj</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">,</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">tEarlySen</span><span class="p">,</span>
            <span class="n">Dr</span><span class="p">,</span>
            <span class="n">TAW</span><span class="p">,</span>
            <span class="n">Et0</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Ksw</span> <span class="o">=</span> <span class="n">KswNT</span><span class="p">(</span><span class="n">Exp</span><span class="o">=</span><span class="n">Ksw_Exp</span><span class="p">,</span> <span class="n">Sto</span><span class="o">=</span><span class="n">Ksw_Sto</span><span class="p">,</span> <span class="n">Sen</span><span class="o">=</span><span class="n">Ksw_Sen</span><span class="p">,</span> <span class="n">Pol</span><span class="o">=</span><span class="n">Ksw_Pol</span><span class="p">,</span> <span class="n">StoLin</span><span class="o">=</span><span class="n">Ksw_StoLin</span> <span class="p">)</span>
        <span class="c1"># Calculate temperature stress</span>
        <span class="p">(</span><span class="n">Kst_PolH</span><span class="p">,</span><span class="n">Kst_PolC</span><span class="p">)</span> <span class="o">=</span> <span class="n">_temperature_stress</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">,</span> <span class="n">Tmin</span><span class="p">)</span>
        <span class="n">Kst</span> <span class="o">=</span> <span class="n">KstNT</span><span class="p">(</span><span class="n">PolH</span><span class="o">=</span><span class="n">Kst_PolH</span><span class="p">,</span><span class="n">PolC</span><span class="o">=</span><span class="n">Kst_PolC</span><span class="p">)</span>
        <span class="c1"># Get reference harvest index on current day</span>
        <span class="n">HIi</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">HIref</span>

        <span class="c1"># Get time for harvest index build-up</span>
        <span class="n">HIt</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DAP</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HIstartCD</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Calculate harvest index</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">YieldForm</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">HIt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># print(NewCond.DAP)</span>
            <span class="c1"># Root/tuber or fruit/grain crops</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="c1"># Detemine adjustment for water stress before anthesis</span>
                <span class="k">if</span> <span class="n">InitCond_PreAdj</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">InitCond</span><span class="o">.</span><span class="n">PreAdj</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpre</span> <span class="o">=</span> <span class="n">_HIadj_pre_anthesis</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">B</span><span class="p">,</span>
                                                <span class="n">NewCond</span><span class="o">.</span><span class="n">B_NS</span><span class="p">,</span>
                                                <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span><span class="p">,</span>
                                                <span class="n">Crop</span><span class="o">.</span><span class="n">dHI_pre</span><span class="p">)</span>

                <span class="c1"># Determine adjustment for crop pollination failure</span>
                <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Adjustment only for fruit/grain crops</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">HIt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">HIt</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">FloweringCD</span><span class="p">):</span>

                        <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpol</span> <span class="o">=</span> <span class="n">_HIadj_pollination</span><span class="p">(</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span><span class="p">,</span>
                            <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpol</span><span class="p">,</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">FloweringCD</span><span class="p">,</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">CCmin</span><span class="p">,</span>
                            <span class="n">Crop</span><span class="o">.</span><span class="n">exc</span><span class="p">,</span>
                            <span class="n">Ksw</span><span class="p">,</span>
                            <span class="n">Kst</span><span class="p">,</span>
                            <span class="n">HIt</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">HImax</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpol</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No pollination adjustment for root/tuber crops</span>
                    <span class="n">HImax</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">HI0</span>

                <span class="c1"># Determine adjustments for post-anthesis water stress</span>
                <span class="k">if</span> <span class="n">HIt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">sCor1</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">sCor2</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">fpost_upp</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">fpost_dwn</span><span class="p">,</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpost</span><span class="p">)</span> <span class="o">=</span> <span class="n">_HIadj_post_anthesis</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span><span class="p">,</span>
                                                        <span class="n">NewCond</span><span class="o">.</span><span class="n">sCor1</span><span class="p">,</span>
                                                        <span class="n">NewCond</span><span class="o">.</span><span class="n">sCor2</span><span class="p">,</span>
                                                        <span class="n">NewCond</span><span class="o">.</span><span class="n">DAP</span><span class="p">,</span>
                                                        <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpre</span><span class="p">,</span>
                                                        <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span><span class="p">,</span>
                                                        <span class="n">NewCond</span><span class="o">.</span><span class="n">fpost_upp</span><span class="p">,</span>
                                                        <span class="n">NewCond</span><span class="o">.</span><span class="n">fpost_dwn</span><span class="p">,</span>
                                                        <span class="n">Crop</span><span class="p">,</span> 
                                                        <span class="n">Ksw</span><span class="p">)</span>

                <span class="c1"># Limit HI to maximum allowable increase due to pre- and</span>
                <span class="c1"># post-anthesis water stress combinations</span>
                <span class="n">HImult</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpre</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">Fpost</span>
                <span class="k">if</span> <span class="n">HImult</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">dHI0</span> <span class="o">/</span> <span class="mi">100</span><span class="p">):</span>
                    <span class="n">HImult</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">dHI0</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

                <span class="c1"># Determine harvest index on current day, adjusted for stress</span>
                <span class="c1"># effects</span>
                <span class="k">if</span> <span class="n">HImax</span> <span class="o">&gt;=</span> <span class="n">HIi</span><span class="p">:</span>
                    <span class="n">HIadj</span> <span class="o">=</span> <span class="n">HImult</span> <span class="o">*</span> <span class="n">HIi</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">HIadj</span> <span class="o">=</span> <span class="n">HImult</span> <span class="o">*</span> <span class="n">HImax</span>

            <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CropType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Leafy vegetable crops - no adjustment, harvest index equal to</span>
                <span class="c1"># reference value for current day</span>
                <span class="n">HIadj</span> <span class="o">=</span> <span class="n">HIi</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># No build-up of harvest index if outside yield formation period</span>
            <span class="n">HIi</span> <span class="o">=</span> <span class="n">InitCond_HI</span>
            <span class="n">HIadj</span> <span class="o">=</span> <span class="n">InitCond_HIadj</span>

        <span class="c1"># Store final values for current time step</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">HI</span> <span class="o">=</span> <span class="n">HIi</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">HIadj</span> <span class="o">=</span> <span class="n">HIadj</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No harvestable crop outside of a growing season</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">HI</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">HIadj</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># print([NewCond.DAP , Crop.YldFormCD])</span>
    <span class="k">return</span> <span class="n">NewCond</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.infiltration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">infiltration</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">NewCond_SurfaceStorage</span><span class="p">,</span> <span class="n">NewCond_th_fc_Adj</span><span class="p">,</span> <span class="n">NewCond_th</span><span class="p">,</span> <span class="n">Infl</span><span class="p">,</span> <span class="n">Irr</span><span class="p">,</span> <span class="n">IrrMngt_AppEff</span><span class="p">,</span> <span class="n">FieldMngt_Bunds</span><span class="p">,</span> <span class="n">FieldMngt_zBund</span><span class="p">,</span> <span class="n">FluxOut</span><span class="p">,</span> <span class="n">DeepPerc0</span><span class="p">,</span> <span class="n">Runoff0</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to infiltrate incoming water (rainfall and irrigation)</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=51" target="_blank">Reference Manual: drainage calculations</a> (pg. 42-65)</p>
<p><em>Arguments:</em></p>
<p><code>prof</code>: <code>SoilProfileClass</code> : Soil object containing soil paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Infl</code>: <code>float</code> : Infiltration so far</p>
<p><code>Irr</code>: <code>float</code> : Irrigation on current day</p>
<p><code>IrrMngt_AppEff</code>: <code>float</code>: irrigation application efficiency</p>
<p><code>FieldMngt</code>: <code>FieldMngtStruct</code> : field management params</p>
<p><code>FluxOut</code>: <code>np.array</code> : flux of water out of each compartment</p>
<p><code>DeepPerc0</code>: <code>float</code> : initial Deep Percolation</p>
<p><code>Runoff0</code>: <code>float</code> : initial Surface Runoff</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is growing season (True or Flase)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>DeepPerc</code>:: <code>float</code> : Total Deep Percolation</p>
<p><code>RunoffTot</code>: <code>float</code> : Total surface Runoff</p>
<p><code>Infl</code>: <code>float</code> : Infiltration on current day</p>
<p><code>FluxOut</code>: <code>np.array</code> : flux of water out of each compartment</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_infiltration&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SoilProfileNT_typ_sig</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">infiltration</span><span class="p">(</span>
     <span class="n">prof</span><span class="p">,</span>
     <span class="n">NewCond_SurfaceStorage</span><span class="p">,</span> 
     <span class="n">NewCond_th_fc_Adj</span><span class="p">,</span> 
     <span class="n">NewCond_th</span><span class="p">,</span> 
     <span class="n">Infl</span><span class="p">,</span> 
     <span class="n">Irr</span><span class="p">,</span> 
     <span class="n">IrrMngt_AppEff</span><span class="p">,</span> 
     <span class="n">FieldMngt_Bunds</span><span class="p">,</span>
     <span class="n">FieldMngt_zBund</span><span class="p">,</span>
     <span class="n">FluxOut</span><span class="p">,</span> 
     <span class="n">DeepPerc0</span><span class="p">,</span> 
     <span class="n">Runoff0</span><span class="p">,</span> 
     <span class="n">GrowingSeason</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to infiltrate incoming water (rainfall and irrigation)</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=51&quot; target=&quot;_blank&quot;&gt;Reference Manual: drainage calculations&lt;/a&gt; (pg. 42-65)</span>



<span class="sd">    *Arguments:*</span>



<span class="sd">    `prof`: `SoilProfileClass` : Soil object containing soil paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Infl`: `float` : Infiltration so far</span>

<span class="sd">    `Irr`: `float` : Irrigation on current day</span>

<span class="sd">    `IrrMngt_AppEff`: `float`: irrigation application efficiency</span>

<span class="sd">    `FieldMngt`: `FieldMngtStruct` : field management params</span>

<span class="sd">    `FluxOut`: `np.array` : flux of water out of each compartment</span>

<span class="sd">    `DeepPerc0`: `float` : initial Deep Percolation</span>

<span class="sd">    `Runoff0`: `float` : initial Surface Runoff</span>

<span class="sd">    `GrowingSeason`:: `bool` : is growing season (True or Flase)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `DeepPerc`:: `float` : Total Deep Percolation</span>

<span class="sd">    `RunoffTot`: `float` : Total surface Runoff</span>

<span class="sd">    `Infl`: `float` : Infiltration on current day</span>

<span class="sd">    `FluxOut`: `np.array` : flux of water out of each compartment</span>




<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## Store initial conditions in new structure for updating ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="n">InitCond_SurfaceStorage</span> <span class="o">=</span> <span class="n">NewCond_SurfaceStorage</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">InitCond_th_fc_Adj</span> <span class="o">=</span> <span class="n">NewCond_th_fc_Adj</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">InitCond_th</span> <span class="o">=</span> <span class="n">NewCond_th</span><span class="o">*</span><span class="mi">1</span>

    <span class="n">thnew</span> <span class="o">=</span> <span class="n">NewCond_th</span><span class="o">*</span><span class="mf">1.</span>

    <span class="n">Soil_nComp</span> <span class="o">=</span> <span class="n">thnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">## Update infiltration rate for irrigation ##</span>
    <span class="c1"># Note: irrigation amount adjusted for specified application efficiency</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">Infl</span> <span class="o">=</span> <span class="n">Infl</span> <span class="o">+</span> <span class="p">(</span><span class="n">Irr</span> <span class="o">*</span> <span class="p">(</span><span class="n">IrrMngt_AppEff</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">Infl</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="c1">## Determine surface storage (if bunds are present) ##</span>
    <span class="k">if</span> <span class="n">FieldMngt_Bunds</span><span class="p">:</span>
        <span class="c1"># Bunds on field</span>
        <span class="k">if</span> <span class="n">FieldMngt_zBund</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="c1"># Bund height too small to be considered</span>
            <span class="n">InflTot</span> <span class="o">=</span> <span class="n">Infl</span> <span class="o">+</span> <span class="n">NewCond_SurfaceStorage</span>
            <span class="k">if</span> <span class="n">InflTot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Update surface storage and infiltration storage</span>
                <span class="k">if</span> <span class="n">InflTot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># Infiltration limited by saturated hydraulic conductivity</span>
                    <span class="c1"># of surface soil layer</span>
                    <span class="n">ToStore</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Additional water ponds on surface</span>
                    <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="n">InflTot</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All water infiltrates</span>
                    <span class="n">ToStore</span> <span class="o">=</span> <span class="n">InflTot</span>
                    <span class="c1"># Reset surface storage depth to zero</span>
                    <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Calculate additional runoff</span>
                <span class="k">if</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">FieldMngt_zBund</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">):</span>
                    <span class="c1"># Water overtops bunds and runs off</span>
                    <span class="n">RunoffIni</span> <span class="o">=</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">-</span> <span class="p">(</span><span class="n">FieldMngt_zBund</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
                    <span class="c1"># Surface storage equal to bund height</span>
                    <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="n">FieldMngt_zBund</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No overtopping of bunds</span>
                    <span class="n">RunoffIni</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No storage or runoff</span>
                <span class="n">ToStore</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">RunoffIni</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">FieldMngt_Bunds</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># No bunds on field</span>
        <span class="k">if</span> <span class="n">Infl</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># Infiltration limited by saturated hydraulic conductivity of top</span>
            <span class="c1"># soil layer</span>
            <span class="n">ToStore</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Additional water runs off</span>
            <span class="n">RunoffIni</span> <span class="o">=</span> <span class="n">Infl</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># All water infiltrates</span>
            <span class="n">ToStore</span> <span class="o">=</span> <span class="n">Infl</span>
            <span class="n">RunoffIni</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Update surface storage</span>
        <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Add any water remaining behind bunds to surface runoff (needed for</span>
        <span class="c1"># days when bunds are removed to maintain water balance)</span>
        <span class="n">RunoffIni</span> <span class="o">=</span> <span class="n">RunoffIni</span> <span class="o">+</span> <span class="n">InitCond_SurfaceStorage</span>

    <span class="c1">## Initialise counters</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">Runoff</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">## Infiltrate incoming water ##</span>
    <span class="k">if</span> <span class="n">ToStore</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">ToStore</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;</span> <span class="n">Soil_nComp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Update compartment counter</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># Get soil layer</span>

            <span class="c1"># Calculate saturated drainage ability</span>
            <span class="n">dthdtS</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="c1"># Calculate drainage factor</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">dthdtS</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

            <span class="c1"># Calculate drainage ability required</span>
            <span class="n">dthdt0</span> <span class="o">=</span> <span class="n">ToStore</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

            <span class="c1"># Check drainage ability</span>
            <span class="k">if</span> <span class="n">dthdt0</span> <span class="o">&lt;</span> <span class="n">dthdtS</span><span class="p">:</span>
                <span class="c1"># Calculate water content, thX, needed to meet drainage dthdt0</span>
                <span class="k">if</span> <span class="n">dthdt0</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">theta0</span> <span class="o">=</span> <span class="n">InitCond_th_fc_Adj</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">dthdt0</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                    <span class="p">)</span>

                    <span class="n">theta0</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

                <span class="c1"># Limit thX to between saturation and field capacity</span>
                <span class="k">if</span> <span class="n">theta0</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                    <span class="n">theta0</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">theta0</span> <span class="o">&lt;=</span> <span class="n">InitCond_th_fc_Adj</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                    <span class="n">theta0</span> <span class="o">=</span> <span class="n">InitCond_th_fc_Adj</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="n">dthdt0</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Limit water content and drainage to saturation</span>
                <span class="n">theta0</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">dthdt0</span> <span class="o">=</span> <span class="n">dthdtS</span>

            <span class="c1"># Calculate maximum water flow through compartment ii</span>
            <span class="n">drainmax</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">dthdt0</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="c1"># Calculate total drainage from compartment ii</span>
            <span class="n">drainage</span> <span class="o">=</span> <span class="n">drainmax</span> <span class="o">+</span> <span class="n">FluxOut</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="c1"># Limit drainage to saturated hydraulic conductivity</span>
            <span class="k">if</span> <span class="n">drainage</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                <span class="n">drainmax</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">Ksat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">FluxOut</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

            <span class="c1"># Calculate difference between threshold and current water contents</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">theta0</span> <span class="o">-</span> <span class="n">InitCond_th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Increase water content of compartment ii</span>
                <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ToStore</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">theta0</span><span class="p">:</span>
                    <span class="c1"># Water remaining that can infiltrate to compartments below</span>
                    <span class="n">ToStore</span> <span class="o">=</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="n">thnew</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All infiltrating water has been stored</span>
                    <span class="n">ToStore</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Update outflow from current compartment (drainage + infiltration</span>
            <span class="c1"># flows)</span>
            <span class="n">FluxOut</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">FluxOut</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">ToStore</span>

            <span class="c1"># Calculate back-up of water into compartments above</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">ToStore</span> <span class="o">-</span> <span class="n">drainmax</span>
            <span class="k">if</span> <span class="n">excess</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">excess</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Update water to store</span>
            <span class="n">ToStore</span> <span class="o">=</span> <span class="n">ToStore</span> <span class="o">-</span> <span class="n">excess</span>

            <span class="c1"># Redistribute excess to compartments above</span>
            <span class="k">if</span> <span class="n">excess</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">precomp</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">excess</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">precomp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># Keep storing in compartments above until soil surface is</span>
                    <span class="c1"># reached</span>
                    <span class="c1"># Update compartment counter</span>
                    <span class="n">precomp</span> <span class="o">=</span> <span class="n">precomp</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="c1"># Update layer number</span>

                    <span class="c1"># Update outflow from compartment</span>
                    <span class="n">FluxOut</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">FluxOut</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">-</span> <span class="n">excess</span>
                    <span class="c1"># Update water content</span>
                    <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">excess</span> <span class="o">/</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
                    <span class="c1"># Limit water content to saturation</span>
                    <span class="k">if</span> <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">precomp</span><span class="p">]:</span>
                        <span class="c1"># Update excess to store</span>
                        <span class="n">excess</span> <span class="o">=</span> <span class="p">(</span><span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">precomp</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span>
                        <span class="c1"># Set water content to saturation</span>
                        <span class="n">thnew</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">precomp</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># All excess stored</span>
                        <span class="n">excess</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">excess</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Any leftover water not stored becomes runoff</span>
                    <span class="n">Runoff</span> <span class="o">=</span> <span class="n">Runoff</span> <span class="o">+</span> <span class="n">excess</span>

        <span class="c1"># Infiltration left to store after bottom compartment becomes deep</span>
        <span class="c1"># percolation (mm)</span>
        <span class="n">DeepPerc</span> <span class="o">=</span> <span class="n">ToStore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No infiltration</span>
        <span class="n">DeepPerc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Runoff</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">## Update total runoff ##</span>
    <span class="n">Runoff</span> <span class="o">=</span> <span class="n">Runoff</span> <span class="o">+</span> <span class="n">RunoffIni</span>

    <span class="c1">## Update surface storage (if bunds are present) ##</span>
    <span class="k">if</span> <span class="n">Runoff</span> <span class="o">&gt;</span> <span class="n">RunoffIni</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">FieldMngt_Bunds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">FieldMngt_zBund</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="c1"># Increase surface storage</span>
                <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">+</span> <span class="p">(</span><span class="n">Runoff</span> <span class="o">-</span> <span class="n">RunoffIni</span><span class="p">)</span>
                <span class="c1"># Limit surface storage to bund height</span>
                <span class="k">if</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">FieldMngt_zBund</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">):</span>
                    <span class="c1"># Additonal water above top of bunds becomes runoff</span>
                    <span class="n">Runoff</span> <span class="o">=</span> <span class="n">RunoffIni</span> <span class="o">+</span> <span class="p">(</span><span class="n">NewCond_SurfaceStorage</span> <span class="o">-</span> <span class="p">(</span><span class="n">FieldMngt_zBund</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
                    <span class="c1"># Set surface storage to bund height</span>
                    <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="n">FieldMngt_zBund</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No additional overtopping of bunds</span>
                    <span class="n">Runoff</span> <span class="o">=</span> <span class="n">RunoffIni</span>

    <span class="c1">## Store updated water contents ##</span>
    <span class="n">NewCond_th</span> <span class="o">=</span> <span class="n">thnew</span>

    <span class="c1">## Update deep percolation, surface runoff, and infiltration values ##</span>
    <span class="n">DeepPerc</span> <span class="o">=</span> <span class="n">DeepPerc</span> <span class="o">+</span> <span class="n">DeepPerc0</span>
    <span class="n">Infl</span> <span class="o">=</span> <span class="n">Infl</span> <span class="o">-</span> <span class="n">Runoff</span>
    <span class="n">RunoffTot</span> <span class="o">=</span> <span class="n">Runoff</span> <span class="o">+</span> <span class="n">Runoff0</span>

    <span class="k">return</span> <span class="n">NewCond_th</span><span class="p">,</span><span class="n">NewCond_SurfaceStorage</span><span class="p">,</span> <span class="n">DeepPerc</span><span class="p">,</span> <span class="n">RunoffTot</span><span class="p">,</span> <span class="n">Infl</span><span class="p">,</span> <span class="n">FluxOut</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.irrigation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">irrigation</span><span class="p">(</span><span class="n">IrrMngt_IrrMethod</span><span class="p">,</span> <span class="n">IrrMngt_SMT</span><span class="p">,</span> <span class="n">IrrMngt_AppEff</span><span class="p">,</span> <span class="n">IrrMngt_MaxIrr</span><span class="p">,</span> <span class="n">IrrMngt_IrrInterval</span><span class="p">,</span> <span class="n">IrrMngt_Schedule</span><span class="p">,</span> <span class="n">IrrMngt_depth</span><span class="p">,</span> <span class="n">IrrMngt_MaxIrrSeason</span><span class="p">,</span> <span class="n">NewCond_GrowthStage</span><span class="p">,</span> <span class="n">NewCond_IrrCum</span><span class="p">,</span> <span class="n">NewCond_Epot</span><span class="p">,</span> <span class="n">NewCond_Tpot</span><span class="p">,</span> <span class="n">NewCond_Zroot</span><span class="p">,</span> <span class="n">NewCond_th</span><span class="p">,</span> <span class="n">NewCond_DAP</span><span class="p">,</span> <span class="n">NewCond_TimeStepCounter</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">,</span> <span class="n">Rain</span><span class="p">,</span> <span class="n">Runoff</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to get irrigation depth for current day</p>
<p><a href="../pdfs/ac_ref_man_1.pdf#page=40" target="_blank">Reference Manual: irrigation description</a> (pg. 31-32)</p>
<p><em>Arguments:</em></p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>IrrMngt</code>: <code>IrrMngtStruct</code>: jit class object containing irrigation management paramaters</p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><code>Soil</code>: <code>SoilClass</code> : Soil object containing soil paramaters</p>
<p><code>GrowingSeason</code>: <code>bool</code> : is growing season (True or Flase)</p>
<p><code>Rain</code>: <code>float</code> : daily precipitation mm</p>
<p><code>Runoff</code>: <code>float</code> : surface runoff on current day</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>Irr</code>: <code>float</code> : Irrigaiton applied on current day mm</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">irrigation</span><span class="p">(</span>
    <span class="n">IrrMngt_IrrMethod</span><span class="p">,</span>
    <span class="n">IrrMngt_SMT</span><span class="p">,</span>
    <span class="n">IrrMngt_AppEff</span><span class="p">,</span>
    <span class="n">IrrMngt_MaxIrr</span><span class="p">,</span>
    <span class="n">IrrMngt_IrrInterval</span><span class="p">,</span>
    <span class="n">IrrMngt_Schedule</span><span class="p">,</span>
    <span class="n">IrrMngt_depth</span><span class="p">,</span>
    <span class="n">IrrMngt_MaxIrrSeason</span><span class="p">,</span>
    <span class="n">NewCond_GrowthStage</span><span class="p">,</span>
    <span class="n">NewCond_IrrCum</span><span class="p">,</span>
    <span class="n">NewCond_Epot</span><span class="p">,</span>
    <span class="n">NewCond_Tpot</span><span class="p">,</span>
    <span class="n">NewCond_Zroot</span><span class="p">,</span>
    <span class="n">NewCond_th</span><span class="p">,</span>
    <span class="n">NewCond_DAP</span><span class="p">,</span>
    <span class="n">NewCond_TimeStepCounter</span><span class="p">,</span>
    <span class="n">Crop</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">,</span> <span class="n">Rain</span><span class="p">,</span> <span class="n">Runoff</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to get irrigation depth for current day</span>



<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_1.pdf#page=40&quot; target=&quot;_blank&quot;&gt;Reference Manual: irrigation description&lt;/a&gt; (pg. 31-32)</span>


<span class="sd">    *Arguments:*</span>


<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `IrrMngt`: `IrrMngtStruct`: jit class object containing irrigation management paramaters</span>

<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>

<span class="sd">    `Soil`: `SoilClass` : Soil object containing soil paramaters</span>

<span class="sd">    `GrowingSeason`: `bool` : is growing season (True or Flase)</span>

<span class="sd">    `Rain`: `float` : daily precipitation mm</span>

<span class="sd">    `Runoff`: `float` : surface runoff on current day</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `Irr`: `float` : Irrigaiton applied on current day mm</span>

<span class="sd">&quot;&quot;&quot;</span>
    <span class="c1">## Store intial conditions for updating ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="c1">## Determine irrigation depth (mm/day) to be applied ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Calculate root zone water content and depletion</span>
        <span class="c1"># TAW_ = TAWClass()</span>
        <span class="c1"># Dr_ = DrClass()</span>
        <span class="c1"># thRZ = thRZClass()</span>
        <span class="p">(</span>
            <span class="n">WrAct</span><span class="p">,</span>
            <span class="n">Dr_Zt</span><span class="p">,</span>
            <span class="n">Dr_Rz</span><span class="p">,</span>
            <span class="n">TAW_Zt</span><span class="p">,</span>
            <span class="n">TAW_Rz</span><span class="p">,</span>
            <span class="n">thRZ_Act</span><span class="p">,</span>
            <span class="n">thRZ_S</span><span class="p">,</span>
            <span class="n">thRZ_FC</span><span class="p">,</span>
            <span class="n">thRZ_WP</span><span class="p">,</span>
            <span class="n">thRZ_Dry</span><span class="p">,</span>
            <span class="n">thRZ_Aer</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_root_zone_water</span><span class="p">(</span>
            <span class="n">prof</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">NewCond_Zroot</span><span class="p">),</span>
            <span class="n">NewCond_th</span><span class="p">,</span>
            <span class="n">Soil_zTop</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">),</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">Aer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># WrAct,Dr_,TAW_,thRZ = root_zone_water(prof,float(NewCond.Zroot),NewCond.th,Soil_zTop,float(Crop.Zmin),Crop.Aer)</span>
        <span class="c1"># Use root zone depletions and TAW only for triggering irrigation</span>
        <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr_Rz</span>
        <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW_Rz</span>

        <span class="c1"># Determine adjustment for inflows and outflows on current day #</span>
        <span class="k">if</span> <span class="n">thRZ_Act</span> <span class="o">&gt;</span> <span class="n">thRZ_FC</span><span class="p">:</span>
            <span class="n">rootdepth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">NewCond_Zroot</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">)</span>
            <span class="n">AbvFc</span> <span class="o">=</span> <span class="p">(</span><span class="n">thRZ_Act</span> <span class="o">-</span> <span class="n">thRZ_FC</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">rootdepth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AbvFc</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">WCadj</span> <span class="o">=</span> <span class="n">NewCond_Tpot</span> <span class="o">+</span> <span class="n">NewCond_Epot</span> <span class="o">-</span> <span class="n">Rain</span> <span class="o">+</span> <span class="n">Runoff</span> <span class="o">-</span> <span class="n">AbvFc</span>

        <span class="n">NewCond_Depletion</span> <span class="o">=</span> <span class="n">Dr</span> <span class="o">+</span> <span class="n">WCadj</span>
        <span class="n">NewCond_TAW</span> <span class="o">=</span> <span class="n">TAW</span>

        <span class="c1"># Update growth stage if it is first day of a growing season</span>
        <span class="k">if</span> <span class="n">NewCond_DAP</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">NewCond_GrowthStage</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Irr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">Dr</span> <span class="o">=</span> <span class="n">NewCond_Depletion</span> <span class="o">/</span> <span class="n">NewCond_TAW</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">NewCond_GrowthStage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">Dr</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">IrrMngt_SMT</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">:</span>
                <span class="c1"># Irrigation occurs</span>
                <span class="n">IrrReq</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NewCond_Depletion</span><span class="p">)</span>
                <span class="c1"># Adjust irrigation requirements for application efficiency</span>
                <span class="n">EffAdj</span> <span class="o">=</span> <span class="p">((</span><span class="mi">100</span> <span class="o">-</span> <span class="n">IrrMngt_AppEff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
                <span class="n">IrrReq</span> <span class="o">=</span> <span class="n">IrrReq</span> <span class="o">*</span> <span class="n">EffAdj</span>
                <span class="c1"># Limit irrigation to maximum depth</span>
                <span class="n">Irr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">IrrMngt_MaxIrr</span><span class="p">,</span> <span class="n">IrrReq</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Irr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Irrigation - fixed interval</span>

            <span class="n">Dr</span> <span class="o">=</span> <span class="n">NewCond_Depletion</span>

            <span class="c1"># Get number of days in growing season so far (subtract 1 so that</span>
            <span class="c1"># always irrigate first on day 1 of each growing season)</span>
            <span class="n">nDays</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">nDays</span> <span class="o">%</span> <span class="n">IrrMngt_IrrInterval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Irrigation occurs</span>
                <span class="n">IrrReq</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Dr</span><span class="p">)</span>
                <span class="c1"># Adjust irrigation requirements for application efficiency</span>
                <span class="n">EffAdj</span> <span class="o">=</span> <span class="p">((</span><span class="mi">100</span> <span class="o">-</span> <span class="n">IrrMngt_AppEff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
                <span class="n">IrrReq</span> <span class="o">=</span> <span class="n">IrrReq</span> <span class="o">*</span> <span class="n">EffAdj</span>
                <span class="c1"># Limit irrigation to maximum depth</span>
                <span class="n">Irr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">IrrMngt_MaxIrr</span><span class="p">,</span> <span class="n">IrrReq</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No irrigation</span>
                <span class="n">Irr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Irrigation - pre-defined schedule</span>
            <span class="c1"># Get current date</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">NewCond_TimeStepCounter</span>
            <span class="c1"># Find irrigation value corresponding to current date</span>
            <span class="n">Irr</span> <span class="o">=</span> <span class="n">IrrMngt_Schedule</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="k">assert</span> <span class="n">Irr</span> <span class="o">&gt;=</span> <span class="mi">0</span>

            <span class="n">Irr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">IrrMngt_MaxIrr</span><span class="p">,</span> <span class="n">Irr</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Irrigation - net irrigation</span>
            <span class="c1"># Net irrigation calculation performed after transpiration, so</span>
            <span class="c1"># irrigation is zero here</span>

            <span class="n">Irr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># depth applied each day (usually specified outside of model)</span>

            <span class="n">Irr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">IrrMngt_MaxIrr</span><span class="p">,</span> <span class="n">IrrMngt_depth</span><span class="p">)</span>

        <span class="c1">#         else:</span>
        <span class="c1">#             assert 1 ==2, f&#39;somethings gone wrong in irrigation method:{IrrMngt.IrrMethod}&#39;</span>

        <span class="n">Irr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Irr</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># No irrigation outside growing season</span>
        <span class="n">Irr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">NewCond_IrrCum</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">NewCond_Depletion</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">NewCond_TAW</span> <span class="o">=</span> <span class="mf">0.</span>


    <span class="k">if</span> <span class="n">NewCond_IrrCum</span> <span class="o">+</span> <span class="n">Irr</span> <span class="o">&gt;</span> <span class="n">IrrMngt_MaxIrrSeason</span><span class="p">:</span>
        <span class="n">Irr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IrrMngt_MaxIrrSeason</span> <span class="o">-</span> <span class="n">NewCond_IrrCum</span><span class="p">)</span>

    <span class="c1"># Update cumulative irrigation counter for growing season</span>
    <span class="n">NewCond_IrrCum</span> <span class="o">=</span> <span class="n">NewCond_IrrCum</span> <span class="o">+</span> <span class="n">Irr</span>

    <span class="k">return</span> <span class="n">NewCond_Depletion</span><span class="p">,</span><span class="n">NewCond_TAW</span><span class="p">,</span><span class="n">NewCond_IrrCum</span><span class="p">,</span> <span class="n">Irr</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.pre_irrigation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">pre_irrigation</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">,</span> <span class="n">IrrMngt</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate pre-irrigation when in net irrigation mode</p>
<p><a href="../pdfs/ac_ref_man_1.pdf#page=40" target="_blank">Reference Manual: Net irrigation description</a> (pg. 31)</p>
<p><em>Arguments:</em></p>
<p><code>prof</code>: <code>SoilProfileClass</code> : Soil object containing soil paramaters</p>
<p><code>Crop</code>: <code>CropStruct</code> : Crop object containing Crop paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>GrowingSeason</code>: <code>bool</code> : is growing season (True or Flase)</p>
<p><code>IrrMngt</code>: <code>`IrrMngtStruct</code>  object containing irrigation management paramaters</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>PreIrr</code>: <code>float</code> : Pre-Irrigaiton applied on current day mm</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pre_irrigation</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">,</span> <span class="n">IrrMngt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate pre-irrigation when in net irrigation mode</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_1.pdf#page=40&quot; target=&quot;_blank&quot;&gt;Reference Manual: Net irrigation description&lt;/a&gt; (pg. 31)</span>


<span class="sd">    *Arguments:*</span>

<span class="sd">    `prof`: `SoilProfileClass` : Soil object containing soil paramaters</span>

<span class="sd">    `Crop`: `CropStruct` : Crop object containing Crop paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `GrowingSeason`: `bool` : is growing season (True or Flase)</span>

<span class="sd">    `IrrMngt`: ``IrrMngtStruct`  object containing irrigation management paramaters</span>



<span class="sd">    *Returns:*</span>

<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `PreIrr`: `float` : Pre-Irrigaiton applied on current day mm</span>




<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store initial conditions for updating ##</span>
    <span class="n">NewCond</span> <span class="o">=</span> <span class="n">InitCond</span>

    <span class="c1">## Calculate pre-irrigation needs ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IrrMngt</span><span class="o">.</span><span class="n">IrrMethod</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">DAP</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># No pre-irrigation as not in net irrigation mode or not on first day</span>
            <span class="c1"># of the growing season</span>
            <span class="n">PreIrr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Determine compartments covered by the root zone</span>
            <span class="n">rootdepth</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">Zroot</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">compRz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&gt;=</span> <span class="n">rootdepth</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">PreIrr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">compRz</span><span class="p">)):</span>

                <span class="c1"># Determine critical water content threshold</span>
                <span class="n">thCrit</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">IrrMngt</span><span class="o">.</span><span class="n">NetIrrSMT</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="p">)</span>

                <span class="c1"># Check if pre-irrigation is required</span>
                <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thCrit</span><span class="p">:</span>
                    <span class="n">PreIrr</span> <span class="o">=</span> <span class="n">PreIrr</span> <span class="o">+</span> <span class="p">((</span><span class="n">thCrit</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">thCrit</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">PreIrr</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">NewCond</span><span class="p">,</span> <span class="n">PreIrr</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.rainfall_partition" class="doc doc-heading">
<code class="highlight language-python"><span class="n">rainfall_partition</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">InitCond_th</span><span class="p">,</span> <span class="n">NewCond_DaySubmerged</span><span class="p">,</span> <span class="n">FieldMngt_SRinhb</span><span class="p">,</span> <span class="n">FieldMngt_Bunds</span><span class="p">,</span> <span class="n">FieldMngt_zBund</span><span class="p">,</span> <span class="n">FieldMngt_CNadjPct</span><span class="p">,</span> <span class="n">Soil_CN</span><span class="p">,</span> <span class="n">Soil_AdjCN</span><span class="p">,</span> <span class="n">Soil_zCN</span><span class="p">,</span> <span class="n">Soil_nComp</span><span class="p">,</span> <span class="n">prof</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to partition rainfall into surface runoff and infiltration using the curve number approach</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=57" target="_blank">Reference Manual: rainfall partition calculations</a> (pg. 48-51)</p>
<p><em>Arguments:</em></p>
<p><code>P</code>: <code>float</code> : Percipitation on current day</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>FieldMngt</code>: <code>FieldMngtStruct</code> : field management params</p>
<p><code>Soil_CN</code>: <code>float</code> : curve number</p>
<p><code>Soil_AdjCN</code>: <code>float</code> : adjusted curve number</p>
<p><code>Soil_zCN</code>: <code>float</code> :</p>
<p><code>Soil_nComp</code>: <code>float</code> : number of compartments</p>
<p><code>prof</code>: <code>SoilProfileClass</code> : Soil object</p>
<p><em>Returns:</em></p>
<p><code>Runoff</code>: <code>float</code> : Total Suface Runoff</p>
<p><code>Infl</code>: <code>float</code> : Total Infiltration</p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_rainfall_partition&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">SoilProfileNT_typ_sig</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">rainfall_partition</span><span class="p">(</span>
    <span class="n">P</span><span class="p">,</span>
    <span class="n">InitCond_th</span><span class="p">,</span>
    <span class="n">NewCond_DaySubmerged</span><span class="p">,</span>
    <span class="n">FieldMngt_SRinhb</span><span class="p">,</span>
    <span class="n">FieldMngt_Bunds</span><span class="p">,</span>
    <span class="n">FieldMngt_zBund</span><span class="p">,</span>
    <span class="n">FieldMngt_CNadjPct</span><span class="p">,</span>
    <span class="n">Soil_CN</span><span class="p">,</span>
    <span class="n">Soil_AdjCN</span><span class="p">,</span>
    <span class="n">Soil_zCN</span><span class="p">,</span>
    <span class="n">Soil_nComp</span><span class="p">,</span>
    <span class="n">prof</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to partition rainfall into surface runoff and infiltration using the curve number approach</span>


<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=57&quot; target=&quot;_blank&quot;&gt;Reference Manual: rainfall partition calculations&lt;/a&gt; (pg. 48-51)</span>



<span class="sd">    *Arguments:*</span>


<span class="sd">    `P`: `float` : Percipitation on current day</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `FieldMngt`: `FieldMngtStruct` : field management params</span>

<span class="sd">    `Soil_CN`: `float` : curve number</span>

<span class="sd">    `Soil_AdjCN`: `float` : adjusted curve number</span>

<span class="sd">    `Soil_zCN`: `float` :</span>

<span class="sd">    `Soil_nComp`: `float` : number of compartments</span>

<span class="sd">    `prof`: `SoilProfileClass` : Soil object</span>


<span class="sd">    *Returns:*</span>

<span class="sd">    `Runoff`: `float` : Total Suface Runoff</span>

<span class="sd">    `Infl`: `float` : Total Infiltration</span>

<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>






<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># can probs make this faster by doing a if P=0 loop</span>

    <span class="c1">## Store initial conditions for updating ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="c1">## Calculate runoff ##</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FieldMngt_SRinhb</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">FieldMngt_Bunds</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">FieldMngt_zBund</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">)):</span>
        <span class="c1"># Surface runoff is not inhibited and no soil bunds are on field</span>
        <span class="c1"># Reset submerged days</span>
        <span class="n">NewCond_DaySubmerged</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Adjust curve number for field management practices</span>
        <span class="n">CN</span> <span class="o">=</span> <span class="n">Soil_CN</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">FieldMngt_CNadjPct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">Soil_AdjCN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Adjust CN for antecedent moisture</span>
            <span class="c1"># Calculate upper and lowe curve number bounds</span>
            <span class="n">CNbot</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                <span class="mf">1.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">0.507</span> <span class="o">*</span> <span class="n">CN</span><span class="p">)</span>
                <span class="o">-</span> <span class="p">(</span><span class="mf">0.00374</span> <span class="o">*</span> <span class="n">CN</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">0.0000867</span> <span class="o">*</span> <span class="n">CN</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">CNtop</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                <span class="mf">5.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">2.33</span> <span class="o">*</span> <span class="n">CN</span><span class="p">)</span>
                <span class="o">-</span> <span class="p">(</span><span class="mf">0.0209</span> <span class="o">*</span> <span class="n">CN</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">0.000076</span> <span class="o">*</span> <span class="n">CN</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Check which compartment cover depth of top soil used to adjust</span>
            <span class="c1"># curve number</span>
            <span class="n">comp_sto_array</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&gt;=</span> <span class="n">Soil_zCN</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">comp_sto_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">comp_sto</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Soil_nComp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp_sto</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Soil_nComp</span> <span class="o">-</span> <span class="n">comp_sto_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Calculate weighting factors by compartment</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">wrel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Soil_zCN</span><span class="p">:</span>
                    <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">Soil_zCN</span>

                <span class="n">wx</span> <span class="o">=</span> <span class="mf">1.016</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">4.16</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="n">Soil_zCN</span><span class="p">)))</span>
                <span class="n">wrel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">wx</span> <span class="o">-</span> <span class="n">xx</span>
                <span class="k">if</span> <span class="n">wrel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">wrel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">wrel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">wrel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">xx</span> <span class="o">=</span> <span class="n">wx</span>

            <span class="c1"># Calculate relative wetness of top soil</span>
            <span class="n">wet_top</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># prof = prof</span>

            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">):</span>
                <span class="n">th</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">InitCond_th</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">wet_top</span> <span class="o">=</span> <span class="n">wet_top</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="n">wrel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">th</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                <span class="p">)</span>

            <span class="c1"># Calculate adjusted curve number</span>
            <span class="k">if</span> <span class="n">wet_top</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">wet_top</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">wet_top</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">wet_top</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">CN</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">CNbot</span> <span class="o">+</span> <span class="p">(</span><span class="n">CNtop</span> <span class="o">-</span> <span class="n">CNbot</span><span class="p">)</span> <span class="o">*</span> <span class="n">wet_top</span><span class="p">)</span>

        <span class="c1"># Partition rainfall into runoff and infiltration (mm)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25400</span> <span class="o">/</span> <span class="n">CN</span><span class="p">)</span> <span class="o">-</span> <span class="mi">254</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="p">((</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Runoff</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">Infl</span> <span class="o">=</span> <span class="n">P</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Runoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">term</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">P</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span>
            <span class="n">Infl</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">Runoff</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Bunds on field, therefore no surface runoff</span>
        <span class="n">Runoff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Infl</span> <span class="o">=</span> <span class="n">P</span>

    <span class="k">return</span> <span class="n">Runoff</span><span class="p">,</span> <span class="n">Infl</span><span class="p">,</span> <span class="n">NewCond_DaySubmerged</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.root_development" class="doc doc-heading">
<code class="highlight language-python"><span class="n">root_development</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">NewCond_DAP</span><span class="p">,</span> <span class="n">NewCond_Zroot</span><span class="p">,</span> <span class="n">NewCond_DelayedCDs</span><span class="p">,</span> <span class="n">NewCond_GDDcum</span><span class="p">,</span> <span class="n">NewCond_DelayedGDDs</span><span class="p">,</span> <span class="n">NewCond_TrRatio</span><span class="p">,</span> <span class="n">NewCond_th</span><span class="p">,</span> <span class="n">NewCond_CC</span><span class="p">,</span> <span class="n">NewCond_CC_NS</span><span class="p">,</span> <span class="n">NewCond_Germination</span><span class="p">,</span> <span class="n">NewCond_rCor</span><span class="p">,</span> <span class="n">NewCond_Tpot</span><span class="p">,</span> <span class="n">NewCond_zGW</span><span class="p">,</span> <span class="n">GDD</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">,</span> <span class="n">water_table_presence</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate root zone expansion</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=46" target="_blank">Reference Manual: root developement equations</a> (pg. 37-41)</p>
<p><em>Arguments:</em></p>
<p><code>Crop</code>: <code>CropStruct</code> : jit class object containing Crop paramaters</p>
<p><code>prof</code>: <code>SoilProfileClass</code> : jit class object containing soil paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>GDD</code>: <code>float</code> : Growing degree days on current day</p>
<p><code>GrowingSeason</code>: <code>bool</code> : is growing season (True or Flase)</p>
<p><code>water_table_presence</code>: <code>int</code> : water table present (True=1 or Flase=0)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_root_development&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">CropStructNT_type_sig</span><span class="p">,</span><span class="n">SoilProfileNT_typ_sig</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">i8</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">root_development</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span>
                    <span class="n">prof</span><span class="p">,</span>
                    <span class="n">NewCond_DAP</span><span class="p">,</span>
                    <span class="n">NewCond_Zroot</span><span class="p">,</span>
                    <span class="n">NewCond_DelayedCDs</span><span class="p">,</span>
                    <span class="n">NewCond_GDDcum</span><span class="p">,</span>
                    <span class="n">NewCond_DelayedGDDs</span><span class="p">,</span>
                    <span class="n">NewCond_TrRatio</span><span class="p">,</span>
                    <span class="n">NewCond_th</span><span class="p">,</span>
                    <span class="n">NewCond_CC</span><span class="p">,</span>
                    <span class="n">NewCond_CC_NS</span><span class="p">,</span>
                    <span class="n">NewCond_Germination</span><span class="p">,</span>
                    <span class="n">NewCond_rCor</span><span class="p">,</span>
                    <span class="n">NewCond_Tpot</span><span class="p">,</span>
                    <span class="n">NewCond_zGW</span><span class="p">,</span>
                    <span class="n">GDD</span><span class="p">,</span>
                    <span class="n">GrowingSeason</span><span class="p">,</span>
                    <span class="n">water_table_presence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate root zone expansion</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=46&quot; target=&quot;_blank&quot;&gt;Reference Manual: root developement equations&lt;/a&gt; (pg. 37-41)</span>


<span class="sd">    *Arguments:*</span>

<span class="sd">    `Crop`: `CropStruct` : jit class object containing Crop paramaters</span>

<span class="sd">    `prof`: `SoilProfileClass` : jit class object containing soil paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `GDD`: `float` : Growing degree days on current day</span>

<span class="sd">    `GrowingSeason`: `bool` : is growing season (True or Flase)</span>

<span class="sd">    `water_table_presence`: `int` : water table present (True=1 or Flase=0)</span>


<span class="sd">    *Returns:*</span>

<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store initial conditions for updating</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="c1"># save initial zroot</span>
    <span class="n">Zroot_init</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NewCond_Zroot</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>
    <span class="n">Soil_nLayer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Layer</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Calculate root expansion (if in growing season)</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># If today is first day of season, root depth is equal to minimum depth</span>
        <span class="k">if</span> <span class="n">NewCond_DAP</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">NewCond_Zroot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="n">Zroot_init</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>

        <span class="c1"># Adjust time for any delayed development</span>
        <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tAdj</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="n">NewCond_DelayedCDs</span>
        <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tAdj</span> <span class="o">=</span> <span class="n">NewCond_GDDcum</span> <span class="o">-</span> <span class="n">NewCond_DelayedGDDs</span>

        <span class="c1"># Calculate root expansion #</span>
        <span class="n">Zini</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span> <span class="o">*</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">PctZmin</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">Crop</span><span class="o">.</span><span class="n">Emergence</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">MaxRooting</span>
        <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tOld</span> <span class="o">=</span> <span class="n">tAdj</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">CalendarType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tOld</span> <span class="o">=</span> <span class="n">tAdj</span> <span class="o">-</span> <span class="n">GDD</span>

        <span class="c1"># Potential root depth on previous day</span>
        <span class="k">if</span> <span class="n">tOld</span> <span class="o">&gt;=</span> <span class="n">tmax</span><span class="p">:</span>
            <span class="n">ZrOld</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmax</span>
        <span class="k">elif</span> <span class="n">tOld</span> <span class="o">&lt;=</span> <span class="n">t0</span><span class="p">:</span>
            <span class="n">ZrOld</span> <span class="o">=</span> <span class="n">Zini</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">tOld</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
            <span class="n">ZrOld</span> <span class="o">=</span> <span class="n">Zini</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmax</span> <span class="o">-</span> <span class="n">Zini</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ZrOld</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">:</span>
            <span class="n">ZrOld</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span>

        <span class="c1"># Potential root depth on current day</span>
        <span class="k">if</span> <span class="n">tAdj</span> <span class="o">&gt;=</span> <span class="n">tmax</span><span class="p">:</span>
            <span class="n">Zr</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmax</span>
        <span class="k">elif</span> <span class="n">tAdj</span> <span class="o">&lt;=</span> <span class="n">t0</span><span class="p">:</span>
            <span class="n">Zr</span> <span class="o">=</span> <span class="n">Zini</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">tAdj</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
            <span class="n">Zr</span> <span class="o">=</span> <span class="n">Zini</span> <span class="o">+</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmax</span> <span class="o">-</span> <span class="n">Zini</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Zr</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">:</span>
            <span class="n">Zr</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span>

        <span class="c1"># Store Zr as potential value</span>
        <span class="n">ZrPot</span> <span class="o">=</span> <span class="n">Zr</span>

        <span class="c1"># Determine rate of change</span>
        <span class="n">dZr</span> <span class="o">=</span> <span class="n">Zr</span> <span class="o">-</span> <span class="n">ZrOld</span>

        <span class="c1"># Adjust expansion rate for presence of restrictive soil horizons</span>
        <span class="k">if</span> <span class="n">Zr</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">:</span>
            <span class="n">layeri</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Layer</span> <span class="o">==</span> <span class="n">layeri</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">Zsoil</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">while</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">Zsoil</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">layeri</span> <span class="o">&lt;</span> <span class="n">Soil_nLayer</span><span class="p">):</span>
                <span class="n">layeri</span> <span class="o">=</span> <span class="n">layeri</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">l_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Layer</span> <span class="o">==</span> <span class="n">layeri</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">Zsoil</span> <span class="o">=</span> <span class="n">Zsoil</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">soil_layer_dz</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">layer_comp</span> <span class="o">=</span> <span class="n">l_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># soil_layer = prof.Layer[layeri]</span>
            <span class="n">ZrAdj</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span>
            <span class="n">ZrRemain</span> <span class="o">=</span> <span class="n">Zr</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span>
            <span class="n">deltaZ</span> <span class="o">=</span> <span class="n">Zsoil</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span>
            <span class="n">EndProf</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="n">EndProf</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ZrTest</span> <span class="o">=</span> <span class="n">ZrAdj</span> <span class="o">+</span> <span class="p">(</span><span class="n">ZrRemain</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Penetrability</span><span class="p">[</span><span class="n">layer_comp</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">layeri</span> <span class="o">==</span> <span class="n">Soil_nLayer</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Penetrability</span><span class="p">[</span><span class="n">layer_comp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">ZrTest</span> <span class="o">&lt;=</span> <span class="n">Zsoil</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">ZrOUT</span> <span class="o">=</span> <span class="n">ZrTest</span>
                    <span class="n">EndProf</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ZrAdj</span> <span class="o">=</span> <span class="n">Zsoil</span>
                    <span class="n">ZrRemain</span> <span class="o">=</span> <span class="n">ZrRemain</span> <span class="o">-</span> <span class="p">(</span><span class="n">deltaZ</span> <span class="o">/</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Penetrability</span><span class="p">[</span><span class="n">layer_comp</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
                    <span class="n">layeri</span> <span class="o">=</span> <span class="n">layeri</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">l_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">Layer</span> <span class="o">==</span> <span class="n">layeri</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">layer_comp</span> <span class="o">=</span> <span class="n">l_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">soil_layer_dz</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">Zsoil</span> <span class="o">=</span> <span class="n">Zsoil</span> <span class="o">+</span> <span class="n">soil_layer_dz</span>
                    <span class="n">deltaZ</span> <span class="o">=</span> <span class="n">soil_layer_dz</span>

            <span class="c1"># Correct Zr and dZr for effects of restrictive horizons</span>
            <span class="n">Zr</span> <span class="o">=</span> <span class="n">ZrOUT</span>
            <span class="n">dZr</span> <span class="o">=</span> <span class="n">Zr</span> <span class="o">-</span> <span class="n">ZrOld</span>

        <span class="c1"># Adjust rate of expansion for any stomatal water stress</span>
        <span class="k">if</span> <span class="n">NewCond_TrRatio</span> <span class="o">&lt;</span> <span class="mf">0.9999</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_ex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dZr</span> <span class="o">=</span> <span class="n">dZr</span> <span class="o">*</span> <span class="n">NewCond_TrRatio</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fAdj</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">NewCond_TrRatio</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_ex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">fshape_ex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">dZr</span> <span class="o">=</span> <span class="n">dZr</span> <span class="o">*</span> <span class="n">fAdj</span>

        <span class="c1"># print(NewCond.DAP,NewCond.th)</span>

        <span class="c1"># Adjust rate of root expansion for dry soil at expansion front</span>
        <span class="k">if</span> <span class="n">dZr</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="c1"># Define water stress threshold for inhibition of root expansion</span>
            <span class="n">pZexp</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Define potential new root depth</span>
            <span class="n">ZiTmp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Zroot_init</span> <span class="o">+</span> <span class="n">dZr</span><span class="p">)</span>
            <span class="c1"># Find compartment that root zone will expand in to</span>
            <span class="c1"># compi_index = prof.dzsum[prof.dzsum&gt;=ZiTmp].index[0] # have changed to index</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&gt;=</span> <span class="n">ZiTmp</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prof</span> <span class="o">=</span> <span class="n">prof</span>
            <span class="c1"># Get TAW in compartment</span>
            <span class="n">layeri</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">Layer</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">TAWprof</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1"># Define stress threshold</span>
            <span class="n">thThr</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pZexp</span> <span class="o">*</span> <span class="n">TAWprof</span><span class="p">)</span>
            <span class="c1"># Check for stress conditions</span>
            <span class="k">if</span> <span class="n">NewCond_th</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thThr</span><span class="p">:</span>
                <span class="c1"># Root expansion limited by water content at expansion front</span>
                <span class="k">if</span> <span class="n">NewCond_th</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>

                    <span class="c1"># Expansion fully inhibited</span>
                    <span class="n">dZr</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Expansion partially inhibited</span>
                    <span class="n">Wrel</span> <span class="o">=</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">NewCond_th</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="n">TAWprof</span>
                    <span class="n">Drel</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Wrel</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pZexp</span><span class="p">))</span>
                    <span class="n">Ks</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Drel</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">dZr</span> <span class="o">=</span> <span class="n">dZr</span> <span class="o">*</span> <span class="n">Ks</span>

        <span class="c1"># Adjust for early senescence</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NewCond_CC</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_CC_NS</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">):</span>
            <span class="n">dZr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Adjust root expansion for failure to germinate (roots cannot expand</span>
        <span class="c1"># if crop has not germinated)</span>
        <span class="k">if</span> <span class="n">NewCond_Germination</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">dZr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get new rooting depth</span>
        <span class="n">NewCond_Zroot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Zroot_init</span> <span class="o">+</span> <span class="n">dZr</span><span class="p">)</span>

        <span class="c1"># Adjust root density if deepening is restricted due to dry subsoil</span>
        <span class="c1"># and/or restrictive layers</span>
        <span class="k">if</span> <span class="n">NewCond_Zroot</span> <span class="o">&lt;</span> <span class="n">ZrPot</span><span class="p">:</span>
            <span class="n">NewCond_rCor</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ZrPot</span> <span class="o">/</span> <span class="n">NewCond_Zroot</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">Crop</span><span class="o">.</span><span class="n">SxTop</span> <span class="o">+</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxBot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxTop</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxBot</span>

            <span class="k">if</span> <span class="n">NewCond_Tpot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">NewCond_rCor</span> <span class="o">=</span> <span class="n">NewCond_rCor</span> <span class="o">*</span> <span class="n">NewCond_TrRatio</span>
                <span class="k">if</span> <span class="n">NewCond_rCor</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">NewCond_rCor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">NewCond_rCor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Limit rooting depth if groundwater table is present (roots cannot</span>
        <span class="c1"># develop below the water table)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">water_table_presence</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_zGW</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">NewCond_Zroot</span> <span class="o">&gt;</span> <span class="n">NewCond_zGW</span><span class="p">:</span>
                <span class="n">NewCond_Zroot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NewCond_zGW</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">NewCond_Zroot</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">:</span>
                    <span class="n">NewCond_Zroot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No root system outside of the growing season</span>
        <span class="n">NewCond_Zroot</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">NewCond_Zroot</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.root_zone_water" class="doc doc-heading">
<code class="highlight language-python"><span class="n">root_zone_water</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">InitCond_Zroot</span><span class="p">,</span> <span class="n">InitCond_th</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">Crop_Zmin</span><span class="p">,</span> <span class="n">Crop_Aer</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate actual and total available water in the rootzone at current time step</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=14" target="_blank">Reference Manual: root-zone water calculations</a> (pg. 5-8)</p>
<p><em>Arguments:</em></p>
<p><code>prof</code>: <code>SoilProfileClass</code> : jit class Object containing soil paramaters</p>
<p><code>InitCond_Zroot</code>: <code>float</code> : Initial rooting depth</p>
<p><code>InitCond_th</code>: <code>np.array</code> : Initial water content</p>
<p><code>Soil_zTop</code>: <code>float</code> : Top soil depth</p>
<p><code>Crop_Zmin</code>: <code>float</code> : crop minimum rooting depth</p>
<p><code>Crop_Aer</code>: <code>int</code> : number of aeration stress days</p>
<p><em>Returns:</em></p>
<p><code>WrAct</code>: <code>float</code> :  Actual rootzone water content</p>
<p><code>Dr</code>: <code>DrClass</code> :  Depletion objection containing rootzone and topsoil depletion</p>
<p><code>TAW</code>: <code>TAWClass</code> :  <code>TAWClass</code> containing rootzone and topsoil total avalable water</p>
<p><code>thRZ</code>: <code>thRZClass</code> :  thRZ object conaining rootzone water content paramaters</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@njit</span>
<span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_root_zone_water&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SoilProfileNT_typ_sig</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">root_zone_water</span><span class="p">(</span>
    <span class="n">prof</span><span class="p">,</span>
    <span class="n">InitCond_Zroot</span><span class="p">,</span>
    <span class="n">InitCond_th</span><span class="p">,</span>
    <span class="n">Soil_zTop</span><span class="p">,</span>
    <span class="n">Crop_Zmin</span><span class="p">,</span>
    <span class="n">Crop_Aer</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate actual and total available water in the rootzone at current time step</span>


<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=14&quot; target=&quot;_blank&quot;&gt;Reference Manual: root-zone water calculations&lt;/a&gt; (pg. 5-8)</span>


<span class="sd">    *Arguments:*</span>

<span class="sd">    `prof`: `SoilProfileClass` : jit class Object containing soil paramaters</span>

<span class="sd">    `InitCond_Zroot`: `float` : Initial rooting depth</span>

<span class="sd">    `InitCond_th`: `np.array` : Initial water content</span>

<span class="sd">    `Soil_zTop`: `float` : Top soil depth</span>

<span class="sd">    `Crop_Zmin`: `float` : crop minimum rooting depth</span>

<span class="sd">    `Crop_Aer`: `int` : number of aeration stress days</span>

<span class="sd">    *Returns:*</span>

<span class="sd">     `WrAct`: `float` :  Actual rootzone water content</span>

<span class="sd">     `Dr`: `DrClass` :  Depletion objection containing rootzone and topsoil depletion</span>

<span class="sd">     `TAW`: `TAWClass` :  `TAWClass` containing rootzone and topsoil total avalable water</span>

<span class="sd">     `thRZ`: `thRZClass` :  thRZ object conaining rootzone water content paramaters</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Calculate root zone water content and available water ##</span>
    <span class="c1"># Compartments covered by the root zone</span>
    <span class="n">rootdepth</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">InitCond_Zroot</span><span class="p">,</span> <span class="n">Crop_Zmin</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">comp_sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&gt;=</span> <span class="n">rootdepth</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Initialise counters</span>
    <span class="n">WrAct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">WrS</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">WrFC</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">WrWP</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">WrDry</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">WrAer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Fraction of compartment covered by root zone</span>
        <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rootdepth</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">rootdepth</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Actual water storage in root zone (mm)</span>
        <span class="n">WrAct</span> <span class="o">=</span> <span class="n">WrAct</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">InitCond_th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Water storage in root zone at saturation (mm)</span>
        <span class="n">WrS</span> <span class="o">=</span> <span class="n">WrS</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Water storage in root zone at field capacity (mm)</span>
        <span class="n">WrFC</span> <span class="o">=</span> <span class="n">WrFC</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Water storage in root zone at permanent wilting point (mm)</span>
        <span class="n">WrWP</span> <span class="o">=</span> <span class="n">WrWP</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Water storage in root zone at air dry (mm)</span>
        <span class="n">WrDry</span> <span class="o">=</span> <span class="n">WrDry</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_dry</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Water storage in root zone at aeration stress threshold (mm)</span>
        <span class="n">WrAer</span> <span class="o">=</span> <span class="n">WrAer</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Crop_Aer</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">WrAct</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">WrAct</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># define total available water, depletion, root zone water content</span>
    <span class="c1"># TAW = TAWClass()</span>
    <span class="c1"># Dr = DrClass()</span>
    <span class="c1"># thRZ = thRZClass()</span>

    <span class="c1"># Calculate total available water (m3/m3)</span>
    <span class="n">TAW_Rz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">WrFC</span> <span class="o">-</span> <span class="n">WrWP</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># Calculate soil water depletion (mm)</span>
    <span class="n">Dr_Rz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">WrFC</span> <span class="o">-</span> <span class="n">WrAct</span><span class="p">,</span> <span class="n">TAW_Rz</span><span class="p">)</span>

    <span class="c1"># Actual root zone water content (m3/m3)</span>
    <span class="n">thRZ_Act</span> <span class="o">=</span> <span class="n">WrAct</span> <span class="o">/</span> <span class="p">(</span><span class="n">rootdepth</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="c1"># Root zone water content at saturation (m3/m3)</span>
    <span class="n">thRZ_S</span> <span class="o">=</span> <span class="n">WrS</span> <span class="o">/</span> <span class="p">(</span><span class="n">rootdepth</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="c1"># Root zone water content at field capacity (m3/m3)</span>
    <span class="n">thRZ_FC</span> <span class="o">=</span> <span class="n">WrFC</span> <span class="o">/</span> <span class="p">(</span><span class="n">rootdepth</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="c1"># Root zone water content at permanent wilting point (m3/m3)</span>
    <span class="n">thRZ_WP</span> <span class="o">=</span> <span class="n">WrWP</span> <span class="o">/</span> <span class="p">(</span><span class="n">rootdepth</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="c1"># Root zone water content at air dry (m3/m3)</span>
    <span class="n">thRZ_Dry</span> <span class="o">=</span> <span class="n">WrDry</span> <span class="o">/</span> <span class="p">(</span><span class="n">rootdepth</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="c1"># Root zone water content at aeration stress threshold (m3/m3)</span>
    <span class="n">thRZ_Aer</span> <span class="o">=</span> <span class="n">WrAer</span> <span class="o">/</span> <span class="p">(</span><span class="n">rootdepth</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># print(&#39;inside&#39;)</span>

    <span class="c1"># thRZ = thRZNT(</span>
    <span class="c1"># Act=thRZ_Act,</span>
    <span class="c1"># S=thRZ_S,</span>
    <span class="c1"># FC=thRZ_FC,</span>
    <span class="c1"># WP=thRZ_WP,</span>
    <span class="c1"># Dry=thRZ_Dry,</span>
    <span class="c1"># Aer=thRZ_Aer,</span>
    <span class="c1"># )</span>
    <span class="c1"># print(thRZ)</span>


    <span class="c1">## Calculate top soil water content and available water ##</span>
    <span class="k">if</span> <span class="n">rootdepth</span> <span class="o">&gt;</span> <span class="n">Soil_zTop</span><span class="p">:</span>
        <span class="c1"># Determine compartments covered by the top soil</span>
        <span class="n">ztopdepth</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Soil_zTop</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">comp_sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&lt;=</span> <span class="n">ztopdepth</span><span class="p">)</span>
        <span class="c1"># Initialise counters</span>
        <span class="n">WrAct_Zt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">WrFC_Zt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">WrWP_Zt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Calculate water storage in top soil</span>
        <span class="k">assert</span> <span class="n">comp_sto</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">):</span>

            <span class="c1"># Fraction of compartment covered by root zone</span>
            <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ztopdepth</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">ztopdepth</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Actual water storage in top soil (mm)</span>
            <span class="n">WrAct_Zt</span> <span class="o">=</span> <span class="n">WrAct_Zt</span> <span class="o">+</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">InitCond_th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="c1"># Water storage in top soil at field capacity (mm)</span>
            <span class="n">WrFC_Zt</span> <span class="o">=</span> <span class="n">WrFC_Zt</span> <span class="o">+</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="c1"># Water storage in top soil at permanent wilting point (mm)</span>
            <span class="n">WrWP_Zt</span> <span class="o">=</span> <span class="n">WrWP_Zt</span> <span class="o">+</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

        <span class="c1"># Ensure available water in top soil is not less than zero</span>
        <span class="k">if</span> <span class="n">WrAct_Zt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">WrAct_Zt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Calculate total available water in top soil (m3/m3)</span>
        <span class="n">TAW_Zt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">WrFC_Zt</span> <span class="o">-</span> <span class="n">WrWP_Zt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Calculate depletion in top soil (mm)</span>
        <span class="n">Dr_Zt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">WrFC_Zt</span> <span class="o">-</span> <span class="n">WrAct_Zt</span><span class="p">,</span> <span class="n">TAW_Zt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set top soil depletions and TAW to root zone values</span>
        <span class="n">Dr_Zt</span> <span class="o">=</span> <span class="n">Dr_Rz</span>
        <span class="n">TAW_Zt</span> <span class="o">=</span> <span class="n">TAW_Rz</span>


    <span class="k">return</span> <span class="p">(</span>
        <span class="n">WrAct</span><span class="p">,</span>
        <span class="n">Dr_Zt</span><span class="p">,</span>
        <span class="n">Dr_Rz</span><span class="p">,</span>
        <span class="n">TAW_Zt</span><span class="p">,</span>
        <span class="n">TAW_Rz</span><span class="p">,</span>
        <span class="n">thRZ_Act</span><span class="p">,</span>
        <span class="n">thRZ_S</span><span class="p">,</span>
        <span class="n">thRZ_FC</span><span class="p">,</span>
        <span class="n">thRZ_WP</span><span class="p">,</span>
        <span class="n">thRZ_Dry</span><span class="p">,</span>
        <span class="n">thRZ_Aer</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.soil_evaporation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">soil_evaporation</span><span class="p">(</span><span class="n">ClockStruct_EvapTimeSteps</span><span class="p">,</span> <span class="n">ClockStruct_SimOffSeason</span><span class="p">,</span> <span class="n">ClockStruct_TimeStepCounter</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">Soil_EvapZmin</span><span class="p">,</span> <span class="n">Soil_EvapZmax</span><span class="p">,</span> <span class="n">Soil_REW</span><span class="p">,</span> <span class="n">Soil_Kex</span><span class="p">,</span> <span class="n">Soil_fwcc</span><span class="p">,</span> <span class="n">Soil_fWrelExp</span><span class="p">,</span> <span class="n">Soil_fevap</span><span class="p">,</span> <span class="n">Crop_CalendarType</span><span class="p">,</span> <span class="n">Crop_Senescence</span><span class="p">,</span> <span class="n">IrrMngt_IrrMethod</span><span class="p">,</span> <span class="n">IrrMngt_WetSurf</span><span class="p">,</span> <span class="n">FieldMngt_Mulches</span><span class="p">,</span> <span class="n">FieldMngt_fMulch</span><span class="p">,</span> <span class="n">FieldMngt_MulchPct</span><span class="p">,</span> <span class="n">NewCond_DAP</span><span class="p">,</span> <span class="n">NewCond_Wsurf</span><span class="p">,</span> <span class="n">NewCond_EvapZ</span><span class="p">,</span> <span class="n">NewCond_Stage2</span><span class="p">,</span> <span class="n">NewCond_th</span><span class="p">,</span> <span class="n">NewCond_DelayedCDs</span><span class="p">,</span> <span class="n">NewCond_GDDcum</span><span class="p">,</span> <span class="n">NewCond_DelayedGDDs</span><span class="p">,</span> <span class="n">NewCond_CCxW</span><span class="p">,</span> <span class="n">NewCond_CCadj</span><span class="p">,</span> <span class="n">NewCond_CCxAct</span><span class="p">,</span> <span class="n">NewCond_CC</span><span class="p">,</span> <span class="n">NewCond_PrematSenes</span><span class="p">,</span> <span class="n">NewCond_SurfaceStorage</span><span class="p">,</span> <span class="n">NewCond_Wstage2</span><span class="p">,</span> <span class="n">NewCond_Epot</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">Infl</span><span class="p">,</span> <span class="n">Rain</span><span class="p">,</span> <span class="n">Irr</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate daily soil evaporation</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=82" target="_blank">Reference Manual: evaporation equations</a> (pg. 73-81)</p>
<p><em>Arguments:</em></p>
<p><code>Clock params</code>: <code>bool, int</code> : clock params</p>
<p><code>Soil parameters</code>: <code>float</code> : soil parameters</p>
<p><code>Crop params</code>: <code>float</code> : Crop paramaters</p>
<p><code>IrrMngt params</code>: <code>int, float</code>: irrigation management paramaters</p>
<p><code>FieldMngt</code>: <code>FieldMngtStruct</code> : Field management paramaters</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object containing model paramaters</p>
<p><code>Et0</code>: <code>float</code> : daily reference evapotranspiration</p>
<p><code>Infl</code>: <code>float</code> : Infiltration on current day</p>
<p><code>Rain</code>: <code>float</code> : daily precipitation mm</p>
<p><code>Irr</code>: <code>float</code> : Irrigation applied on current day</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is growing season (True or Flase)</p>
<p><em>Returns:</em></p>
<p><code>NewCond</code>: <code>InitCondClass</code> : InitCond object containing updated model paramaters</p>
<p><code>EsAct</code>: <code>float</code> : Actual surface evaporation current day</p>
<p><code>EsPot</code>: <code>float</code> : Potential surface evaporation current day</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
    <span class="s2">&quot;_soil_evaporation&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">SoilProfileNT_typ_sig</span><span class="p">,</span>
    <span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">i8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">[:],</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span>
        <span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">b1</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">soil_evaporation</span><span class="p">(</span>
    <span class="n">ClockStruct_EvapTimeSteps</span><span class="p">,</span>
    <span class="n">ClockStruct_SimOffSeason</span><span class="p">,</span>
    <span class="n">ClockStruct_TimeStepCounter</span><span class="p">,</span>
    <span class="n">prof</span><span class="p">,</span>
    <span class="n">Soil_EvapZmin</span><span class="p">,</span>
    <span class="n">Soil_EvapZmax</span><span class="p">,</span>
    <span class="n">Soil_REW</span><span class="p">,</span>
    <span class="n">Soil_Kex</span><span class="p">,</span>
    <span class="n">Soil_fwcc</span><span class="p">,</span>
    <span class="n">Soil_fWrelExp</span><span class="p">,</span>
    <span class="n">Soil_fevap</span><span class="p">,</span>
    <span class="n">Crop_CalendarType</span><span class="p">,</span>
    <span class="n">Crop_Senescence</span><span class="p">,</span>
    <span class="n">IrrMngt_IrrMethod</span><span class="p">,</span>
    <span class="n">IrrMngt_WetSurf</span><span class="p">,</span>
    <span class="n">FieldMngt_Mulches</span><span class="p">,</span>
    <span class="n">FieldMngt_fMulch</span><span class="p">,</span>
    <span class="n">FieldMngt_MulchPct</span><span class="p">,</span>
    <span class="n">NewCond_DAP</span><span class="p">,</span>
    <span class="n">NewCond_Wsurf</span><span class="p">,</span>
    <span class="n">NewCond_EvapZ</span><span class="p">,</span>
    <span class="n">NewCond_Stage2</span><span class="p">,</span>
    <span class="n">NewCond_th</span><span class="p">,</span>
    <span class="n">NewCond_DelayedCDs</span><span class="p">,</span>
    <span class="n">NewCond_GDDcum</span><span class="p">,</span>
    <span class="n">NewCond_DelayedGDDs</span><span class="p">,</span>
    <span class="n">NewCond_CCxW</span><span class="p">,</span>
    <span class="n">NewCond_CCadj</span><span class="p">,</span>
    <span class="n">NewCond_CCxAct</span><span class="p">,</span>
    <span class="n">NewCond_CC</span><span class="p">,</span>
    <span class="n">NewCond_PrematSenes</span><span class="p">,</span>
    <span class="n">NewCond_SurfaceStorage</span><span class="p">,</span>
    <span class="n">NewCond_Wstage2</span><span class="p">,</span>
    <span class="n">NewCond_Epot</span><span class="p">,</span>
    <span class="n">Et0</span><span class="p">,</span>
    <span class="n">Infl</span><span class="p">,</span>
    <span class="n">Rain</span><span class="p">,</span>
    <span class="n">Irr</span><span class="p">,</span>
    <span class="n">GrowingSeason</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate daily soil evaporation</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=82&quot; target=&quot;_blank&quot;&gt;Reference Manual: evaporation equations&lt;/a&gt; (pg. 73-81)</span>


<span class="sd">    *Arguments:*</span>



<span class="sd">    `Clock params`: `bool, int` : clock params</span>

<span class="sd">    `Soil parameters`: `float` : soil parameters</span>

<span class="sd">    `Crop params`: `float` : Crop paramaters</span>

<span class="sd">    `IrrMngt params`: `int, float`: irrigation management paramaters</span>

<span class="sd">    `FieldMngt`: `FieldMngtStruct` : Field management paramaters</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object containing model paramaters</span>

<span class="sd">    `Et0`: `float` : daily reference evapotranspiration</span>

<span class="sd">    `Infl`: `float` : Infiltration on current day</span>

<span class="sd">    `Rain`: `float` : daily precipitation mm</span>

<span class="sd">    `Irr`: `float` : Irrigation applied on current day</span>

<span class="sd">    `GrowingSeason`:: `bool` : is growing season (True or Flase)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `NewCond`: `InitCondClass` : InitCond object containing updated model paramaters</span>

<span class="sd">    `EsAct`: `float` : Actual surface evaporation current day</span>

<span class="sd">    `EsPot`: `float` : Potential surface evaporation current day</span>





<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Wevap = WevapClass()</span>

    <span class="c1">## Store initial conditions in new structure that will be updated ##</span>
    <span class="c1"># NewCond = InitCond</span>

    <span class="c1">## Prepare stage 2 evaporation (REW gone) ##</span>
    <span class="c1"># Only do this if it is first day of simulation, or if it is first day of</span>
    <span class="c1"># growing season and not simulating off-season</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ClockStruct_TimeStepCounter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">NewCond_DAP</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ClockStruct_SimOffSeason</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="c1"># Reset storage in surface soil layer to zero</span>
        <span class="n">NewCond_Wsurf</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Set evaporation depth to minimum</span>
        <span class="n">NewCond_EvapZ</span> <span class="o">=</span> <span class="n">Soil_EvapZmin</span>
        <span class="c1"># Trigger stage 2 evaporation</span>
        <span class="n">NewCond_Stage2</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Get relative water content for start of stage 2 evaporation</span>
        <span class="n">Wevap_Sat</span><span class="p">,</span> <span class="n">Wevap_Fc</span><span class="p">,</span> <span class="n">Wevap_Wp</span><span class="p">,</span> <span class="n">Wevap_Dry</span><span class="p">,</span> <span class="n">Wevap_Act</span> <span class="o">=</span> <span class="n">_evap_layer_water_content</span><span class="p">(</span>
            <span class="n">NewCond_th</span><span class="p">,</span>
            <span class="n">NewCond_EvapZ</span><span class="p">,</span>
            <span class="n">prof</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">NewCond_Wstage2</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
            <span class="p">(</span><span class="n">Wevap_Act</span> <span class="o">-</span> <span class="p">(</span><span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">Wevap_Sat</span> <span class="o">-</span> <span class="p">(</span><span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span><span class="p">)),</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">NewCond_Wstage2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">NewCond_Wstage2</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">## Prepare soil evaporation stage 1 ##</span>
    <span class="c1"># Adjust water in surface evaporation layer for any infiltration</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Rain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">Irr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">IrrMngt_IrrMethod</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)):</span>
        <span class="c1"># Only prepare stage one when rainfall occurs, or when irrigation is</span>
        <span class="c1"># trigerred (not in net irrigation mode)</span>
        <span class="k">if</span> <span class="n">Infl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Update storage in surface evaporation layer for incoming</span>
            <span class="c1"># infiltration</span>
            <span class="n">NewCond_Wsurf</span> <span class="o">=</span> <span class="n">Infl</span>
            <span class="c1"># Water stored in surface evaporation layer cannot exceed REW</span>
            <span class="k">if</span> <span class="n">NewCond_Wsurf</span> <span class="o">&gt;</span> <span class="n">Soil_REW</span><span class="p">:</span>
                <span class="n">NewCond_Wsurf</span> <span class="o">=</span> <span class="n">Soil_REW</span>

            <span class="c1"># Reset variables</span>
            <span class="n">NewCond_Wstage2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NewCond_EvapZ</span> <span class="o">=</span> <span class="n">Soil_EvapZmin</span>
            <span class="n">NewCond_Stage2</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">## Calculate potential soil evaporation rate (mm/day) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Adjust time for any delayed development</span>
        <span class="k">if</span> <span class="n">Crop_CalendarType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tAdj</span> <span class="o">=</span> <span class="n">NewCond_DAP</span> <span class="o">-</span> <span class="n">NewCond_DelayedCDs</span>
        <span class="k">elif</span> <span class="n">Crop_CalendarType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tAdj</span> <span class="o">=</span> <span class="n">NewCond_GDDcum</span> <span class="o">-</span> <span class="n">NewCond_DelayedGDDs</span>

        <span class="c1"># Calculate maximum potential soil evaporation</span>
        <span class="n">EsPotMax</span> <span class="o">=</span> <span class="n">Soil_Kex</span> <span class="o">*</span> <span class="n">Et0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">NewCond_CCxW</span> <span class="o">*</span> <span class="p">(</span><span class="n">Soil_fwcc</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
        <span class="c1"># Calculate potential soil evaporation (given current canopy cover</span>
        <span class="c1"># size)</span>
        <span class="n">EsPot</span> <span class="o">=</span> <span class="n">Soil_Kex</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">NewCond_CCadj</span><span class="p">)</span> <span class="o">*</span> <span class="n">Et0</span>

        <span class="c1"># Adjust potential soil evaporation for effects of withered canopy</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tAdj</span> <span class="o">&gt;</span> <span class="n">Crop_Senescence</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_CCxAct</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">NewCond_CC</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">NewCond_CCxAct</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">NewCond_CC</span> <span class="o">&gt;</span> <span class="n">NewCond_CCxAct</span><span class="p">:</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">NewCond_CCxAct</span> <span class="o">-</span> <span class="n">NewCond_CC</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">NewCond_CCxAct</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">EsPot</span> <span class="o">=</span> <span class="n">EsPot</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">NewCond_CCxAct</span> <span class="o">*</span> <span class="p">(</span><span class="n">Soil_fwcc</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">mult</span><span class="p">)</span>
            <span class="n">CCxActAdj</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mf">1.72</span> <span class="o">*</span> <span class="n">NewCond_CCxAct</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">NewCond_CCxAct</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">NewCond_CCxAct</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">EsPotMin</span> <span class="o">=</span> <span class="n">Soil_Kex</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CCxActAdj</span><span class="p">)</span> <span class="o">*</span> <span class="n">Et0</span>
            <span class="k">if</span> <span class="n">EsPotMin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">EsPotMin</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">EsPot</span> <span class="o">&lt;</span> <span class="n">EsPotMin</span><span class="p">:</span>
                <span class="n">EsPot</span> <span class="o">=</span> <span class="n">EsPotMin</span>
            <span class="k">elif</span> <span class="n">EsPot</span> <span class="o">&gt;</span> <span class="n">EsPotMax</span><span class="p">:</span>
                <span class="n">EsPot</span> <span class="o">=</span> <span class="n">EsPotMax</span>

        <span class="k">if</span> <span class="n">NewCond_PrematSenes</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">EsPot</span> <span class="o">&gt;</span> <span class="n">EsPotMax</span><span class="p">:</span>
                <span class="n">EsPot</span> <span class="o">=</span> <span class="n">EsPotMax</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No canopy cover outside of growing season so potential soil</span>
        <span class="c1"># evaporation only depends on reference evapotranspiration</span>
        <span class="n">EsPot</span> <span class="o">=</span> <span class="n">Soil_Kex</span> <span class="o">*</span> <span class="n">Et0</span>

    <span class="c1">## Adjust potential soil evaporation for mulches and/or partial wetting ##</span>
    <span class="c1"># Mulches</span>
    <span class="k">if</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">&lt;</span> <span class="mf">0.000001</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">FieldMngt_Mulches</span><span class="p">:</span>
            <span class="c1"># No mulches present</span>
            <span class="n">EsPotMul</span> <span class="o">=</span> <span class="n">EsPot</span>
        <span class="k">elif</span> <span class="n">FieldMngt_Mulches</span><span class="p">:</span>
            <span class="c1"># Mulches present</span>
            <span class="n">EsPotMul</span> <span class="o">=</span> <span class="n">EsPot</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">FieldMngt_fMulch</span> <span class="o">*</span> <span class="p">(</span><span class="n">FieldMngt_MulchPct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Surface is flooded - no adjustment of potential soil evaporation for</span>
        <span class="c1"># mulches</span>
        <span class="n">EsPotMul</span> <span class="o">=</span> <span class="n">EsPot</span>

    <span class="c1"># Partial surface wetting by irrigation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Irr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">IrrMngt_IrrMethod</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="c1"># Only apply adjustment if irrigation occurs and not in net irrigation</span>
        <span class="c1"># mode</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Rain</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">NewCond_SurfaceStorage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># No adjustment for partial wetting - assume surface is fully wet</span>
            <span class="n">EsPotIrr</span> <span class="o">=</span> <span class="n">EsPot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Adjust for proprtion of surface area wetted by irrigation</span>
            <span class="n">EsPotIrr</span> <span class="o">=</span> <span class="n">EsPot</span> <span class="o">*</span> <span class="p">(</span><span class="n">IrrMngt_WetSurf</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No adjustment for partial surface wetting</span>
        <span class="n">EsPotIrr</span> <span class="o">=</span> <span class="n">EsPot</span>

    <span class="c1"># Assign minimum value (mulches and partial wetting don&#39;t combine)</span>
    <span class="n">EsPot</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">EsPotIrr</span><span class="p">,</span> <span class="n">EsPotMul</span><span class="p">)</span>

    <span class="c1">## Surface evaporation ##</span>
    <span class="c1"># Initialise actual evaporation counter</span>
    <span class="n">EsAct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Evaporate surface storage</span>
    <span class="k">if</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">&gt;</span> <span class="n">EsPot</span><span class="p">:</span>
            <span class="c1"># All potential soil evaporation can be supplied by surface storage</span>
            <span class="n">EsAct</span> <span class="o">=</span> <span class="n">EsPot</span>
            <span class="c1"># Update surface storage</span>
            <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="n">NewCond_SurfaceStorage</span> <span class="o">-</span> <span class="n">EsAct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Surface storage is not sufficient to meet all potential soil</span>
            <span class="c1"># evaporation</span>
            <span class="n">EsAct</span> <span class="o">=</span> <span class="n">NewCond_SurfaceStorage</span>
            <span class="c1"># Update surface storage, evaporation layer depth, stage</span>
            <span class="n">NewCond_SurfaceStorage</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NewCond_Wsurf</span> <span class="o">=</span> <span class="n">Soil_REW</span>
            <span class="n">NewCond_Wstage2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NewCond_EvapZ</span> <span class="o">=</span> <span class="n">Soil_EvapZmin</span>
            <span class="n">NewCond_Stage2</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">## Stage 1 evaporation ##</span>
    <span class="c1"># Determine total water to be extracted</span>
    <span class="n">ToExtract</span> <span class="o">=</span> <span class="n">EsPot</span> <span class="o">-</span> <span class="n">EsAct</span>
    <span class="c1"># Determine total water to be extracted in stage one (limited by surface</span>
    <span class="c1"># layer water storage)</span>
    <span class="n">ExtractPotStg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ToExtract</span><span class="p">,</span> <span class="n">NewCond_Wsurf</span><span class="p">)</span>
    <span class="c1"># Extract water</span>
    <span class="k">if</span> <span class="n">ExtractPotStg1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Find soil compartments covered by evaporation layer</span>
        <span class="n">comp_sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&lt;</span> <span class="n">Soil_EvapZmin</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># prof = Soil_Profile</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">ExtractPotStg1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span> <span class="o">&lt;</span> <span class="n">comp_sto</span><span class="p">):</span>
            <span class="c1"># Increment compartment counter</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># Specify layer number</span>
            <span class="c1"># Determine proportion of compartment in evaporation layer</span>
            <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Soil_EvapZmin</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">Soil_EvapZmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Water storage (mm) at air dry</span>
            <span class="n">Wdry</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_dry</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
            <span class="c1"># Available water (mm)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">NewCond_th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
            <span class="c1"># Water available in compartment for extraction (mm)</span>
            <span class="n">AvW</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wdry</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="k">if</span> <span class="n">AvW</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">AvW</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">AvW</span> <span class="o">&gt;=</span> <span class="n">ExtractPotStg1</span><span class="p">:</span>
                <span class="c1"># Update actual evaporation</span>
                <span class="n">EsAct</span> <span class="o">=</span> <span class="n">EsAct</span> <span class="o">+</span> <span class="n">ExtractPotStg1</span>
                <span class="c1"># Update depth of water in current compartment</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">ExtractPotStg1</span>
                <span class="c1"># Update total water to be extracted</span>
                <span class="n">ToExtract</span> <span class="o">=</span> <span class="n">ToExtract</span> <span class="o">-</span> <span class="n">ExtractPotStg1</span>
                <span class="c1"># Update water to be extracted from surface layer (stage 1)</span>
                <span class="n">ExtractPotStg1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Update actual evaporation</span>
                <span class="n">EsAct</span> <span class="o">=</span> <span class="n">EsAct</span> <span class="o">+</span> <span class="n">AvW</span>
                <span class="c1"># Update water to be extracted from surface layer (stage 1)</span>
                <span class="n">ExtractPotStg1</span> <span class="o">=</span> <span class="n">ExtractPotStg1</span> <span class="o">-</span> <span class="n">AvW</span>
                <span class="c1"># Update total water to be extracted</span>
                <span class="n">ToExtract</span> <span class="o">=</span> <span class="n">ToExtract</span> <span class="o">-</span> <span class="n">AvW</span>
                <span class="c1"># Update depth of water in current compartment</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">AvW</span>

            <span class="c1"># Update water content</span>
            <span class="n">NewCond_th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>

        <span class="c1"># Update surface evaporation layer water balance</span>
        <span class="n">NewCond_Wsurf</span> <span class="o">=</span> <span class="n">NewCond_Wsurf</span> <span class="o">-</span> <span class="n">EsAct</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NewCond_Wsurf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ExtractPotStg1</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">):</span>
            <span class="n">NewCond_Wsurf</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># If surface storage completely depleted, prepare stage 2</span>
        <span class="k">if</span> <span class="n">NewCond_Wsurf</span> <span class="o">&lt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="c1"># Get water contents (mm)</span>
            <span class="n">Wevap_Sat</span><span class="p">,</span> <span class="n">Wevap_Fc</span><span class="p">,</span> <span class="n">Wevap_Wp</span><span class="p">,</span> <span class="n">Wevap_Dry</span><span class="p">,</span> <span class="n">Wevap_Act</span> <span class="o">=</span> <span class="n">_evap_layer_water_content</span><span class="p">(</span>
                <span class="n">NewCond_th</span><span class="p">,</span>
                <span class="n">NewCond_EvapZ</span><span class="p">,</span>
                <span class="n">prof</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Proportional water storage for start of stage two evaporation</span>
            <span class="n">NewCond_Wstage2</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Wevap_Act</span> <span class="o">-</span> <span class="p">(</span><span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">Wevap_Sat</span> <span class="o">-</span> <span class="p">(</span><span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span><span class="p">)),</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">NewCond_Wstage2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">NewCond_Wstage2</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">## Stage 2 evaporation ##</span>
    <span class="c1"># Extract water</span>
    <span class="k">if</span> <span class="n">ToExtract</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Start stage 2</span>
        <span class="n">NewCond_Stage2</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Get sub-daily evaporative demand</span>
        <span class="n">Edt</span> <span class="o">=</span> <span class="n">ToExtract</span> <span class="o">/</span> <span class="n">ClockStruct_EvapTimeSteps</span>
        <span class="c1"># Loop sub-daily steps</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ClockStruct_EvapTimeSteps</span><span class="p">)):</span>
            <span class="c1"># Get current water storage (mm)</span>
            <span class="n">Wevap_Sat</span><span class="p">,</span> <span class="n">Wevap_Fc</span><span class="p">,</span> <span class="n">Wevap_Wp</span><span class="p">,</span> <span class="n">Wevap_Dry</span><span class="p">,</span> <span class="n">Wevap_Act</span> <span class="o">=</span> <span class="n">_evap_layer_water_content</span><span class="p">(</span>
                <span class="n">NewCond_th</span><span class="p">,</span>
                <span class="n">NewCond_EvapZ</span><span class="p">,</span>
                <span class="n">prof</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Get water storage (mm) at start of stage 2 evaporation</span>
            <span class="n">Wupper</span> <span class="o">=</span> <span class="n">NewCond_Wstage2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Wevap_Sat</span> <span class="o">-</span> <span class="p">(</span><span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span><span class="p">)</span>
            <span class="c1"># Get water storage (mm) when there is no evaporation</span>
            <span class="n">Wlower</span> <span class="o">=</span> <span class="n">Wevap_Dry</span>
            <span class="c1"># Get relative depletion of evaporation storage in stage 2</span>
            <span class="n">Wrel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wevap_Act</span> <span class="o">-</span> <span class="n">Wlower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Wupper</span> <span class="o">-</span> <span class="n">Wlower</span><span class="p">)</span>
            <span class="c1"># Check if need to expand evaporation layer</span>
            <span class="k">if</span> <span class="n">Soil_EvapZmax</span> <span class="o">&gt;</span> <span class="n">Soil_EvapZmin</span><span class="p">:</span>
                <span class="n">Wcheck</span> <span class="o">=</span> <span class="n">Soil_fWrelExp</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">Soil_EvapZmax</span> <span class="o">-</span> <span class="n">NewCond_EvapZ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Soil_EvapZmax</span> <span class="o">-</span> <span class="n">Soil_EvapZmin</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">Wrel</span> <span class="o">&lt;</span> <span class="n">Wcheck</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond_EvapZ</span> <span class="o">&lt;</span> <span class="n">Soil_EvapZmax</span><span class="p">):</span>
                    <span class="c1"># Expand evaporation layer by 1 mm</span>
                    <span class="n">NewCond_EvapZ</span> <span class="o">=</span> <span class="n">NewCond_EvapZ</span> <span class="o">+</span> <span class="mf">0.001</span>
                    <span class="c1"># Update water storage (mm) in evaporation layer</span>
                    <span class="n">Wevap_Sat</span><span class="p">,</span> <span class="n">Wevap_Fc</span><span class="p">,</span> <span class="n">Wevap_Wp</span><span class="p">,</span> <span class="n">Wevap_Dry</span><span class="p">,</span> <span class="n">Wevap_Act</span> <span class="o">=</span> <span class="n">_evap_layer_water_content</span><span class="p">(</span>
                        <span class="n">NewCond_th</span><span class="p">,</span>
                        <span class="n">NewCond_EvapZ</span><span class="p">,</span>
                        <span class="n">prof</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">Wupper</span> <span class="o">=</span> <span class="n">NewCond_Wstage2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Wevap_Sat</span> <span class="o">-</span> <span class="p">(</span><span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">Wevap_Fc</span> <span class="o">-</span> <span class="n">Soil_REW</span>
                    <span class="p">)</span>
                    <span class="n">Wlower</span> <span class="o">=</span> <span class="n">Wevap_Dry</span>
                    <span class="c1"># Update relative depletion of evaporation storage</span>
                    <span class="n">Wrel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wevap_Act</span> <span class="o">-</span> <span class="n">Wlower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Wupper</span> <span class="o">-</span> <span class="n">Wlower</span><span class="p">)</span>
                    <span class="n">Wcheck</span> <span class="o">=</span> <span class="n">Soil_fWrelExp</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">Soil_EvapZmax</span> <span class="o">-</span> <span class="n">NewCond_EvapZ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Soil_EvapZmax</span> <span class="o">-</span> <span class="n">Soil_EvapZmin</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Get stage 2 evaporation reduction coefficient</span>
            <span class="n">Kr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Soil_fevap</span> <span class="o">*</span> <span class="n">Wrel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Soil_fevap</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Kr</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">Kr</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Get water to extract (mm)</span>
            <span class="n">ToExtractStg2</span> <span class="o">=</span> <span class="n">Kr</span> <span class="o">*</span> <span class="n">Edt</span>

            <span class="c1"># Extract water from compartments</span>
            <span class="n">comp_sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&lt;</span> <span class="n">NewCond_EvapZ</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># prof = Soil_Profile</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">ToExtractStg2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span> <span class="o">&lt;</span> <span class="n">comp_sto</span><span class="p">):</span>
                <span class="c1"># Increment compartment counter</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># Specify layer number</span>
                <span class="c1"># Determine proportion of compartment in evaporation layer</span>
                <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">NewCond_EvapZ</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">prof</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">NewCond_EvapZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Water storage (mm) at air dry</span>
                <span class="n">Wdry</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_dry</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
                <span class="c1"># Available water (mm)</span>
                <span class="n">W</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">NewCond_th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
                <span class="c1"># Water available in compartment for extraction (mm)</span>
                <span class="n">AvW</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wdry</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
                <span class="k">if</span> <span class="n">AvW</span> <span class="o">&gt;=</span> <span class="n">ToExtractStg2</span><span class="p">:</span>
                    <span class="c1"># Update actual evaporation</span>
                    <span class="n">EsAct</span> <span class="o">=</span> <span class="n">EsAct</span> <span class="o">+</span> <span class="n">ToExtractStg2</span>
                    <span class="c1"># Update depth of water in current compartment</span>
                    <span class="n">W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">ToExtractStg2</span>
                    <span class="c1"># Update total water to be extracted</span>
                    <span class="n">ToExtract</span> <span class="o">=</span> <span class="n">ToExtract</span> <span class="o">-</span> <span class="n">ToExtractStg2</span>
                    <span class="c1"># Update water to be extracted from surface layer (stage 1)</span>
                    <span class="n">ToExtractStg2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Update actual evaporation</span>
                    <span class="n">EsAct</span> <span class="o">=</span> <span class="n">EsAct</span> <span class="o">+</span> <span class="n">AvW</span>
                    <span class="c1"># Update depth of water in current compartment</span>
                    <span class="n">W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">AvW</span>
                    <span class="c1"># Update water to be extracted from surface layer (stage 1)</span>
                    <span class="n">ToExtractStg2</span> <span class="o">=</span> <span class="n">ToExtractStg2</span> <span class="o">-</span> <span class="n">AvW</span>
                    <span class="c1"># Update total water to be extracted</span>
                    <span class="n">ToExtract</span> <span class="o">=</span> <span class="n">ToExtract</span> <span class="o">-</span> <span class="n">AvW</span>

                <span class="c1"># Update water content</span>
                <span class="n">NewCond_th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>

    <span class="c1">## Store potential evaporation for irrigation calculations on next day ##</span>
    <span class="n">NewCond_Epot</span> <span class="o">=</span> <span class="n">EsPot</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">NewCond_Epot</span><span class="p">,</span>
        <span class="n">NewCond_th</span><span class="p">,</span>
        <span class="n">NewCond_Stage2</span><span class="p">,</span>
        <span class="n">NewCond_Wstage2</span><span class="p">,</span>
        <span class="n">NewCond_Wsurf</span><span class="p">,</span>
        <span class="n">NewCond_SurfaceStorage</span><span class="p">,</span>
        <span class="n">NewCond_EvapZ</span><span class="p">,</span>
        <span class="n">EsAct</span><span class="p">,</span>
        <span class="n">EsPot</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.temperature_stress" class="doc doc-heading">
<code class="highlight language-python"><span class="n">temperature_stress</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">,</span> <span class="n">Tmin</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to get irrigation depth for current day</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=23" target="_blank">Reference Manual: temperature stress</a> (pg. 14)</p>
<p><em>Arguments:</em></p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object containing Crop paramaters</p>
<p><code>Tmax</code>: <code>float</code> : max tempatature on current day (celcius)</p>
<p><code>Tmin</code>: <code>float</code> : min tempature on current day (celcius)</p>
<p><em>Returns:</em></p>
<p><code>Kst</code>: <code>KstClass</code> : Kst object containing tempature stress paramators</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_temperature_stress&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">CropStructNT_type_sig</span><span class="p">,</span><span class="n">f8</span><span class="p">,</span><span class="n">f8</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">temperature_stress</span><span class="p">(</span><span class="n">Crop</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">,</span> <span class="n">Tmin</span><span class="p">):</span>
    <span class="c1"># Function to calculate temperature stress coefficients</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to get irrigation depth for current day</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=23&quot; target=&quot;_blank&quot;&gt;Reference Manual: temperature stress&lt;/a&gt; (pg. 14)</span>



<span class="sd">    *Arguments:*</span>



<span class="sd">    `Crop`: `CropClass` : Crop object containing Crop paramaters</span>

<span class="sd">    `Tmax`: `float` : max tempatature on current day (celcius)</span>

<span class="sd">    `Tmin`: `float` : min tempature on current day (celcius)</span>


<span class="sd">    *Returns:*</span>


<span class="sd">    `Kst`: `KstClass` : Kst object containing tempature stress paramators</span>







<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Calculate temperature stress coefficients affecting crop pollination ##</span>
    <span class="c1"># Get parameters for logistic curve</span>
    <span class="n">KsPol_up</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">KsPol_lo</span> <span class="o">=</span> <span class="mf">0.001</span>

    <span class="c1"># Kst = KstClass()</span>

    <span class="c1"># Calculate effects of heat stress on pollination</span>
    <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">PolHeatStress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># No heat stress effects on pollination</span>
        <span class="n">Kst_PolH</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">PolHeatStress</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Pollination affected by heat stress</span>
        <span class="k">if</span> <span class="n">Tmax</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Tmax_lo</span><span class="p">:</span>
            <span class="n">Kst_PolH</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">Tmax</span> <span class="o">&gt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Tmax_up</span><span class="p">:</span>
            <span class="n">Kst_PolH</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Trel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tmax</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Tmax_lo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Tmax_up</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Tmax_lo</span><span class="p">)</span>
            <span class="n">Kst_PolH</span> <span class="o">=</span> <span class="p">(</span><span class="n">KsPol_up</span> <span class="o">*</span> <span class="n">KsPol_lo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">KsPol_lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">KsPol_up</span> <span class="o">-</span> <span class="n">KsPol_lo</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Crop</span><span class="o">.</span><span class="n">fshape_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Trel</span><span class="p">))</span>
            <span class="p">)</span>

    <span class="c1"># Calculate effects of cold stress on pollination</span>
    <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">PolColdStress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># No cold stress effects on pollination</span>
        <span class="n">Kst_PolC</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">PolColdStress</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Pollination affected by cold stress</span>
        <span class="k">if</span> <span class="n">Tmin</span> <span class="o">&gt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Tmin_up</span><span class="p">:</span>
            <span class="n">Kst_PolC</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">Tmin</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Tmin_lo</span><span class="p">:</span>
            <span class="n">Kst_PolC</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Trel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Tmin_up</span> <span class="o">-</span> <span class="n">Tmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Tmin_up</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Tmin_lo</span><span class="p">)</span>
            <span class="n">Kst_PolC</span> <span class="o">=</span> <span class="p">(</span><span class="n">KsPol_up</span> <span class="o">*</span> <span class="n">KsPol_lo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">KsPol_lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">KsPol_up</span> <span class="o">-</span> <span class="n">KsPol_lo</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Crop</span><span class="o">.</span><span class="n">fshape_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Trel</span><span class="p">))</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Kst_PolH</span><span class="p">,</span><span class="n">Kst_PolC</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.transpiration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">transpiration</span><span class="p">(</span><span class="n">Soil_Profile</span><span class="p">,</span> <span class="n">Soil_nComp</span><span class="p">,</span> <span class="n">Soil_zTop</span><span class="p">,</span> <span class="n">Crop</span><span class="p">,</span> <span class="n">IrrMngt_IrrMethod</span><span class="p">,</span> <span class="n">IrrMngt_NetIrrSMT</span><span class="p">,</span> <span class="n">InitCond</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">CO2</span><span class="p">,</span> <span class="n">GrowingSeason</span><span class="p">,</span> <span class="n">GDD</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate crop transpiration on current day</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=91" target="_blank">Reference Manual: transpiration equations</a> (pg. 82-91)</p>
<p><em>Arguments:</em></p>
<p><code>Soil</code>: <code>SoilClass</code> : Soil object</p>
<p><code>Crop</code>: <code>CropClass</code> : Crop object</p>
<p><code>IrrMngt</code>: <code>IrrMngt</code>: object containing irrigation management params</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object</p>
<p><code>Et0</code>: <code>float</code> : reference evapotranspiration</p>
<p><code>CO2</code>: <code>CO2class</code> : CO2</p>
<p><code>GDD</code>: <code>float</code> : Growing Degree Days</p>
<p><code>GrowingSeason</code>:: <code>bool</code> : is it currently within the growing season (True, Flase)</p>
<p><em>Returns:</em></p>
<p><code>TrAct</code>: <code>float</code> : Actual Transpiration on current day</p>
<p><code>TrPot_NS</code>: <code>float</code> : Potential Transpiration on current day with no water stress</p>
<p><code>TrPot0</code>: <code>float</code> : Potential Transpiration on current day</p>
<p><code>NewCond</code>: <code>InitCondClass</code> : updated InitCond object</p>
<p><code>IrrNet</code>: <code>float</code> : Net Irrigation (if required)</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">transpiration</span><span class="p">(</span>
    <span class="n">Soil_Profile</span><span class="p">,</span>
    <span class="n">Soil_nComp</span><span class="p">,</span>
    <span class="n">Soil_zTop</span><span class="p">,</span>
    <span class="n">Crop</span><span class="p">,</span>
    <span class="n">IrrMngt_IrrMethod</span><span class="p">,</span>
    <span class="n">IrrMngt_NetIrrSMT</span><span class="p">,</span>
    <span class="n">InitCond</span><span class="p">,</span>
    <span class="n">Et0</span><span class="p">,</span>
    <span class="n">CO2</span><span class="p">,</span>
    <span class="n">GrowingSeason</span><span class="p">,</span>
    <span class="n">GDD</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate crop transpiration on current day</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=91&quot; target=&quot;_blank&quot;&gt;Reference Manual: transpiration equations&lt;/a&gt; (pg. 82-91)</span>



<span class="sd">    *Arguments:*</span>


<span class="sd">    `Soil`: `SoilClass` : Soil object</span>

<span class="sd">    `Crop`: `CropClass` : Crop object</span>

<span class="sd">    `IrrMngt`: `IrrMngt`: object containing irrigation management params</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object</span>

<span class="sd">    `Et0`: `float` : reference evapotranspiration</span>

<span class="sd">    `CO2`: `CO2class` : CO2</span>

<span class="sd">    `GDD`: `float` : Growing Degree Days</span>

<span class="sd">    `GrowingSeason`:: `bool` : is it currently within the growing season (True, Flase)</span>

<span class="sd">    *Returns:*</span>


<span class="sd">    `TrAct`: `float` : Actual Transpiration on current day</span>

<span class="sd">    `TrPot_NS`: `float` : Potential Transpiration on current day with no water stress</span>

<span class="sd">    `TrPot0`: `float` : Potential Transpiration on current day</span>

<span class="sd">    `NewCond`: `InitCondClass` : updated InitCond object</span>

<span class="sd">    `IrrNet`: `float` : Net Irrigation (if required)</span>







<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Store initial conditions ##</span>
    <span class="n">NewCond</span> <span class="o">=</span> <span class="n">InitCond</span>

    <span class="n">InitCond_th</span> <span class="o">=</span> <span class="n">InitCond</span><span class="o">.</span><span class="n">th</span>

    <span class="n">prof</span> <span class="o">=</span> <span class="n">Soil_Profile</span>

    <span class="c1">## Calculate transpiration (if in growing season) ##</span>
    <span class="k">if</span> <span class="n">GrowingSeason</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1">## Calculate potential transpiration ##</span>
        <span class="c1"># 1. No prior water stress</span>
        <span class="c1"># Update ageing days counter</span>
        <span class="n">DAPadj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DAP</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span>
        <span class="k">if</span> <span class="n">DAPadj</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">MaxCanopyCD</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">AgeDays_NS</span> <span class="o">=</span> <span class="n">DAPadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">MaxCanopyCD</span>

        <span class="c1"># Update crop coefficient for ageing of canopy</span>
        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AgeDays_NS</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">Kcb_NS</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Kcb</span> <span class="o">-</span> <span class="p">((</span><span class="n">NewCond</span><span class="o">.</span><span class="n">AgeDays_NS</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">fage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW_NS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kcb_NS</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Kcb</span>

        <span class="c1"># Update crop coefficient for CO2 concentration</span>
        <span class="n">CO2CurrentConc</span> <span class="o">=</span> <span class="n">CO2</span><span class="o">.</span><span class="n">CurrentConc</span>
        <span class="n">CO2RefConc</span> <span class="o">=</span> <span class="n">CO2</span><span class="o">.</span><span class="n">RefConc</span>
        <span class="k">if</span> <span class="n">CO2CurrentConc</span> <span class="o">&gt;</span> <span class="n">CO2RefConc</span><span class="p">:</span>
            <span class="n">Kcb_NS</span> <span class="o">=</span> <span class="n">Kcb_NS</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">((</span><span class="n">CO2CurrentConc</span> <span class="o">-</span> <span class="n">CO2RefConc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">550</span> <span class="o">-</span> <span class="n">CO2RefConc</span><span class="p">)))</span>

        <span class="c1"># Determine potential transpiration rate (no water stress)</span>
        <span class="n">TrPot_NS</span> <span class="o">=</span> <span class="n">Kcb_NS</span> <span class="o">*</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CCadj_NS</span><span class="p">)</span> <span class="o">*</span> <span class="n">Et0</span>

        <span class="c1"># Correct potential transpiration for dying green canopy effects</span>
        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">&lt;</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW_NS</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW_NS</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">):</span>
                <span class="n">TrPot_NS</span> <span class="o">=</span> <span class="n">TrPot_NS</span> <span class="o">*</span> <span class="p">((</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC_NS</span> <span class="o">/</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW_NS</span><span class="p">)</span> <span class="o">**</span> <span class="n">Crop</span><span class="o">.</span><span class="n">a_Tr</span><span class="p">)</span>

        <span class="c1"># 2. Potential prior water stress and/or delayed development</span>
        <span class="c1"># Update ageing days counter</span>
        <span class="n">DAPadj</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DAP</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DelayedCDs</span>
        <span class="k">if</span> <span class="n">DAPadj</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">MaxCanopyCD</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">AgeDays</span> <span class="o">=</span> <span class="n">DAPadj</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">MaxCanopyCD</span>

        <span class="c1"># Update crop coefficient for ageing of canopy</span>
        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AgeDays</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">Kcb</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Kcb</span> <span class="o">-</span> <span class="p">((</span><span class="n">NewCond</span><span class="o">.</span><span class="n">AgeDays</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">fage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kcb</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">Kcb</span>

        <span class="c1"># Update crop coefficient for CO2 concentration</span>
        <span class="k">if</span> <span class="n">CO2CurrentConc</span> <span class="o">&gt;</span> <span class="n">CO2RefConc</span><span class="p">:</span>
            <span class="n">Kcb</span> <span class="o">=</span> <span class="n">Kcb</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">((</span><span class="n">CO2CurrentConc</span> <span class="o">-</span> <span class="n">CO2RefConc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">550</span> <span class="o">-</span> <span class="n">CO2RefConc</span><span class="p">)))</span>

        <span class="c1"># Determine potential transpiration rate</span>
        <span class="n">TrPot0</span> <span class="o">=</span> <span class="n">Kcb</span> <span class="o">*</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CCadj</span><span class="p">)</span> <span class="o">*</span> <span class="n">Et0</span>
        <span class="c1"># Correct potential transpiration for dying green canopy effects</span>
        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&lt;</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">):</span>
                <span class="n">TrPot0</span> <span class="o">=</span> <span class="n">TrPot0</span> <span class="o">*</span> <span class="p">((</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">/</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCxW</span><span class="p">)</span> <span class="o">**</span> <span class="n">Crop</span><span class="o">.</span><span class="n">a_Tr</span><span class="p">)</span>

        <span class="c1"># 3. Adjust potential transpiration for cold stress effects</span>
        <span class="c1"># Check if cold stress occurs on current day</span>
        <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">TrColdStress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Cold temperature stress does not affect transpiration</span>
            <span class="n">KsCold</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">Crop</span><span class="o">.</span><span class="n">TrColdStress</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Transpiration can be affected by cold temperature stress</span>
            <span class="k">if</span> <span class="n">GDD</span> <span class="o">&gt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">GDD_up</span><span class="p">:</span>
                <span class="c1"># No cold temperature stress</span>
                <span class="n">KsCold</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">GDD</span> <span class="o">&lt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">GDD_lo</span><span class="p">:</span>
                <span class="c1"># Transpiration fully inhibited by cold temperature stress</span>
                <span class="n">KsCold</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Transpiration partially inhibited by cold temperature stress</span>
                <span class="c1"># Get parameters for logistic curve</span>
                <span class="n">KsTr_up</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">KsTr_lo</span> <span class="o">=</span> <span class="mf">0.02</span>
                <span class="n">fshapeb</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(((</span><span class="n">KsTr_lo</span> <span class="o">*</span> <span class="n">KsTr_up</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="n">KsTr_lo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.98</span> <span class="o">*</span> <span class="p">(</span><span class="n">KsTr_up</span> <span class="o">-</span> <span class="n">KsTr_lo</span><span class="p">)))</span>
                <span class="p">)</span>
                <span class="c1"># Calculate cold stress level</span>
                <span class="n">GDDrel</span> <span class="o">=</span> <span class="p">(</span><span class="n">GDD</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">GDD_lo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">GDD_up</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">GDD_lo</span><span class="p">)</span>
                <span class="n">KsCold</span> <span class="o">=</span> <span class="p">(</span><span class="n">KsTr_up</span> <span class="o">*</span> <span class="n">KsTr_lo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">KsTr_lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">KsTr_up</span> <span class="o">-</span> <span class="n">KsTr_lo</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fshapeb</span> <span class="o">*</span> <span class="n">GDDrel</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">KsCold</span> <span class="o">=</span> <span class="n">KsCold</span> <span class="o">-</span> <span class="n">KsTr_lo</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">GDDrel</span><span class="p">)</span>

        <span class="c1"># Correct potential transpiration rate (mm/day)</span>
        <span class="n">TrPot0</span> <span class="o">=</span> <span class="n">TrPot0</span> <span class="o">*</span> <span class="n">KsCold</span>
        <span class="n">TrPot_NS</span> <span class="o">=</span> <span class="n">TrPot_NS</span> <span class="o">*</span> <span class="n">KsCold</span>

        <span class="c1"># print(TrPot0,NewCond.DAP)</span>

        <span class="c1">## Calculate surface layer transpiration ##</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">SurfaceStorage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">DaySubmerged</span> <span class="o">&lt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span><span class="p">):</span>

            <span class="c1"># Update submergence days counter</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">DaySubmerged</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DaySubmerged</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># Update anerobic conditions counter for each compartment</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Soil_nComp</span><span class="p">)):</span>
                <span class="c1"># Increment aeration days counter for compartment ii</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span><span class="p">:</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span>

            <span class="c1"># Reduce actual transpiration that is possible to account for</span>
            <span class="c1"># aeration stress due to extended submergence</span>
            <span class="n">fSub</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">DaySubmerged</span> <span class="o">/</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">SurfaceStorage</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fSub</span> <span class="o">*</span> <span class="n">TrPot0</span><span class="p">):</span>
                <span class="c1"># Transpiration occurs from surface storage</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">SurfaceStorage</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">SurfaceStorage</span> <span class="o">-</span> <span class="p">(</span><span class="n">fSub</span> <span class="o">*</span> <span class="n">TrPot0</span><span class="p">)</span>
                <span class="n">TrAct0</span> <span class="o">=</span> <span class="n">fSub</span> <span class="o">*</span> <span class="n">TrPot0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No transpiration from surface storage</span>
                <span class="n">TrAct0</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">TrAct0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fSub</span> <span class="o">*</span> <span class="n">TrPot0</span><span class="p">):</span>
                <span class="c1"># More water can be extracted from soil profile for transpiration</span>
                <span class="n">TrPot</span> <span class="o">=</span> <span class="p">(</span><span class="n">fSub</span> <span class="o">*</span> <span class="n">TrPot0</span><span class="p">)</span> <span class="o">-</span> <span class="n">TrAct0</span>
                <span class="c1"># print(&#39;now&#39;)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No more transpiration possible on current day</span>
                <span class="n">TrPot</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># print(&#39;here&#39;)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># No surface transpiration occurs</span>
            <span class="n">TrPot</span> <span class="o">=</span> <span class="n">TrPot0</span>
            <span class="n">TrAct0</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># print(TrPot,NewCond.DAP)</span>

        <span class="c1">## Update potential root zone transpiration for water stress ##</span>
        <span class="c1"># Determine root zone and top soil depletion, and root zone water</span>
        <span class="c1"># content</span>

        <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAWClass</span><span class="p">()</span>
        <span class="n">Dr</span> <span class="o">=</span> <span class="n">DrClass</span><span class="p">()</span>
        <span class="n">thRZ</span> <span class="o">=</span> <span class="n">thRZClass</span><span class="p">()</span>
        <span class="p">(</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span>
            <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span>
            <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span>
            <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span>
            <span class="n">thRZ</span><span class="o">.</span><span class="n">Act</span><span class="p">,</span>
            <span class="n">thRZ</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
            <span class="n">thRZ</span><span class="o">.</span><span class="n">FC</span><span class="p">,</span>
            <span class="n">thRZ</span><span class="o">.</span><span class="n">WP</span><span class="p">,</span>
            <span class="n">thRZ</span><span class="o">.</span><span class="n">Dry</span><span class="p">,</span>
            <span class="n">thRZ</span><span class="o">.</span><span class="n">Aer</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_root_zone_water</span><span class="p">(</span>
            <span class="n">prof</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">Zroot</span><span class="p">),</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">,</span>
            <span class="n">Soil_zTop</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">),</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">Aer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">class_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">thRZ</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">key</span><span class="p">)}</span>
        <span class="n">thRZ</span> <span class="o">=</span> <span class="n">thRZNT</span><span class="p">(</span><span class="o">**</span><span class="n">class_args</span><span class="p">)</span>

        <span class="c1"># _,Dr,TAW,thRZ = root_zone_water(Soil_Profile,float(NewCond.Zroot),NewCond.th,Soil_zTop,float(Crop.Zmin),Crop.Aer)</span>
        <span class="c1"># Check whether to use root zone or top soil depletions for calculating</span>
        <span class="c1"># water stress</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span> <span class="o">/</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span> <span class="o">/</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span><span class="p">):</span>
            <span class="c1"># Root zone is wetter than top soil, so use root zone value</span>
            <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span>
            <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Top soil is wetter than root zone, so use top soil values</span>
            <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span>
            <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span>

        <span class="c1"># Calculate water stress coefficients</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">Ksw</span> <span class="o">=</span> <span class="n">KswClass</span><span class="p">()</span>
        <span class="n">Ksw</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sto</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Sen</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">Pol</span><span class="p">,</span> <span class="n">Ksw</span><span class="o">.</span><span class="n">StoLin</span> <span class="o">=</span> <span class="n">_water_stress</span><span class="p">(</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">p_lo</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">ETadj</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">,</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">tEarlySen</span><span class="p">,</span>
            <span class="n">Dr</span><span class="p">,</span>
            <span class="n">TAW</span><span class="p">,</span>
            <span class="n">Et0</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Ksw = water_stress(Crop, NewCond, Dr, TAW, Et0, beta)</span>

        <span class="c1"># Calculate aeration stress coefficients</span>
        <span class="n">Ksa_Aer</span><span class="p">,</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDays</span> <span class="o">=</span> <span class="n">_aeration_stress</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">AerDays</span><span class="p">,</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span><span class="p">,</span> <span class="n">thRZ</span><span class="p">)</span>
        <span class="c1"># Maximum stress effect</span>
        <span class="n">Ks</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Ksw</span><span class="o">.</span><span class="n">StoLin</span><span class="p">,</span> <span class="n">Ksa_Aer</span><span class="p">)</span>
        <span class="c1"># Update potential transpiration in root zone</span>
        <span class="k">if</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># No adjustment to TrPot for water stress when in net irrigation mode</span>
            <span class="n">TrPot</span> <span class="o">=</span> <span class="n">TrPot</span> <span class="o">*</span> <span class="n">Ks</span>

        <span class="c1">## Determine compartments covered by root zone ##</span>
        <span class="c1"># Compartments covered by the root zone</span>
        <span class="n">rootdepth</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">Zroot</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">comp_sto</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Soil_Profile</span><span class="o">.</span><span class="n">dzsum</span> <span class="o">&lt;</span> <span class="n">rootdepth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Soil_nComp</span><span class="p">))</span>
        <span class="n">RootFact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Soil_nComp</span><span class="p">))</span>
        <span class="c1"># Determine fraction of each compartment covered by root zone</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Soil_Profile</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rootdepth</span><span class="p">:</span>
                <span class="n">RootFact</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">Soil_Profile</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">rootdepth</span><span class="p">)</span> <span class="o">/</span> <span class="n">Soil_Profile</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">RootFact</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">## Determine maximum sink term for each compartment ##</span>
        <span class="n">SxComp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Soil_nComp</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Net irrigation mode</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">):</span>
                <span class="n">SxComp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">SxTop</span> <span class="o">+</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxBot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Maximum sink term declines linearly with depth</span>
            <span class="n">SxCompBot</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxTop</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">):</span>
                <span class="n">SxCompTop</span> <span class="o">=</span> <span class="n">SxCompBot</span>
                <span class="k">if</span> <span class="n">Soil_Profile</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rootdepth</span><span class="p">:</span>
                    <span class="n">SxCompBot</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxBot</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">rCor</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">SxTop</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxBot</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">rCor</span><span class="p">)</span>
                        <span class="o">*</span> <span class="p">((</span><span class="n">rootdepth</span> <span class="o">-</span> <span class="n">Soil_Profile</span><span class="o">.</span><span class="n">dzsum</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">/</span> <span class="n">rootdepth</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">SxCompBot</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">SxBot</span> <span class="o">*</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">rCor</span>

                <span class="n">SxComp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SxCompTop</span> <span class="o">+</span> <span class="n">SxCompBot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># print(TrPot,NewCond.DAP)</span>
        <span class="c1">## Extract water ##</span>
        <span class="n">ToExtract</span> <span class="o">=</span> <span class="n">TrPot</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">TrAct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">ToExtract</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp</span> <span class="o">&lt;</span> <span class="n">comp_sto</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Increment compartment</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># Specify layer number</span>

            <span class="c1"># Determine TAW (m3/m3) for compartment</span>
            <span class="n">thTAW</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">Crop</span><span class="o">.</span><span class="n">ETadj</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Adjust stomatal stress threshold for Et0 on current day</span>
                <span class="n">p_up_sto</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.04</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">Et0</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="c1"># Determine critical water content at which stomatal closure will</span>
            <span class="c1"># occur in compartment</span>
            <span class="n">thCrit</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">thTAW</span> <span class="o">*</span> <span class="n">p_up_sto</span><span class="p">)</span>

            <span class="c1"># Check for soil water stress</span>
            <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">thCrit</span><span class="p">:</span>
                <span class="c1"># No water stress effects on transpiration</span>
                <span class="n">KsComp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">comp</span><span class="p">]:</span>
                <span class="c1"># Transpiration from compartment is affected by water stress</span>
                <span class="n">Wrel</span> <span class="o">=</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
                <span class="n">pRel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wrel</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">p_lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Crop</span><span class="o">.</span><span class="n">p_up</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pRel</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">KsComp</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">pRel</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">KsComp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">KsComp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pRel</span> <span class="o">*</span> <span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">fshape_w</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">KsComp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">KsComp</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">KsComp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">KsComp</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No transpiration is possible from compartment as water</span>
                <span class="c1"># content does not exceed wilting point</span>
                <span class="n">KsComp</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Adjust compartment stress factor for aeration stress</span>
            <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">DaySubmerged</span> <span class="o">&gt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span><span class="p">:</span>
                <span class="c1"># Full aeration stress - no transpiration possible from</span>
                <span class="c1"># compartment</span>
                <span class="n">AerComp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Aer</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)):</span>
                <span class="c1"># Increment aeration stress days counter</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span><span class="p">:</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">Crop</span><span class="o">.</span><span class="n">LagAer</span>
                    <span class="n">fAer</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fAer</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Calculate aeration stress factor</span>
                <span class="n">AerComp</span> <span class="o">=</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_s</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Aer</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">AerComp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">AerComp</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">AerComp</span> <span class="o">=</span> <span class="p">(</span><span class="n">fAer</span> <span class="o">+</span> <span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">AerComp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">fAer</span> <span class="o">+</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No aeration stress as number of submerged days does not</span>
                <span class="c1"># exceed threshold for initiation of aeration stress</span>
                <span class="n">AerComp</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">AerDaysComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Extract water</span>
            <span class="n">ThToExtract</span> <span class="o">=</span> <span class="p">(</span><span class="n">ToExtract</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">Soil_Profile</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># Don&#39;t reduce compartment sink for stomatal water stress if in</span>
                <span class="c1"># net irrigation mode. Stress only occurs due to deficient</span>
                <span class="c1"># aeration conditions</span>
                <span class="n">Sink</span> <span class="o">=</span> <span class="n">AerComp</span> <span class="o">*</span> <span class="n">SxComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">*</span> <span class="n">RootFact</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reduce compartment sink for greatest of stomatal and aeration</span>
                <span class="c1"># stress</span>
                <span class="k">if</span> <span class="n">KsComp</span> <span class="o">==</span> <span class="n">AerComp</span><span class="p">:</span>
                    <span class="n">Sink</span> <span class="o">=</span> <span class="n">KsComp</span> <span class="o">*</span> <span class="n">SxComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">*</span> <span class="n">RootFact</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Sink</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">KsComp</span><span class="p">,</span> <span class="n">AerComp</span><span class="p">)</span> <span class="o">*</span> <span class="n">SxComp</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">*</span> <span class="n">RootFact</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>

            <span class="c1"># Limit extraction to demand</span>
            <span class="k">if</span> <span class="n">ThToExtract</span> <span class="o">&lt;</span> <span class="n">Sink</span><span class="p">:</span>
                <span class="n">Sink</span> <span class="o">=</span> <span class="n">ThToExtract</span>

            <span class="c1"># Limit extraction to avoid compartment water content dropping</span>
            <span class="c1"># below air dry</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">InitCond_th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">Sink</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_dry</span><span class="p">[</span><span class="n">comp</span><span class="p">]:</span>
                <span class="n">Sink</span> <span class="o">=</span> <span class="n">InitCond_th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_dry</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">Sink</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Sink</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Update water content in compartment</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">InitCond_th</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">-</span> <span class="n">Sink</span>
            <span class="c1"># Update amount of water to extract</span>
            <span class="n">ToExtract</span> <span class="o">=</span> <span class="n">ToExtract</span> <span class="o">-</span> <span class="p">(</span><span class="n">Sink</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
            <span class="c1"># Update actual transpiration</span>
            <span class="n">TrAct</span> <span class="o">=</span> <span class="n">TrAct</span> <span class="o">+</span> <span class="p">(</span><span class="n">Sink</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>

        <span class="c1">## Add net irrigation water requirement (if this mode is specified) ##</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">TrPot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Initialise net irrigation counter</span>
            <span class="n">IrrNet</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Get root zone water content</span>

            <span class="n">TAW</span> <span class="o">=</span> <span class="n">TAWClass</span><span class="p">()</span>
            <span class="n">Dr</span> <span class="o">=</span> <span class="n">DrClass</span><span class="p">()</span>
            <span class="n">thRZ</span> <span class="o">=</span> <span class="n">thRZClass</span><span class="p">()</span>
            <span class="p">(</span>
                <span class="n">_</span><span class="p">,</span>
                <span class="n">Dr</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span>
                <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span>
                <span class="n">TAW</span><span class="o">.</span><span class="n">Zt</span><span class="p">,</span>
                <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span>
                <span class="n">thRZ</span><span class="o">.</span><span class="n">Act</span><span class="p">,</span>
                <span class="n">thRZ</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                <span class="n">thRZ</span><span class="o">.</span><span class="n">FC</span><span class="p">,</span>
                <span class="n">thRZ</span><span class="o">.</span><span class="n">WP</span><span class="p">,</span>
                <span class="n">thRZ</span><span class="o">.</span><span class="n">Dry</span><span class="p">,</span>
                <span class="n">thRZ</span><span class="o">.</span><span class="n">Aer</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">_root_zone_water</span><span class="p">(</span>
                <span class="n">prof</span><span class="p">,</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">NewCond</span><span class="o">.</span><span class="n">Zroot</span><span class="p">),</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">,</span>
                <span class="n">Soil_zTop</span><span class="p">,</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">Crop</span><span class="o">.</span><span class="n">Zmin</span><span class="p">),</span>
                <span class="n">Crop</span><span class="o">.</span><span class="n">Aer</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># _,_Dr,_TAW,thRZ = root_zone_water(Soil_Profile,float(NewCond.Zroot),NewCond.th,Soil_zTop,float(Crop.Zmin),Crop.Aer)</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">Depletion</span> <span class="o">=</span> <span class="n">Dr</span><span class="o">.</span><span class="n">Rz</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">TAW</span> <span class="o">=</span> <span class="n">TAW</span><span class="o">.</span><span class="n">Rz</span>
            <span class="c1"># Determine critical water content for net irrigation</span>
            <span class="n">thCrit</span> <span class="o">=</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">WP</span> <span class="o">+</span> <span class="p">((</span><span class="n">IrrMngt_NetIrrSMT</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">thRZ</span><span class="o">.</span><span class="n">FC</span> <span class="o">-</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">WP</span><span class="p">))</span>
            <span class="c1"># Check if root zone water content is below net irrigation trigger</span>
            <span class="k">if</span> <span class="n">thRZ</span><span class="o">.</span><span class="n">Act</span> <span class="o">&lt;</span> <span class="n">thCrit</span><span class="p">:</span>
                <span class="c1"># Initialise layer counter</span>
                <span class="n">prelayer</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_sto</span><span class="p">):</span>
                    <span class="c1"># Get soil layer</span>
                    <span class="n">layeri</span> <span class="o">=</span> <span class="n">Soil_Profile</span><span class="o">.</span><span class="n">Layer</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">layeri</span> <span class="o">&gt;</span> <span class="n">prelayer</span><span class="p">:</span>
                        <span class="c1"># If in new layer, update critical water content for</span>
                        <span class="c1"># net irrigation</span>
                        <span class="n">thCrit</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">IrrMngt_NetIrrSMT</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">th_fc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">th_wp</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="c1"># Update layer counter</span>
                        <span class="n">prelayer</span> <span class="o">=</span> <span class="n">layeri</span>

                    <span class="c1"># Determine necessary change in water content in</span>
                    <span class="c1"># compartments to reach critical water content</span>
                    <span class="n">dWC</span> <span class="o">=</span> <span class="n">RootFact</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">thCrit</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="c1"># Update water content</span>
                    <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dWC</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">prof</span><span class="o">.</span><span class="n">dz</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                    <span class="c1"># Update net irrigation counter</span>
                    <span class="n">IrrNet</span> <span class="o">=</span> <span class="n">IrrNet</span> <span class="o">+</span> <span class="n">dWC</span>

            <span class="c1"># Update net irrigation counter for the growing season</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">IrrNetCum</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">IrrNetCum</span> <span class="o">+</span> <span class="n">IrrNet</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">IrrMngt_IrrMethod</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">TrPot</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># No net irrigation as potential transpiration is zero</span>
            <span class="n">IrrNet</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No net irrigation as not in net irrigation mode</span>
            <span class="n">IrrNet</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">IrrNetCum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## Add any surface transpiration to root zone total ##</span>
        <span class="n">TrAct</span> <span class="o">=</span> <span class="n">TrAct</span> <span class="o">+</span> <span class="n">TrAct0</span>

        <span class="c1">## Feedback with canopy cover development ##</span>
        <span class="c1"># If actual transpiration is zero then no canopy cover growth can occur</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">-</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCprev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.005</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">TrAct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">CC</span> <span class="o">=</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">CCprev</span>

        <span class="c1">## Update transpiration ratio ##</span>
        <span class="k">if</span> <span class="n">TrPot0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TrAct</span> <span class="o">&lt;</span> <span class="n">TrPot0</span><span class="p">:</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">TrRatio</span> <span class="o">=</span> <span class="n">TrAct</span> <span class="o">/</span> <span class="n">TrPot0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">NewCond</span><span class="o">.</span><span class="n">TrRatio</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">TrRatio</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">TrRatio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">TrRatio</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">NewCond</span><span class="o">.</span><span class="n">TrRatio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">NewCond</span><span class="o">.</span><span class="n">TrRatio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No transpiration if not in growing season</span>
        <span class="n">TrAct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">TrPot0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">TrPot_NS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># No irrigation if not in growing season</span>
        <span class="n">IrrNet</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NewCond</span><span class="o">.</span><span class="n">IrrNetCum</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">## Store potential transpiration for irrigation calculations on next day ##</span>
    <span class="n">NewCond</span><span class="o">.</span><span class="n">Tpot</span> <span class="o">=</span> <span class="n">TrPot0</span>

    <span class="k">return</span> <span class="n">TrAct</span><span class="p">,</span> <span class="n">TrPot_NS</span><span class="p">,</span> <span class="n">TrPot0</span><span class="p">,</span> <span class="n">NewCond</span><span class="p">,</span> <span class="n">IrrNet</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.update_CCx_CDC" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_CCx_CDC</span><span class="p">(</span><span class="n">CCprev</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to update CCx and CDC parameter valyes for rewatering in late season of an early declining canopy</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=36" target="_blank">Reference Manual: CC stress response</a> (pg. 27-33)</p>
<p><em>Arguments:</em></p>
<p><code>CCprev</code>: <code>float</code> : Canopy Cover at previous timestep.</p>
<p><code>CDC</code>: <code>float</code> : Canopy decline coefficient (fraction per GDD/calendar day)</p>
<p><code>CCx</code>: <code>float</code> : Maximum canopy cover (fraction of soil cover)</p>
<p><code>dt</code>: <code>float</code> : Time delta of canopy growth (1 calander day or ... GDD)</p>
<p><em>Returns:</em></p>
<p><code>CCxAdj</code>: <code>float</code> : updated CCxAdj</p>
<p><code>CDCadj</code>: <code>float</code> : updated CDCadj</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_update_CCx_CDC&quot;</span><span class="p">,</span> <span class="s2">&quot;(f8,f8,f8,f8)&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_CCx_CDC</span><span class="p">(</span><span class="n">CCprev</span><span class="p">,</span> <span class="n">CDC</span><span class="p">,</span> <span class="n">CCx</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to update CCx and CDC parameter valyes for rewatering in late season of an early declining canopy</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=36&quot; target=&quot;_blank&quot;&gt;Reference Manual: CC stress response&lt;/a&gt; (pg. 27-33)</span>


<span class="sd">    *Arguments:*</span>


<span class="sd">    `CCprev`: `float` : Canopy Cover at previous timestep.</span>

<span class="sd">    `CDC`: `float` : Canopy decline coefficient (fraction per GDD/calendar day)</span>

<span class="sd">    `CCx`: `float` : Maximum canopy cover (fraction of soil cover)</span>

<span class="sd">    `dt`: `float` : Time delta of canopy growth (1 calander day or ... GDD)</span>


<span class="sd">    *Returns:*</span>

<span class="sd">    `CCxAdj`: `float` : updated CCxAdj</span>

<span class="sd">    `CDCadj`: `float` : updated CDCadj</span>





<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Get adjusted CCx ##</span>
    <span class="n">CCXadj</span> <span class="o">=</span> <span class="n">CCprev</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="p">((</span><span class="n">CDC</span> <span class="o">*</span> <span class="mf">3.33</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CCx</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1">## Get adjusted CDC ##</span>
    <span class="n">CDCadj</span> <span class="o">=</span> <span class="n">CDC</span> <span class="o">*</span> <span class="p">((</span><span class="n">CCXadj</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CCx</span> <span class="o">+</span> <span class="mf">2.29</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">CCXadj</span><span class="p">,</span> <span class="n">CDCadj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="aquacrop.solution.water_stress" class="doc doc-heading">
<code class="highlight language-python"><span class="n">water_stress</span><span class="p">(</span><span class="n">Crop_p_up</span><span class="p">,</span> <span class="n">Crop_p_lo</span><span class="p">,</span> <span class="n">Crop_ETadj</span><span class="p">,</span> <span class="n">Crop_beta</span><span class="p">,</span> <span class="n">Crop_fshape_w</span><span class="p">,</span> <span class="n">InitCond_tEarlySen</span><span class="p">,</span> <span class="n">Dr</span><span class="p">,</span> <span class="n">TAW</span><span class="p">,</span> <span class="n">Et0</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Function to calculate water stress coefficients</p>
<p><a href="../pdfs/ac_ref_man_3.pdf#page=18" target="_blank">Reference Manual: water stress equations</a> (pg. 9-13)</p>
<p><em>Arguments:</em></p>
<p><code>Crop</code>: <code>CropClass</code> : Crop Object</p>
<p><code>InitCond</code>: <code>InitCondClass</code> : InitCond object</p>
<p><code>Dr</code>: <code>DrClass</code> : Depletion object (contains rootzone and top soil depletion totals)</p>
<p><code>TAW</code>: <code>TAWClass</code> : TAW object (contains rootzone and top soil total available water)</p>
<p><code>Et0</code>: <code>float</code> : Reference Evapotranspiration</p>
<p><code>beta</code>: <code>float</code> : Adjust senescence threshold if early sensescence is triggered</p>
<p><em>Returns:</em></p>
<p><code>Ksw</code>: <code>KswClass</code> : Ksw object containint water stress coefficients</p>

        <details class="quote">
          <summary>Source code in <code>aquacrop/solution.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@njit</span>
<span class="nd">@cc</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;_water_stress&quot;</span><span class="p">,</span> <span class="s2">&quot;(f8[:],f8[:],f8,f8,f8[:],f8,f8,f8,f8,f8)&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">water_stress</span><span class="p">(</span>
    <span class="n">Crop_p_up</span><span class="p">,</span>
    <span class="n">Crop_p_lo</span><span class="p">,</span>
    <span class="n">Crop_ETadj</span><span class="p">,</span>
    <span class="n">Crop_beta</span><span class="p">,</span>
    <span class="n">Crop_fshape_w</span><span class="p">,</span>
    <span class="n">InitCond_tEarlySen</span><span class="p">,</span>
    <span class="n">Dr</span><span class="p">,</span>
    <span class="n">TAW</span><span class="p">,</span>
    <span class="n">Et0</span><span class="p">,</span>
    <span class="n">beta</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate water stress coefficients</span>

<span class="sd">    &lt;a href=&quot;../pdfs/ac_ref_man_3.pdf#page=18&quot; target=&quot;_blank&quot;&gt;Reference Manual: water stress equations&lt;/a&gt; (pg. 9-13)</span>


<span class="sd">    *Arguments:*</span>


<span class="sd">    `Crop`: `CropClass` : Crop Object</span>

<span class="sd">    `InitCond`: `InitCondClass` : InitCond object</span>

<span class="sd">    `Dr`: `DrClass` : Depletion object (contains rootzone and top soil depletion totals)</span>

<span class="sd">    `TAW`: `TAWClass` : TAW object (contains rootzone and top soil total available water)</span>

<span class="sd">    `Et0`: `float` : Reference Evapotranspiration</span>

<span class="sd">    `beta`: `float` : Adjust senescence threshold if early sensescence is triggered</span>


<span class="sd">    *Returns:*</span>

<span class="sd">    `Ksw`: `KswClass` : Ksw object containint water stress coefficients</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Calculate relative root zone water depletion for each stress type ##</span>
    <span class="c1"># Number of stress variables</span>
    <span class="n">nstress</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Crop_p_up</span><span class="p">)</span>

    <span class="c1"># Store stress thresholds</span>
    <span class="n">p_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nstress</span><span class="p">)</span> <span class="o">*</span> <span class="n">Crop_p_up</span>
    <span class="n">p_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nstress</span><span class="p">)</span> <span class="o">*</span> <span class="n">Crop_p_lo</span>
    <span class="k">if</span> <span class="n">Crop_ETadj</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Adjust stress thresholds for Et0 on currentbeta day (don&#39;t do this for</span>
        <span class="c1"># pollination water stress coefficient)</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">p_up</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_up</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.04</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">Et0</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">p_up</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">p_lo</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_lo</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.04</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">Et0</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">p_lo</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>

    <span class="c1"># Adjust senescence threshold if early sensescence is triggered</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">beta</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">InitCond_tEarlySen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">p_up</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_up</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Crop_beta</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Limit values</span>
    <span class="n">p_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">p_up</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">p_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">p_lo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">p_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">p_up</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">p_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">p_lo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Calculate relative depletion</span>
    <span class="n">Drel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nstress</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nstress</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Dr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p_up</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">TAW</span><span class="p">):</span>
            <span class="c1"># No water stress</span>
            <span class="n">Drel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">Dr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">p_up</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">TAW</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Dr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">p_lo</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">TAW</span><span class="p">)):</span>
            <span class="c1"># Partial water stress</span>
            <span class="n">Drel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">p_lo</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Dr</span> <span class="o">/</span> <span class="n">TAW</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_lo</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_up</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">Dr</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">p_lo</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">TAW</span><span class="p">):</span>
            <span class="c1"># Full water stress</span>
            <span class="n">Drel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">## Calculate root zone water stress coefficients ##</span>
    <span class="n">Ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">Ks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Drel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">Crop_fshape_w</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Crop_fshape_w</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Ksw = KswClass()</span>

    <span class="c1"># Water stress coefficient for leaf expansion</span>
    <span class="n">Ksw_Exp</span> <span class="o">=</span> <span class="n">Ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Water stress coefficient for stomatal closure</span>
    <span class="n">Ksw_Sto</span> <span class="o">=</span> <span class="n">Ks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Water stress coefficient for senescence</span>
    <span class="n">Ksw_Sen</span> <span class="o">=</span> <span class="n">Ks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Water stress coefficient for pollination failure</span>
    <span class="n">Ksw_Pol</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Drel</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="c1"># Mean water stress coefficient for stomatal closure</span>
    <span class="n">Ksw_StoLin</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Drel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Ksw_Exp</span><span class="p">,</span> <span class="n">Ksw_Sto</span><span class="p">,</span> <span class="n">Ksw_Sen</span><span class="p">,</span> <span class="n">Ksw_Pol</span><span class="p">,</span> <span class="n">Ksw_StoLin</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../initialize/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Initialize" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Initialize
            </div>
          </div>
        </a>
      
      
        
        <a href="../timestep/" class="md-footer__link md-footer__link--next" aria-label="Next: Timestep" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Timestep
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.5a9542cf.min.js"></script>
      
    
  </body>
</html>